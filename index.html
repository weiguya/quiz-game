<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบคำถามรูปภาพ</title>
<script>
    // โหลด XLSX ในภายหลัง
    window.addEventListener('load', function() {
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
        document.body.appendChild(script);
    });
</script>
<style>
/* ปรับปรุง CSS เพื่อการโหลดที่นุ่มนวลขึ้น */
body {
  opacity: 1;
  transition: opacity 0.3s ease;
  background-color: #f9f9f9;
}

body.loading {
  opacity: 0;
}

/* Master Layout System */
.page-wrapper {
  min-height: 100vh;
  width: 100%;
  position: relative;
}

.content-area {
  width: 100%;
  max-width: var(--container-max-width);
  margin: 0 auto;
  padding: 0 var(--space-md);
  box-sizing: border-box;
}

.fade-in {
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Layout Utilities */
.center-content {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* สีหลักสำหรับธีมใหม่ */
:root {
  --primary-color: #1976d2; /* สีน้ำเงินหลัก */
  --primary-light: #4791db;
  --primary-dark: #115293;
  --secondary-color: #f5f5f5;
  --text-color: #333333;
  --success-color: #4caf50;
  --error-color: #f44336;
  --warning-color: #ff9800;
  --info-color: #2196f3;
  --border-color: #e0e0e0;
  --shadow-color: rgba(0, 0, 0, 0.1);
  --hover-color: #f0f7ff;
  --white: #ffffff;
  
  /* เพิ่มตรงนี้ - รวมใน :root เดียวกัน */
  --space-xs: 8px;
  --space-sm: 16px;
  --space-md: 24px;
  --space-lg: 32px;
  --space-xl: 48px;
  --container-max-width: 800px;
}

/* Reset Box Model */
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  font-family: 'Prompt', sans-serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background-color: #f9f9f9;
  line-height: 1.6;
  color: var(--text-color);
}

.main-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  width: 100%;
}

.container {
  background-color: var(--white);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 10px var(--shadow-color);
  margin: 0 auto 20px;
  width: 100%;
  max-width: 800px;
  box-sizing: border-box;
}

h1, h2 {
  color: var(--primary-dark);
  font-weight: 600;
}

h1 {
  position: relative;
  padding-bottom: 10px;
}

h1:after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 60px;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
  border-radius: 2px;
}

.choice-container input[type="text"] {
  flex-grow: 1;
  margin-right: 10px;
}

.choice-container input[type="radio"] {
  margin-right: 5px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.image-preview {
  max-width: 100%;
  max-height: 200px;
  margin-top: 10px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  display: none;
  box-shadow: 0 2px 5px var(--shadow-color);
}

button {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-right: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px var(--shadow-color);
  font-family: 'Prompt', sans-serif;
}

button:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(25, 118, 210, 0.2);
}

button.secondary {
  background: #e0e0e0;
  color: #424242;
}

button.secondary:hover {
  background: #d5d5d5;
}

button.delete {
  background: var(--error-color);
}

button.delete:hover {
  background: #d32f2f;
}

.saved-questions {
  margin-top: 30px;
}

.question-image {
  max-width: 100%;
  max-height: 200px;
  margin: 10px 0;
  border-radius: 4px;
  box-shadow: 0 2px 5px var(--shadow-color);
}

.choice {
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 4px;
  background-color: var(--secondary-color);
  transition: background-color 0.2s ease;
}

.choice.correct {
  background-color: rgba(76, 175, 80, 0.1);
  border-left: 3px solid var(--success-color);
}

.actions {
  margin-top: 20px;
  display: flex;
  gap: 10px;
}

.hidden {
  display: none;
}

.nav-tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border-color);
}

.nav-tab {
  padding: 12px 24px;
  cursor: pointer;
  border: 1px solid transparent;
  border-bottom: none;
  background-color: var(--secondary-color);
  margin-right: 5px;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  font-weight: 500;
  transition: all 0.3s ease;
  color: var(--text-color);
}

.nav-tab:hover {
  background-color: #e0e0e0;
}

.nav-tab.active {
  background-color: var(--white);
  border-color: var(--border-color);
  border-bottom-color: var(--white);
  margin-bottom: -1px;
  font-weight: 600;
  color: var(--primary-color);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* สไตล์สำหรับหน้าเล่นเกม */
.quiz-player {
  text-align: center;
}

.quiz-player h1, .quiz-player h2 {
  color: var(--primary-dark);
  margin-bottom: 16px;
}

.quiz-player p {
  font-size: 16px;
  color: var(--text-color);
  margin-bottom: 12px;
}

.option-btn {
  display: block;
  width: 100%;
  padding: 15px;
  margin: 12px 0;
  text-align: left;
  background-color: var(--white);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 500;
  color: var(--text-color);
  position: relative;
  overflow: hidden;
  font-family: 'Prompt', sans-serif;
  box-shadow: 0 1px 3px var(--shadow-color);
}

.option-btn:hover {
  background-color: var(--hover-color);
  border-color: var(--primary-light);
  box-shadow: 0 2px 5px rgba(25, 118, 210, 0.1);
}

.option-btn.selected {
  background-color: rgba(25, 118, 210, 0.05);
  border: 2px solid var(--primary-color);
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
  transform: translateY(-3px);
}

.option-btn.selected:after {
  content: "✓";
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  color: var(--primary-color);
  font-weight: bold;
}

.option-btn span {
  font-style: italic;
  font-weight: normal;
  color: var(--text-color);
  margin-left: 8px;
}

.result-correct {
  color: var(--success-color);
  font-weight: bold;
}

.result-incorrect {
  color: var(--error-color);
  font-weight: bold;
}

.quiz-progress {
    margin: 5px 0 20px;
    padding: 12px;
    background-color: rgba(25, 118, 210, 0.05);
    border-radius: 4px;
    font-size: 16px;
    font-weight: 500;
    color: var(--primary-dark);
    box-shadow: 0 2px 5px var(--shadow-color);
    text-align: center;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
}

.quiz-result {
  font-size: 18px;
  margin-top: 20px;
  padding: 20px;
  background-color: var(--white);
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-weight: 500;
  color: var(--text-color);
  box-shadow: 0 2px 8px var(--shadow-color);
}

.share-section {
  margin-top: 20px;
  padding: 15px;
  background-color: rgba(25, 118, 210, 0.05);
  border-radius: 8px;
  box-shadow: 0 2px 5px var(--shadow-color);
  transition: all 0.3s ease;
}

.share-section:hover {
  box-shadow: 0 5px 15px rgba(25, 118, 210, 0.1);
}

.share-link {
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  background-color: var(--white);
  border-radius: 4px;
  margin: 10px 0;
  word-break: break-all;
  box-shadow: inset 0 1px 3px var(--shadow-color);
}

/* หน้าเล่นเกม */
#quiz-question {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary-dark);
  line-height: 1.4;
  margin-bottom: 18px;
}

#quiz-choices {
  margin-top: 20px;
}

#quiz-screen {
  margin-bottom: 30px;
}

#question-review .question-card {
  text-align: left;
  margin-bottom: 20px;
  border: 1px solid var(--border-color);
  box-shadow: 0 1px 3px var(--shadow-color);
}

#question-review h3 {
  font-weight: 600;
  color: var(--primary-dark);
  margin-bottom: 12px;
}

#question-review .choices {
  margin-top: 15px;
}

#restart-quiz {
  margin-top: 20px;
  padding: 12px 24px;
  font-size: 16px;
}

#start-screen p {
  font-size: 18px;
  margin-bottom: 20px;
}

/* การแสดงผลเฉลย */
.answer-feedback {
  margin: 15px 0;
  padding: 12px 15px;
  border-radius: 4px;
  font-weight: 500;
  box-shadow: 0 2px 5px var(--shadow-color);
}

.answer-feedback.correct {
  background-color: rgba(76, 175, 80, 0.1);
  border-left: 4px solid var(--success-color);
  color: #2E7D32;
}

.answer-feedback.incorrect {
  background-color: rgba(244, 67, 54, 0.1);
  border-left: 4px solid var(--error-color);
  color: #C62828;
}

.choice-explanation {
  padding: 8px 12px;
  margin: 5px 0;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.choice-explanation:hover {
  transform: translateY(-2px);
}

.choice-explanation.user-selected {
  background-color: rgba(25, 118, 210, 0.05);
  border-left: 3px solid var(--primary-color);
}

.choice-explanation.correct-answer {
  background-color: rgba(76, 175, 80, 0.1);
  border-left: 3px solid var(--success-color);
}

/* ทบทวนคำถาม */
.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    background: #99CCFF;
    border-left: 5px solid #77AAFF;
    padding: 15px 20px;
    border-radius: 4px;
}

.review-header h3 {
    color: #333333;
    font-weight: 600;
}

.category-summary {
    background-color: #99CCFF;
    border-left: 5px solid #77AAFF;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.category-title {
    font-weight: 600;
    color: #333333;
    margin-right: 10px;
}

.category-path {
    color: #333333;
    font-weight: 500;
}

@media (max-width: 600px) {
    .category-summary {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .category-title {
        margin-bottom: 5px;
    }
}

.quiz-summary {
  display: flex;
  justify-content: space-around;
  margin: 20px 0;
  padding: 20px;
  background-color: rgba(25, 118, 210, 0.05);
  border-radius: 8px;
  box-shadow: 0 2px 8px var(--shadow-color);
}

.quiz-stat {
  text-align: center;
  transition: transform 0.3s ease;
}

.quiz-stat:hover {
  transform: translateY(-3px);
}

.quiz-stat-value {
  font-size: 28px;
  font-weight: bold;
  margin: 5px 0;
  color: var(--primary-color);
}

.stat-label {
  font-size: 14px;
  color: var(--text-color) !important;
  font-weight: 600;
}

.quiz-result span {
  font-size: 32px;
  font-weight: bold;
  color: var(--primary-color);
}

.result-container {
  max-width: 800px;
  margin: 0 auto;
  background-color: var(--white);
  border-radius: 8px;
  box-shadow: 0 6px 18px var(--shadow-color);
  overflow: hidden;
  transition: box-shadow 0.3s ease;
}

.result-container:hover {
  box-shadow: 0 8px 25px rgba(25, 118, 210, 0.15);
}

.result-header {
    background: #99CCFF;
    color: #333333;
    padding: 25px;
    text-align: center;
    position: relative;
    border-bottom: 1px solid var(--border-color);
}

.result-header h2 {
    margin: 0;
    font-size: 28px;
    color: #333333;  /* กำหนดสีตามที่ต้องการ */
    font-weight: 600;
}

.result-score-container {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

.result-score {
  background-color: var(--white);
  border-radius: 50%;
  width: 180px;
  height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 3px 10px var(--shadow-color);
  border: 3px solid var(--primary-color);
  position: relative;
  transition: all 0.3s ease;
}

.result-score:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(25, 118, 210, 0.15);
}

.score-display {
  display: flex;
  align-items: baseline;
  justify-content: center;
  font-weight: 700;
  color: var(--primary-color);
  line-height: 1;
}

.score-value {
  font-size: 54px;
  margin-right: 2px;
  color: var(--primary-dark);
  font-weight: 700;
}

.score-separator {
  font-size: 36px;
  margin: 0 2px;
  color: var(--text-color);
}

.score-max {
  font-size: 36px;
  color: var(--primary-color);
}

.score-percent {
    position: absolute;
    bottom: -15px;
    background-color: #99CCFF;
    color: #333333;
    font-weight: 600;
    padding: 6px 18px;
    box-shadow: 0 2px 5px var(--shadow-color);
    border-radius: 20px;
    transition: all 0.3s ease;
}

.score-percent:hover {
  transform: scale(1.05);
  box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
}

.quiz-stats {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  background-color: var(--secondary-color);
  border-top: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
}

.stat-item {
  text-align: center;
  padding: 0 15px;
  position: relative;
  transition: transform 0.3s ease;
}

.stat-item:hover {
  transform: translateY(-3px);
}

.stat-item:not(:last-child):after {
  content: '';
  position: absolute;
  right: 0;
  top: 20%;
  height: 60%;
  width: 1px;
  background-color: var(--border-color);
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--text-color);
  margin-bottom: 5px;
}

.correct-value {
  color: var(--success-color);
}

.incorrect-value {
  color: var(--error-color);
}

.question-review-list {
  padding: 0 20px 20px;
}

.question-review-item {
    background-color: var(--white);
    border-radius: 8px;
    box-shadow: 0 3px 8px var(--shadow-color);
    margin-bottom: 20px;
    padding: 20px;
    border-left: 3px solid var(--border-color);
    transition: all 0.3s ease;
}

.question-review-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(25, 118, 210, 0.1);
}

.question-review-item.correct {
  border-left-color: var(--success-color);
}

.question-review-item.incorrect {
  border-left-color: var(--error-color);
}

.question-status {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 10px;
}

.status-correct {
  background-color: rgba(76, 175, 80, 0.1);
  color: #2E7D32;
}

.status-incorrect {
  background-color: rgba(244, 67, 54, 0.1);
  color: #C62828;
}

.question-number {
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-align: center;
}

.question-text {
    font-size: 18px;
    margin-bottom: 15px;
    line-height: 1.5;
    color: var(--primary-dark);
    font-weight: 500;
    text-align: center;
}

.choice-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
}

.choice-item {
    padding: 12px 15px;
    border-radius: 4px;
    position: relative;
    background-color: var(--secondary-color);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
    text-align: left;
}

.choice-item:hover {
  background-color: var(--hover-color);
  transform: translateY(-2px);
  box-shadow: 0 3px 8px var(--shadow-color);
}

.choice-item.user-selected {
  background-color: rgba(244, 67, 54, 0.05);
  border-color: var(--error-color);
}

.choice-item.correct-answer {
  background-color: rgba(76, 175, 80, 0.05);
  border-color: var(--success-color);
}

.choice-item.user-selected.correct-answer {
  background-color: rgba(76, 175, 80, 0.05);
  border-color: var(--success-color);
}

.choice-marker {
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 10px;
    font-weight: 600;
    font-size: 13px;
    background-color: #e0e0e0;
    color: var(--text-color);
    float: left;
}

.choice-item.user-selected .choice-marker {
  background-color: var(--error-color);
  color: var(--white);
}

.choice-item.correct-answer .choice-marker {
  background-color: var(--success-color);
  color: var(--white);
}

.choice-item.user-selected.correct-answer .choice-marker {
  background-color: var(--success-color);
  color: var(--white);
}

.choice-text {
    display: block;
    font-size: 16px;
    color: var(--text-color);
    font-weight: 500;
    text-align: left;
    margin-left: 35px;
}

.choice-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    float: right;
}

.choice-item.correct-answer .choice-icon {
  color: var(--success-color);
}

.choice-item.user-selected:not(.correct-answer) .choice-icon {
  color: var(--error-color);
}

.correct-icon {
    color: var(--success-color);
    font-style: normal;
    font-weight: bold;
    font-size: 18px;
}

.incorrect-icon {
    color: var(--error-color);
    font-style: normal;
    font-weight: bold;
    font-size: 18px;
}

.restart-container {
  text-align: center;
  padding: 20px;
  background-color: var(--secondary-color);
  border-top: 1px solid var(--border-color);
  border-radius: 0 0 8px 8px;
}

#restart-quiz {
  background: var(--primary-color);
  color: var(--white);
  border: none;
  padding: 12px 30px;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(25, 118, 210, 0.2);
  transition: all 0.3s ease;
}

#restart-quiz:hover {
  background: var(--primary-dark);
  box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
  transform: scale(1.05);
  letter-spacing: 1px;
}

#restart-quiz:active {
  transform: scale(0.98);
}

.login-form .form-group {
  margin-bottom: 20px;
  text-align: left;
}

.login-form label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #1976d2;
  font-size: 16px;
}

.login-input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: all 0.3s ease;
  background-color: white;
}

.login-input:focus {
  border-color: #1976d2;
  box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
  outline: none;
}

.login-btn {
  background: linear-gradient(45deg, #1976d2, #42a5f5);
  color: white;
  border: none;
  padding: 14px 30px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  width: 100%;
  margin-top: 30px;
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
}

.login-btn:hover:not([disabled]) {
  background: linear-gradient(45deg, #115293, #1976d2);
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
}

.login-btn:active:not([disabled]) {
  transform: translateY(0);
  box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
}

.login-btn[disabled] {
  background: linear-gradient(45deg, #ccc, #ddd);
  cursor: not-allowed;
  box-shadow: none;
}

.remember-me {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}

.remember-me input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.remember-me label {
  margin-bottom: 0;
  display: inline;
  cursor: pointer;
}

/* แสดงชื่อผู้เล่นในหน้าเล่นเกม */
.player-info {
  background-color: rgba(25, 118, 210, 0.05);
  border-radius: 8px;
  padding: 10px 15px;
  display: flex;
  align-items: center;
  margin-bottom: 15px;
  border-left: 3px solid #1976d2;
}

.player-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #1976d2;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
  margin-right: 12px;
}

.player-name {
  font-size: 16px;
  font-weight: 500;
  color: #115293;
}

.player-result-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.player-result-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: #1976d2;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: 600;
  margin-right: 15px;
}

.player-result-name {
  font-size: 24px;
  font-weight: 600;
  color: white;
}

/* เพิ่มสไตล์สำหรับแท็บหมวดหมู่ */
.category-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
}

.category-tab-content {
  display: none;
  padding: 15px;
  background-color: var(--white);
  border: 1px solid var(--border-color);
  border-radius: 4px;
}

.category-tab-content.active {
  display: block;
}

#categories-tree {
  margin: 10px 0;
  padding: 10px;
  background-color: var(--white);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  max-height: 300px;
  overflow-y: auto;
}

.category-item {
  margin: 5px 0;
  padding: 8px 12px;
  background-color: var(--secondary-color);
  border-radius: 4px;
  transition: all 0.2s ease;
}

.category-item:hover {
  background-color: var(--hover-color);
  transform: translateY(-2px);
}

.sub-categories {
  margin-left: 20px;
}
/* สไตล์สำหรับส่วนจัดการหมวดหมู่ */
.category-management-section {
    background: linear-gradient(145deg, #ffffff, #f0f7ff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 0 auto 25px;
    border: 1px solid rgba(25, 118, 210, 0.1);
    max-width: 100%;
    transition: box-shadow 0.3s ease;
}

.category-management-section:hover {
    box-shadow: 0 12px 25px rgba(25, 118, 210, 0.15);
}

.section-title {
    color: #115293;
    font-size: 20px;
    margin-top: 0;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #4791db;
    font-weight: 600;
    position: relative;
}

.category-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    background-color: rgba(25, 118, 210, 0.05);
    border-radius: 8px 8px 0 0;
    overflow: hidden;
}

.category-tabs .nav-tab {
    flex: 1;
    text-align: center;
    padding: 12px 15px;
    cursor: pointer;
    font-weight: 500;
    color: #555;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
}

.category-tabs .nav-tab:hover {
    background-color: rgba(25, 118, 210, 0.1);
    color: #1976d2;
}

.category-tabs .nav-tab.active {
    background-color: #ffffff;
    color: #1976d2;
    font-weight: 600;
    border-bottom: 3px solid #1976d2;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.category-tab-content {
    display: none;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.category-tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.categories-tree {
    margin: 10px 0;
    padding: 15px;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
}

.category-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    max-width: 600px;
    margin: 0 auto;
}

.category-field {
    margin-bottom: 15px;
    position: relative;
}

.category-field label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #1976d2;
    margin-bottom: 6px;
    transition: all 0.2s ease;
}

.category-input {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    margin-bottom: 10px;
}

.category-input:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.25);
    outline: none;
}

.category-btn {
    background: linear-gradient(45deg, #1976d2, #4791db);
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(25, 118, 210, 0.2);
    margin-top: 5px;
    width: auto;
    display: inline-block;
}

.category-btn:hover {
    background: linear-gradient(45deg, #115293, #1976d2);
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(25, 118, 210, 0.3);
}

.category-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(25, 118, 210, 0.2);
}

/* สไตล์สำหรับแสดงโครงสร้างหมวดหมู่ */
.category-item {
    margin: 8px 0;
    padding: 10px 12px;
    background-color: rgba(25, 118, 210, 0.05);
    border-radius: 8px;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
}

.category-item:hover {
    background-color: rgba(25, 118, 210, 0.1);
    border-left-color: #1976d2;
    transform: translateX(5px);
}

.sub-categories {
    margin-left: 20px;
    padding-left: 10px;
    border-left: 1px dashed rgba(25, 118, 210, 0.3);
}

/* รองรับการแสดงผลบนอุปกรณ์มือถือ */
@media (max-width: 600px) {
    .category-management-section {
        padding: 15px;
    }
    
    .category-tabs .nav-tab {
        padding: 10px;
        font-size: 14px;
    }
    
    .category-tab-content {
        padding: 15px;
    }
    
    .category-form {
        gap: 10px;
    }
    
    .category-field {
        margin-bottom: 10px;
    }
    
    .category-btn, .delete-btn {
        width: 100%;
    }
}
/* สไตล์สำหรับส่วนสร้างคำถามใหม่ */
.question-creation-section {
    background: linear-gradient(145deg, #ffffff, #f0f7ff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 30px auto;
    border: 1px solid rgba(25, 118, 210, 0.1);
    transition: box-shadow 0.3s ease;
}

.question-creation-section:hover {
    box-shadow: 0 12px 25px rgba(25, 118, 210, 0.15);
}

.question-form-container {
    max-width: 800px;
    margin: 0 auto;
}

.form-field {
    margin-bottom: 20px;
    position: relative;
}

.form-field > label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 8px;
}

.hint-text {
    font-size: 14px;
    color: #666;
    font-weight: normal;
    font-style: italic;
}

.question-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    resize: vertical;
    min-height: 80px;
    transition: all 0.3s ease;
    font-family: 'Prompt', sans-serif;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.question-textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.25);
    outline: none;
}

.image-upload-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.image-input {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background-color: white;
    font-size: 14px;
    transition: all 0.3s ease;
}

.image-preview-container {
    margin-top: 10px;
    text-align: center;
}

.image-preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    display: none;
}

.categories-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}

@media (min-width: 768px) {
    .categories-container {
        grid-template-columns: repeat(3, 1fr);
    }
}

.category-field {
    margin-bottom: 10px;
}

.category-field label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #1976d2;
    margin-bottom: 6px;
}

.category-label {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 12px;
}

.select-wrapper {
    position: relative;
}

.category-select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background-color: white;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    appearance: none;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.category-select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.25);
    outline: none;
}

.category-select:hover:not(:disabled) {
    border-color: #1976d2;
    background-color: #f8f9ff;
}

.category-select:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.select-arrow {
    position: absolute;
    top: 50%;
    right: 14px;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid #1976d2;
    pointer-events: none;
    transition: all 0.2s ease;
}

.choices-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.choice-container {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background-color: rgba(25, 118, 210, 0.05);
    border-radius: 10px;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.choice-container:hover {
    background-color: rgba(25, 118, 210, 0.1);
    border-left-color: #1976d2;
    transform: translateX(5px);
}

.choice-radio {
    position: relative;
    width: 22px;
    height: 22px;
    margin-right: 10px;
}

.choice-radio input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.custom-radio {
    position: absolute;
    top: 0;
    left: 0;
    height: 22px;
    width: 22px;
    background-color: #fff;
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.choice-radio:hover .custom-radio {
    border-color: #1976d2;
}

.choice-radio input:checked ~ .custom-radio {
    background-color: #fff;
    border-color: #1976d2;
}

.custom-radio:after {
    content: "";
    position: absolute;
    display: none;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1976d2;
}

.choice-radio input:checked ~ .custom-radio:after {
    display: block;
}

.choice-label {
    font-weight: 600;
    color: #1976d2;
    width: 30px;
    margin-right: 10px;
}

.choice-input {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s ease;
}

.choice-input:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
    outline: none;
}

/* ปรับปรุงสไตล์สำหรับส่วนคำถามที่บันทึกไว้ */
.saved-questions-section {
    background: linear-gradient(145deg, #ffffff, #f9fbff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 30px auto;
    border: 1px solid rgba(25, 118, 210, 0.1);
    transition: box-shadow 0.3s ease;
    max-width: 100%;
    overflow: hidden;
}

.questions-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
    width: 100%;
    box-sizing: border-box;
}

.question-card {
    width: calc(100% - 2px); /* หักลบค่าขอบ */
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border-top: 5px solid var(--primary-color);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.question-card h3 {
    color: var(--primary-dark);
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 15px;
    line-height: 1.4;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    word-break: break-word; /* ป้องกันข้อความล้นออกจากกรอบ */
}

.choice {
    padding: 10px 12px;
    border-radius: 8px;
    background-color: var(--secondary-color);
    transition: all 0.3s ease;
    position: relative;
    border-left: 3px solid transparent;
    word-break: break-word; /* ป้องกันข้อความล้นออกจากกรอบ */
    overflow: hidden;
}

.question-category {
    margin-top: 15px;
    padding: 10px;
    background-color: rgba(25, 118, 210, 0.05);
    border-radius: 8px;
    font-size: 14px;
    color: #666;
    word-break: break-word; /* ป้องกันข้อความล้นออกจากกรอบ */
}

.question-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: flex-end;
    flex-wrap: wrap; /* ทำให้ปุ่มลงมาอยู่ด้านล่างเมื่อไม่มีพื้นที่เพียงพอ */
}

/* ปรับปรุงความเข้ากันได้กับอุปกรณ์มือถือ */
@media (max-width: 768px) {
    .saved-questions-section {
        padding: 15px;
    }
    
    .question-card {
        padding: 15px;
    }
    
    .question-actions {
        justify-content: space-between;
    }
    
    .action-btn {
        min-width: 80px;
        font-size: 13px;
    }
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    font-size: 16px;
    background-color: rgba(25, 118, 210, 0.03);
    border-radius: 12px;
    border: 2px dashed rgba(25, 118, 210, 0.2);
}

.empty-state p {
    margin-bottom: 20px;
}

/* รองรับการแสดงผลบนมือถือ */
@media (max-width: 768px) {
    .section-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .search-input {
        width: 100%;
    }
    
    .questions-grid {
        grid-template-columns: 1fr;
    }
    
    .question-actions {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
}

/* สไตล์สำหรับตัวนับหน้า */
.pagination {
    display: flex;
    justify-content: center;
    margin-top: 30px;
    gap: 5px;
}

.pagination-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: white;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.pagination-btn:hover {
    background-color: var(--hover-color);
    border-color: var(--primary-color);
}

.pagination-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
/* ปรับจาก grid เป็น list สำหรับแสดงข้อมูลเรียงลงมา */
.questions-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
}

/* ปรับปรุงการ์ดคำถามให้มีความกว้างเต็มหน้าจอ */
.question-card {
    width: 100%;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border-top: 5px solid var(--primary-color);
    display: flex;
    flex-direction: column;
}
/* รูปแบบเฉพาะสำหรับปุ่มที่เลือก - ไม่ใช้ transition */
.option-btn.selected {
    background-color: #e3f2fd;
    border: 2px solid #1976d2;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
}

/* ลด animation และ transition อื่นๆ ที่อาจทำให้ช้า */
.option-btn.selected:after {
    content: "✓";
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--primary-color);
    font-weight: bold;
}

/* เพิ่ม CSS สำหรับคำถามที่ไม่ได้ตอบ */
.status-unanswered {
    background-color: rgba(245, 124, 0, 0.1);
    color: #F57C00;
}

.choice-item.unanswered {
    background-color: rgba(245, 124, 0, 0.05);
    border-color: #F57C00;
}

/* CSS สำหรับแสดงชื่อผู้เล่นที่มุมขวาบนของกรอบเกม (แบบกรอบธรรมดาไม่มีสี) */
.player-info.top-right {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: white; /* พื้นหลังสีขาว */
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    margin: 0;
    border: 1px solid #e0e0e0; /* ขอบบางๆ สีเทาอ่อน */
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* เงาบางๆ */
}

.player-info.top-right .player-name {
    font-size: 14px;
    font-weight: 500;
    color: #333333; /* สีข้อความเป็นสีเทาเข้ม ไม่ใช่สีน้ำเงิน */
}

/* ทำให้ container มี position relative เพื่อให้ absolute positioning ทำงานได้ถูกต้อง */
.container.quiz-player {
    position: relative;
}

/* สไตล์สำหรับประวัติการเล่น */
.history-filter-section, .history-section {
    background: linear-gradient(145deg, #ffffff, #f0f7ff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 30px auto;
    border: 1px solid rgba(25, 118, 210, 0.1);
    transition: box-shadow 0.3s ease;
}

.history-filter-section:hover, .history-section:hover {
    box-shadow: 0 12px 25px rgba(25, 118, 210, 0.15);
}

.filter-form {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-top: 15px;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
}

.filter-field {
    flex: 1;
    min-width: 200px;
    margin-bottom: 15px;
    padding: 5px;
}

.filter-field label {
    display: block;
    font-weight: 500;
    color: #1976d2;
    margin-bottom: 5px;
}

.date-input, .filter-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
}

.date-input:focus, .filter-select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    outline: none;
}

.filter-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.items-per-page-container {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #f0f7ff;
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 14px;
}

.per-page-select {
    padding: 5px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-family: 'Prompt', sans-serif;
}

/* สไตล์สำหรับตารางประวัติ */
.history-table-container {
    overflow-x: auto;
    margin-top: 15px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    overflow: hidden;
}

.history-table thead {
    background-color: #1976d2;
    color: white;
}

.history-table th {
    padding: 12px 15px;
    text-align: left;
    font-weight: 500;
}

/* Pagination สำหรับประวัติ */
#history-pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 5px;
}

.history-page-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background-color: #f0f0f0;
    color: #333;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Prompt', sans-serif;
}

.history-page-btn:hover {
    background-color: #e0e0e0;
}

.history-page-btn.active {
    background-color: #1976d2;
    color: white;
}

.history-page-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* การแสดงผลบนมือถือ */
@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    
    .filter-field {
        width: 100%;
    }
    
    .filter-actions {
        width: 100%;
        flex-direction: column;
    }
    
    .items-per-page-container {
        margin-top: 10px;
    }
    
    .history-table th, .history-table td {
        padding: 10px 8px;
        font-size: 14px;
    }
}

/* จัดการการแสดงผลของ login-screen */
#login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.95); /* ปรับความโปร่งใสได้ตามต้องการ */
    z-index: 9999; /* ค่า z-index สูงเพื่อให้แสดงด้านบนสุด */
}

#login-screen.hidden {
    display: none !important; /* บังคับให้ซ่อนโดยไม่สนใจ CSS อื่น */
}

/* การแสดงผลตามแท็บที่เลือก */
.active-tab-play #login-screen:not(.hidden) {
    display: flex !important; /* แสดงเฉพาะในแท็บเล่นเกม */
}

.active-tab-history #login-screen,
.active-tab-create #login-screen {
    display: none !important; /* ซ่อนในแท็บอื่นที่ไม่ใช่แท็บเล่นเกม */
}

/* ซ่อนองค์ประกอบที่เกี่ยวข้องกับการเล่นเกมในแท็บอื่น */
.active-tab-history .category-selection-container,
.active-tab-create .category-selection-container,
.active-tab-history #start-screen,
.active-tab-create #start-screen,
.active-tab-history #quiz-screen,
.active-tab-create #quiz-screen,
.active-tab-history #result-screen,
.active-tab-create #result-screen {
    display: none !important;
}

/* เพิ่มต่อท้ายโค้ด CSS ที่มีอยู่แล้วในแท็ก <style> */
.category-selection-container {
    background: linear-gradient(145deg, #ffffff, #f0f7ff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 0 auto 25px;
    border: 1px solid rgba(25, 118, 210, 0.1);
    max-width: 500px; /* จำกัดความกว้างสูงสุด */
}

.category-selection-header {
    text-align: center;
    margin-bottom: 20px; /* ปรับลดขนาดช่องว่าง */
}

.category-selection-header h3 {
    color: #1976d2;
    font-size: 20px; /* ลดขนาดฟอนต์ลง */
    font-weight: 600;
    margin-bottom: 8px;
    position: relative;
    display: inline-block;
}

.category-selection-header h3:after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, #1976d2, #4791db);
    border-radius: 3px;
}

.category-selection-header p {
    color: #555;
    font-size: 15px; /* ลดขนาดฟอนต์ลง */
    margin-top: 12px;
}

.category-selection-form {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px; /* ลดช่องว่างระหว่างฟิลด์ */
}

.category-field {
    margin-bottom: 3px; /* ลดช่องว่าง */
}

.category-field label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #1976d2;
    margin-bottom: 6px; /* ลดช่องว่าง */
    transition: all 0.2s ease;
}

.select-wrapper {
    position: relative;
}

.select-wrapper select {
    width: 100%;
    padding: 10px 14px; /* ลดขนาด padding */
    border: 2px solid #e0e0e0;
    border-radius: 10px; /* ลดความโค้ง */
    background-color: white;
    font-size: 15px; /* ลดขนาดฟอนต์ */
    font-weight: 500;
    color: #333;
    appearance: none;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.select-wrapper select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.25);
    outline: none;
}

.select-wrapper select:hover:not(:disabled) {
    border-color: #1976d2;
    background-color: #f8f9ff;
}

.select-wrapper select:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.select-arrow {
    position: absolute;
    top: 50%;
    right: 14px;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid #1976d2;
    pointer-events: none;
    transition: all 0.2s ease;
}

.select-wrapper:hover .select-arrow {
    border-top-color: #115293;
}

#start-quiz {
    background: linear-gradient(45deg, #1976d2, #4791db);
    color: white;
    border: none;
    padding: 12px 25px; /* ลดขนาด padding */
    font-size: 16px; /* ลดขนาดฟอนต์ */
    font-weight: 600;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: block;
    margin: 20px auto 0; /* ลดขนาดช่องว่าง */
    box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    letter-spacing: 0.5px;
}

#start-quiz:hover {
    background: linear-gradient(45deg, #115293, #1976d2);
    transform: translateY(-2px); /* ลดการเคลื่อนไหว */
    box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
}

#start-quiz:active {
    transform: translateY(0);
    box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
}

.hidden {
    display: none !important;
}

/* ปรับสไตล์สำหรับกล่อง login */
#login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* สไตล์สำหรับหน้าล็อกอิน - ปรับปรุงใหม่ */
.login-container {
  max-width: 500px; /* เพิ่มความกว้างสูงสุดขึ้น (เดิม 450px) */
  width: 90%; /* ทำให้มีความยืดหยุ่น แต่ใช้พื้นที่ส่วนใหญ่ของหน้าจอ */
  margin: 40px auto;
  padding: 35px; /* เพิ่มพื้นที่ว่างภายใน (เดิม 30px) */
  background: linear-gradient(145deg, #ffffff, #f0f7ff);
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(25, 118, 210, 0.15); /* เพิ่มเงาให้เด่นชัดขึ้น */
  text-align: center;
  border: 1px solid rgba(25, 118, 210, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.login-container:hover {
  box-shadow: 0 15px 30px rgba(25, 118, 210, 0.2); /* เพิ่มเงาเมื่อ hover */
}

.login-form h2 {
  color: #1976d2;
  font-size: 32px; /* เพิ่มขนาดตัวอักษร (เดิม 28px) */
  margin-bottom: 8px;
  font-weight: 600;
}

.login-form p {
  color: #666;
  margin-bottom: 30px; /* เพิ่มระยะห่าง (เดิม 25px) */
  font-size: 18px; /* เพิ่มขนาดตัวอักษร (เดิม 16px) */
}

.login-form .form-group {
  margin-bottom: 25px; /* เพิ่มระยะห่าง (เดิม 20px) */
  text-align: left;
}

.login-form label {
  display: block;
  margin-bottom: 10px; /* เพิ่มระยะห่าง (เดิม 8px) */
  font-weight: 500;
  color: #1976d2;
  font-size: 18px; /* เพิ่มขนาดตัวอักษร (เดิม 16px) */
}

.login-input {
  width: 100%;
  padding: 14px 15px; /* เพิ่มความสูงของช่องกรอก (เดิม 12px 15px) */
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 18px; /* เพิ่มขนาดตัวอักษร (เดิม 16px) */
  transition: all 0.3s ease;
  background-color: white;
}

.login-input:focus {
  border-color: #1976d2;
  box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
  outline: none;
}

.login-btn {
  background: linear-gradient(45deg, #1976d2, #42a5f5);
  color: white;
  border: none;
  padding: 16px 30px; /* เพิ่มขนาดปุ่ม (เดิม 14px 30px) */
  font-size: 20px; /* เพิ่มขนาดตัวอักษร (เดิม 18px) */
  font-weight: 600;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  width: 100%;
  margin-top: 35px; /* เพิ่มระยะห่าง (เดิม 30px) */
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
}

.login-btn:hover:not([disabled]) {
  background: linear-gradient(45deg, #115293, #1976d2);
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
}

.login-btn:active:not([disabled]) {
  transform: translateY(0);
  box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
}

.login-btn[disabled] {
  background: linear-gradient(45deg, #ccc, #ddd);
  cursor: not-allowed;
  box-shadow: none;
}

.remember-me {
  display: flex;
  align-items: center;
  gap: 10px; /* เพิ่มระยะห่าง (เดิม 8px) */
  margin-top: 15px; /* เพิ่มระยะห่าง (เดิม 10px) */
}

.remember-me input[type="checkbox"] {
  width: 20px; /* เพิ่มขนาด (เดิม 18px) */
  height: 20px; /* เพิ่มขนาด (เดิม 18px) */
  cursor: pointer;
}

.remember-me label {
  margin-bottom: 0;
  display: inline;
  cursor: pointer;
  font-size: 16px; /* ปรับขนาดตัวอักษร */
}

/* ปรับสไตล์สำหรับกรอบ login ที่เป็น overlay */
#login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.96); /* ปรับความโปร่งใสเล็กน้อย */
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ปรับแต่งการแสดงผลบนมือถือ */
@media (max-width: 600px) {
  .login-container {
    width: 90%;
    padding: 25px;
    margin: 20px auto;
  }
  
  .login-form h2 {
    font-size: 28px;
  }
  
  .login-form p {
    font-size: 16px;
  }
  
  .login-btn {
    padding: 14px 20px;
    font-size: 18px;
  }
}

/* CSS สำหรับปรับปรุงส่วนตัวกรองในหน้าประวัติการเล่น */
.history-filter-section {
    background: linear-gradient(145deg, #ffffff, #f0f7ff);
    border-radius: 16px;
    box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
    padding: 25px;
    margin: 30px auto;
    border: 1px solid rgba(25, 118, 210, 0.1);
    transition: box-shadow 0.3s ease;
}

.history-filter-section:hover {
    box-shadow: 0 12px 25px rgba(25, 118, 210, 0.15);
}

.filter-form {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid #e0e0e0;
}

.filter-group-title {
    font-weight: 600;
    color: #1565c0;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
    font-size: 17px;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
}

.filter-date-row {
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px dashed #e0e0e0;
}

.filter-category-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

.filter-field {
    flex: 1;
    min-width: 200px;
    margin-bottom: 15px;
    padding: 5px;
}

.filter-field label {
    display: block;
    font-weight: 500;
    color: #1976d2;
    margin-bottom: 8px;
    font-size: 15px;
}

.date-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    background-color: white;
    font-size: 15px;
}

.date-input:hover {
    border-color: #bbdefb;
}

.filter-select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    background-color: white;
}

.date-input:focus, .filter-select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    outline: none;
}

.filter-select:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: flex-end;
}

#apply-history-filter {
    background: linear-gradient(45deg, #1976d2, #4791db);
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
}

#apply-history-filter:hover {
    background: linear-gradient(45deg, #115293, #1976d2);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(25, 118, 210, 0.25);
}

#reset-history-filter {
    background: linear-gradient(45deg, #f5f5f5, #e0e0e0);
    color: #424242;
    border: none;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
}

#reset-history-filter:hover {
    background: linear-gradient(45deg, #e0e0e0, #d5d5d5);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* การแสดงผลบนมือถือ */
@media (max-width: 768px) {
    .filter-row, .filter-date-row, .filter-category-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .filter-field {
        width: 100%;
    }
    
    .filter-actions {
        flex-direction: column;
        width: 100%;
    }
    
    #apply-history-filter, #reset-history-filter {
        width: 100%;
    }
}

/* แก้ไขส่วนกรองตามช่วงเวลา */
.filter-date-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px dashed #e0e0e0;
    width: 100%; /* กำหนดความกว้างชัดเจน */
}

.filter-field {
    flex: 1;
    min-width: 180px; /* ลดความกว้างขั้นต่ำลงเล็กน้อย */
    margin-bottom: 15px;
    padding: 5px;
    box-sizing: border-box; /* เพิ่มเพื่อให้ padding ไม่ทำให้กล่องใหญ่เกิน */
}

.date-input {
    width: 100%;
    padding: 10px 12px; /* ลดขนาด padding */
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: 'Prompt', sans-serif;
    transition: all 0.3s ease;
    background-color: white;
    font-size: 14px; /* ลดขนาดตัวอักษร */
    box-sizing: border-box; /* เพิ่มเพื่อให้ padding ไม่ทำให้กล่องใหญ่เกิน */
}

/* ปรับปรุงการแสดงผลบนอุปกรณ์มือถือ */
@media (max-width: 768px) {
    .filter-date-row {
        flex-direction: column;
        gap: 10px;
    }
    
    .filter-field {
        width: 100%;
        margin-bottom: 10px;
    }
}

/* ปรับแต่ง container หลัก */
.history-filter-section {
    padding: 20px; /* ลดขนาด padding */
}

/* ปรับแต่งฟอร์มตัวกรอง */
.filter-form {
    padding: 15px; /* ลดขนาด padding */
}

/* ปรับแต่งส่วนหัวของกลุ่มตัวกรอง */
.filter-group-title {
    margin-bottom: 12px; /* ลดขนาดขอบด้านล่าง */
}

/* ปรับหน้าสรุปผลให้เต็มจอบนมือถือ */
#result-screen {
  width: 100%;
  padding: 20px;
  margin: 0;
  display: flex;
  justify-content: center;
  box-sizing: border-box;
}

.result-container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
  border-radius: 8px;
  box-shadow: 0 6px 18px var(--shadow-color);
  background-color: var(--white);
  box-sizing: border-box;
}

@media (min-width: 768px) {
  /* เมื่อไม่ใช่มือถือ คงความสวยงามไว้ */
  #result-screen {
    padding: 20px;
  }
  
  .result-container {
    max-width: 800px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  }
}

/* ปรับปรุงส่วนหัวของผลลัพธ์ */
.result-header {
  padding: 15px;
  text-align: center;
}

.result-header h2 {
  font-size: 22px;
  margin: 10px 0;
}

/* ปรับปรุงส่วนแสดงคะแนน */
.result-score-container {
  padding: 10px 0;
}

.result-score {
  width: 150px;
  height: 150px;
}

.score-value {
  font-size: 42px;
}

.score-separator,
.score-max {
  font-size: 28px;
}

.score-percent {
  font-size: 14px;
  padding: 4px 14px;
  bottom: -12px;
}

/* ปรับปรุงส่วนแสดงสถิติ */
.quiz-stats {
  flex-wrap: wrap;
  padding: 10px;
}

.stat-item {
  padding: 8px;
  min-width: 30%;
}

.stat-item:after {
  display: none;
}

.stat-value {
  font-size: 24px;
}

.stat-label {
  font-size: 12px;
}

/* ปรับปรุงส่วนทบทวนคำถาม */
.review-header {
  padding: 12px;
}

.review-header h3 {
  font-size: 18px;
}

.question-review-list {
  padding: 10px;
}

.question-review-item {
  padding: 15px;
  margin-bottom: 15px;
}

.question-text {
  font-size: 16px;
  line-height: 1.4;
}

.choice-item {
  padding: 10px 12px;
}

.choice-text {
  font-size: 14px;
}

/* ปรับขนาดตัวแสดงสถานะ (ถูก/ผิด) */
.question-status {
  padding: 2px 8px;
  font-size: 11px;
}

/* ปรับปรุงปุ่มเล่นใหม่ */
.restart-container {
  padding: 15px;
}

#restart-quiz {
  padding: 10px 25px;
  font-size: 16px;
  width: 100%;
  max-width: 250px;
}

/* สไตล์สำหรับจอขนาดเล็กมาก */
@media (max-width: 375px) {
  .result-score {
    width: 120px;
    height: 120px;
  }

  .score-value {
    font-size: 36px;
  }

  .score-separator,
  .score-max {
    font-size: 24px;
  }

  .stat-value {
    font-size: 20px;
  }

  .question-text {
    font-size: 15px;
  }
  
  .choice-text {
    font-size: 13px;
  }
}

/* เพิ่มเติม: แก้ปัญหาเลขหน้าในกรณีมีหลายคำถาม */
.question-number {
  font-size: 14px;
}

/* ปรับปรุงการแสดงผลของตัวเลือกคำตอบ */
.choice-marker {
  width: 22px;
  height: 22px;
  font-size: 12px;
  flex-shrink: 0;
}

/* ปรับการแสดงผลหมวดหมู่ให้เข้ากับหน้าจอเล็ก */
.category-summary {
  padding: 10px;
  margin-bottom: 15px;
  flex-direction: column;
  align-items: flex-start;
}

.category-title {
  margin-bottom: 5px;
  font-size: 14px;
}

.category-path {
  font-size: 13px;
  word-break: break-word;
}

/* สไตล์เพิ่มเติมสำหรับหน้าจอขนาดกลาง */
@media (min-width: 480px) and (max-width: 767px) {
  .result-score {
    width: 160px;
    height: 160px;
  }

  .score-value {
    font-size: 46px;
  }

  .score-separator,
  .score-max {
    font-size: 32px;
  }
  
  .category-summary {
    flex-direction: row;
    align-items: center;
  }
}

/* ปรับปรุงส่วนหัวของหน้าประวัติ */
.history-section .section-header,
.history-filter-section .section-header {
  flex-direction: column;
  align-items: flex-start;
}

.section-title-container {
  width: 100%;
  margin-bottom: 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}

.total-history-count {
  margin-top: 5px;
}

.items-per-page-container {
  margin-top: 8px;
  width: 100%;
  justify-content: flex-start;
}

/* ปรับปรุงส่วนตัวกรอง */
.filter-form {
  padding: 12px;
  border-radius: 8px;
}

.filter-container {
  gap: 8px;
}

.filter-group {
  flex-direction: column;
  padding: 12px 10px;
}

.filter-label {
  margin-bottom: 8px;
  width: 100%;
}

.date-inputs,
.category-selects {
  width: 100%;
  flex-direction: column;
  gap: 10px;
}

.search-field,
.date-field,
.select-field {
  width: 100%;
}

.filter-actions-row {
  margin-top: 15px;
}

.filter-button {
  width: 100%;
  padding: 10px;
  text-align: center;
}

/* ปรับขนาดตารางประวัติ */
.history-table-container {
  overflow-x: auto;
  margin-bottom: 15px;
}

.history-table {
  min-width: 650px; /* ขั้นต่ำเพื่อให้แสดงข้อมูลได้ครบถ้วน */
}

/* ปรับขนาดและการแสดงผลของแต่ละคอลัมน์ */
.history-table th,
.history-table td {
  padding: 8px 10px;
  font-size: 13px;
}

/* แก้ไขความกว้างของแต่ละคอลัมน์ */
.history-table th:nth-child(1),
.history-table td:nth-child(1) {
  width: 40px;
  min-width: 40px;
  max-width: 40px;
}

.history-table th:nth-child(2),
.history-table td:nth-child(2) {
  width: 80px;
  min-width: 80px;
  max-width: 100px;
}

.history-table th:nth-child(3),
.history-table td:nth-child(3) {
  width: 80px;
  min-width: 80px;
}

.history-table th:nth-child(4),
.history-table td:nth-child(4) {
  width: 200px;
  min-width: 200px;
}

.history-table th:nth-child(5),
.history-table td:nth-child(5) {
  width: 90px;
  min-width: 90px;
  max-width: 100px;
}

.history-table th:nth-child(6),
.history-table td:nth-child(6) {
  width: 50px;
  min-width: 50px;
  max-width: 50px;
}

/* ปรับปรุงการแสดงผลในแต่ละช่อง */
.history-table .player-name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100px;
}

.history-table .score-display {
  font-size: 13px;
  padding: 4px 8px;
}

.history-table .date-time {
  font-size: 12px;
}

.history-table .date-display,
.history-table .time-display {
  font-size: 11px;
}

.delete-history-btn {
  padding: 4px 8px;
  font-size: 12px;
}

/* ปรับปรุงการแสดงผลของหมวดหมู่ */
.history-table .category-path {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.history-table .category-segment {
  font-size: 11px;
  padding: 2px 6px;
  margin: 1px 0;
  max-width: 100%;
  white-space: normal;
  word-break: break-word;
}

/* ปรับปรุงส่วน pagination */
#history-pagination {
  gap: 3px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 15px 0;
}

.history-page-btn {
  width: 32px;
  height: 32px;
  font-size: 12px;
}

/* ปรับปรุงส่วนหน้าต่างยืนยันการลบ */
.confirm-dialog {
  width: 90%;
  max-width: 320px;
}

.confirm-header {
  padding: 12px 15px;
}

.confirm-body {
  padding: 15px;
}

.confirm-actions {
  flex-direction: column;
  gap: 8px;
  padding: 12px 15px;
}

.confirm-dialog button {
  width: 100%;
  padding: 10px;
  margin: 0;
}

/* สไตล์สำหรับการแสดงข้อความเมื่อไม่มีข้อมูล */
.empty-state {
  padding: 30px 15px;
  text-align: center;
}

.empty-state p {
  font-size: 14px;
  margin: 8px 0;
}

/* ปรับปรุงหน้าประวัติทั้งหมดให้กระชับขึ้น */
.history-filter-section,
.history-section {
  padding: 15px;
  margin: 15px auto;
}

.section-title {
  font-size: 18px;
}

/* สไตล์สำหรับหน้าจอขนาดต่างๆ */
@media screen and (min-width: 768px) {
  /* ขนาดหน้าจอเดสก์ท็อป - กลับไปใช้การจัดวางแบบเดิม */
  .history-section .section-header,
  .history-filter-section .section-header {
    flex-direction: row;
    align-items: center;
  }
  
  .section-title-container {
    width: auto;
    margin-bottom: 0;
  }
  
  .items-per-page-container {
    width: auto;
  }
  
  .date-inputs,
  .category-selects {
    flex-direction: row;
  }
  
  .filter-group {
    flex-direction: row;
  }
  
  .filter-label {
    width: auto;
    margin-right: 15px;
    margin-bottom: 0;
  }
  
  .filter-actions-row {
    flex-direction: row;
    justify-content: flex-end;
  }
  
  .filter-button {
    width: auto;
  }
  
  .history-table .category-path {
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .confirm-actions {
    flex-direction: row;
    justify-content: flex-end;
  }
  
  .confirm-dialog button {
    width: auto;
  }
}

/* สไตล์สำหรับอุปกรณ์ขนาดกลาง */
@media screen and (min-width: 480px) and (max-width: 767px) {
  .filter-actions-row {
    flex-direction: row;
    gap: 10px;
  }
  
  .filter-button {
    flex: 1;
  }
  
  .history-table-container {
    margin: 0 -15px; /* ขยายขอบให้กว้างกว่ากรอบหลัก */
  }
  
  .history-table th:nth-child(2),
  .history-table td:nth-child(2) {
    width: 100px;
    min-width: 100px;
  }
  
  .history-table .category-segment {
    font-size: 12px;
  }
}

/* สไตล์สำหรับการแสดงผลในโหมดแนวตั้ง (Portrait) บนมือถือ */
@media screen and (max-width: 479px) and (orientation: portrait) {
  /* ปรับปรุงการแสดงผลตาราง */
  .history-table-container {
    margin: 0 -15px; /* ขยายขอบให้กว้างกว่ากรอบหลัก */
    border-radius: 0;
  }
  
  .history-table {
    border-radius: 0;
  }
  
  /* ซ่อนบางคอลัมน์ที่อาจไม่จำเป็นในหน้าจอขนาดเล็กมาก */
  .history-table th:nth-child(5),
  .history-table td:nth-child(5) {
    display: none;
  }
}

/* เรียกคืนการแสดงผลของการค้นหาในตัวกรอง */
.search-field {
  position: relative;
}

.search-icon {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
}

/* ปรับปรุงปุ่มล้างประวัติทั้งหมด */
.clear-all-history-btn {
  display: block;
  width: 100%;
  margin-top: 10px;
  margin-left: 0;
  padding: 8px 15px;
  text-align: center;
}

@media (min-width: 768px) {
  .clear-all-history-btn {
    display: inline-block;
    width: auto;
    margin-left: auto;
    margin-top: 0;
  }
}

/* ปรับขนาดคอนเทนเนอร์หลัก */
.category-management-section {
  padding: 15px;
  margin: 15px auto;
  max-width: 100%;
  border-radius: 12px;
}

/* ปรับปรุงส่วนหัวของแต่ละส่วน */
.section-title {
  font-size: 18px;
  padding-bottom: 6px;
  margin-bottom: 12px;
}

/* ปรับขนาดแผนผังต้นไม้หมวดหมู่ */
.category-tree-container {
  padding: 8px;
  max-height: 400px;
}

/* ปรับปรุงรายการหมวดหมู่ */
.category-item {
  margin: 6px 0;
  border-radius: 6px;
}

.category-header {
  padding: 8px 10px;
  flex-wrap: wrap;
}

.category-name {
  flex-grow: 1;
  font-size: 14px;
  margin-right: 5px;
  word-break: break-word;
}

.category-actions {
  margin-top: 5px;
  width: 100%;
  display: flex;
  justify-content: flex-end;
  gap: 5px;
}

/* ปรับขนาดหมวดหมู่ย่อย */
.sub-categories {
  padding-left: 15px;
}

/* ปรับปรุงสำหรับปุ่มแก้ไข/ลบ */
.small-btn {
  font-size: 11px;
  padding: 3px 6px;
  border-radius: 3px;
}

/* ปรับปรุงส่วนปุ่มเพิ่มหมวดหมู่ */
.add-category-btn {
  margin: 8px 0;
  padding-left: 15px;
}

.add-btn {
  padding: 6px 10px;
  font-size: 13px;
  width: 100%;
  text-align: center;
}

/* ปรับปรุงฟอร์มเพิ่ม/แก้ไขหมวดหมู่ */
#category-form-container {
  padding: 10px;
}

.form-body {
  width: 90%;
  max-width: 320px;
  margin: 0 auto;
}

.form-header {
  padding: 12px 15px;
}

.form-header h3 {
  font-size: 16px;
}

.form-group label {
  font-size: 14px;
}

.form-input {
  padding: 8px 10px;
  font-size: 15px;
}

.form-actions {
  flex-direction: column;
  gap: 8px;
}

.form-actions button {
  width: 100%;
}

/* ปรับปรุงหน้าต่างยืนยันการลบ */
#category-confirm-container {
  padding: 10px;
}

.confirm-dialog {
  width: 90%;
  max-width: 300px;
}

.confirm-dialog h3 {
  font-size: 16px;
}

.confirm-body {
  padding: 15px;
  font-size: 14px;
}

.confirm-actions {
  flex-direction: column;
  gap: 8px;
  padding: 12px;
}

.confirm-actions button {
  width: 100%;
  padding: 8px;
}

/* ปรับปรุงฟอร์มคำถาม */
.question-creation-section {
  padding: 15px;
  margin: 15px auto;
}

.form-field {
  margin-bottom: 15px;
}

.form-field > label {
  font-size: 15px;
  margin-bottom: 6px;
}

/* ปรับขนาดช่องกรอกคำถาม */
.question-textarea {
  padding: 10px;
  font-size: 14px;
  min-height: 60px;
}

/* ปรับปรุงส่วนอัพโหลดรูปภาพ */
.image-upload-container {
  gap: 8px;
}

.image-input {
  padding: 8px;
  font-size: 13px;
}

.image-preview {
  max-height: 150px;
}

/* ปรับปรุงส่วนเลือกหมวดหมู่ */
.categories-container {
  gap: 10px;
}

.category-label {
  font-size: 15px;
  margin-bottom: 8px;
}

.category-field label {
  font-size: 13px;
  margin-bottom: 4px;
}

.category-select {
  padding: 8px 10px;
  font-size: 14px;
}

/* ปรับปรุงส่วนตัวเลือกคำตอบ */
.choice-container {
  padding: 10px;
  margin-bottom: 8px;
}

.choice-label {
  width: 25px;
  font-size: 14px;
}

.choice-input {
  padding: 8px;
  font-size: 14px;
}

.choice-radio-input {
  width: 16px;
  height: 16px;
}

/* ปรับปรุงปุ่มในฟอร์ม */
.form-actions {
  margin-top: 20px;
  flex-direction: column;
  gap: 10px;
}

.primary-btn, .secondary-btn {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  text-align: center;
}

/* ปรับปรุงส่วนแสดงคำถามที่บันทึกไว้ */
.saved-questions-section {
  padding: 15px;
  margin: 15px auto;
}

/* ปรับส่วนหัว */
.section-header {
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 15px;
}

.question-counter {
  font-size: 14px;
}

.search-container {
  width: 100%;
  max-width: 100%;
  margin-top: 8px;
}

.search-input {
  width: 100%;
}

/* ปรับรูปแบบการ์ดคำถาม */
.question-card {
  padding: 15px;
  margin-bottom: 15px;
}

.question-card h3 {
  font-size: 16px;
  margin-bottom: 10px;
  padding-bottom: 8px;
}

.question-image {
  max-height: 150px;
  margin: 8px 0;
}

.choice {
  padding: 8px 10px;
  font-size: 13px;
  margin-bottom: 5px;
}

.question-category {
  margin-top: 12px;
  padding: 8px;
  font-size: 12px;
}

.question-actions {
  margin-top: 12px;
  flex-wrap: wrap;
  gap: 8px;
}

.action-btn {
  padding: 6px 12px;
  font-size: 13px;
  flex: 1;
  min-width: 70px;
  text-align: center;
}

.management-section {
  padding: 12px;
  margin-bottom: 15px;
  border-radius: 6px;
}

.management-section h2 {
  font-size: 16px;
  margin-bottom: 12px;
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.actions button {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  text-align: center;
}

/* ปรับแต่งรูปแบบแสดงข้อความเมื่อไม่มีข้อมูล */
.empty-state {
  padding: 25px 15px;
}

.empty-state p {
  font-size: 14px;
  margin: 8px 0;
}

/* สำหรับอุปกรณ์ขนาดกลาง */
@media (min-width: 480px) and (max-width: 767px) {
  /* ปรับปรุงรายการหมวดหมู่ */
  .category-header {
    flex-wrap: nowrap;
  }
  
  .category-actions {
    width: auto;
    margin-top: 0;
  }
  
  /* ปรับปรุงการ์ดคำถาม */
  .question-actions {
    justify-content: flex-end;
  }
  
  .action-btn {
    flex: 0 0 auto;
  }
  
  /* ปรับปรุงการจัดการข้อมูล */
  .actions {
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .actions button {
    width: auto;
    flex: 1;
  }
}

/* สำหรับเดสก์ท็อป */
@media (min-width: 768px) {
  /* ปรับให้คืนค่าเดิมสำหรับเดสก์ท็อป */
  .section-header {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
  
  .search-container {
    width: auto;
    max-width: 300px;
    margin-top: 0;
  }
  
  .form-actions {
    flex-direction: row;
    justify-content: flex-start;
  }
  
  .primary-btn, .secondary-btn {
    width: auto;
  }
  
  .form-actions button {
    width: auto;
  }
  
  .actions {
    flex-direction: row;
  }
  
  .actions button {
    width: auto;
  }
  
  /* ปรับปรุงฟอร์มหมวดหมู่ */
  .form-actions {
    flex-direction: row;
  }
  
  .form-actions button {
    width: auto;
  }
  
  .confirm-actions {
    flex-direction: row;
  }
  
  .confirm-actions button {
    width: auto;
  }
  
  /* ปรับให้คืนค่าการแสดงหมวดหมู่เดิม */
  .categories-container {
    grid-template-columns: repeat(3, 1fr);
  }
  
  /* ปรับขนาดใน section ต่างๆ */
  .category-management-section,
  .question-creation-section,
  .saved-questions-section {
    padding: 25px;
    margin: 30px auto;
  }
  
  .management-section {
    padding: 16px;
    margin-bottom: 20px;
  }
}

/* สำหรับหน้าจอขนาดเล็กพิเศษ */
@media (max-width: 359px) {
  /* ลดขนาดให้เล็กลงอีก */
  .category-header {
    padding: 6px 8px;
  }
  
  .category-name, .choice, .question-category {
    font-size: 12px;
  }
  
  .small-btn {
    font-size: 10px;
    padding: 2px 4px;
  }
  
  .form-header h3, .confirm-dialog h3 {
    font-size: 14px;
  }
}

/* Master Responsive System - สำหรับ Layout หลัก */
@media (max-width: 480px) {
  .content-area {
    padding: 0 var(--space-sm);
  }
  
  .unified-container {
    padding: var(--space-sm);
    margin-bottom: var(--space-sm);
  }
}

@media (min-width: 1200px) {
  :root {
    --container-max-width: 900px;
  }
}

/* ตัวกรองหมวดหมู่ */
.category-filter-container {
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
  width: 100%;
}

.filter-group {
  width: 100%;
}

.filter-select {
  width: 100%;
  padding: 8px;
  font-size: 13px;
}

.filter-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  font-size: 13px;
}

@media (min-width: 768px) {
  .category-filter-container {
    flex-direction: row;
    gap: 10px;
  }
  
  .filter-btn {
    width: auto;
    margin-top: 0;
  }
}

.container.quiz-player {
  max-width: 100%;
  width: 100%;
  padding: 15px;
  margin: 0;
  box-sizing: border-box;
  position: relative;
}

.quiz-player h1 {
  font-size: 22px;
  margin-bottom: 15px;
  text-align: center;
}

.category-selection-container {
  width: 100%;
  max-width: 100%;
  padding: 15px;
  margin: 0 auto 15px;
  border-radius: 10px;
}

.category-selection-header h3 {
  font-size: 18px;
  margin-bottom: 6px;
}

.category-selection-header p {
  font-size: 14px;
  margin-top: 8px;
}

.category-selection-form {
  gap: 10px;
}

.category-field {
  margin-bottom: 0;
}

.category-field label {
  font-size: 14px;
  margin-bottom: 4px;
}

.select-wrapper select {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 8px;
}

#start-quiz {
  width: 100%;
  margin-top: 15px;
  padding: 10px;
  font-size: 16px;
  border-radius: 25px;
}

.player-info.top-right {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 10px;
  border-radius: 15px;
  z-index: 10;
  background-color: rgba(255, 255, 255, 0.9);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.player-info.top-right .player-name {
  font-size: 12px;
}

#start-screen {
  padding: 20px;
  text-align: center;
}

#start-screen p {
  font-size: 16px;
  margin-bottom: 15px;
}

#quiz-screen {
  width: 100%;
  padding: 0;
}

.quiz-progress {
  font-size: 14px;
  padding: 8px;
  margin: 10px auto 15px;
  width: 95%;
}

#quiz-question {
  font-size: 18px;
  line-height: 1.4;
  margin-bottom: 15px;
  padding: 0 5px;
}

#quiz-image {
  max-height: 180px;
  width: auto;
  max-width: 100%;
  margin: 0 auto 15px;
  display: block;
}

#quiz-choices {
  margin-top: 15px;
}

/* ปรับปรุงตัวเลือกคำตอบ */
.option-btn {
  padding: 12px;
  margin: 8px 0;
  font-size: 15px;
  border-radius: 8px;
  text-align: left;
  line-height: 1.3;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
  transition: background-color 0.2s ease, transform 0.1s ease;
  word-break: break-word;
}

.option-btn:active {
  transform: scale(0.98);
}

/* ลดการเคลื่อนไหวที่ไม่จำเป็น */
.option-btn:hover {
  transform: none;
  box-shadow: 0 2px 5px rgba(25, 118, 210, 0.1);
}

.option-btn.selected {
  background-color: #e3f2fd;
  border: 2px solid #1976d2;
  font-weight: 600;
  box-shadow: 0 1px 5px rgba(25, 118, 210, 0.2);
  transform: none;
}

.option-btn.selected:after {
  content: "✓";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: var(--primary-color);
  font-weight: bold;
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 15px;
  padding: 0 5px;
}

.navigation-btn {
  width: 100%;
  height: 40px;
  margin: 0;
  border-radius: 8px;
  order: 2;
}

#submit-answer {
  width: 100%;
  min-width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 25px;
  order: 1;
  margin: 0 0 5px 0;
}

#prev-question, #next-question {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

#prev-question svg, #next-question svg {
  width: 20px;
  height: 20px;
  margin: 0 5px;
}

#prev-question:not(.hidden) {
  order: 3;
}

#next-question:not(.hidden) {
  order: 4;
}

#result-screen .result-container {
  border-radius: 0;
  margin: 0;
  padding: 0;
  box-shadow: none;
}

.result-header {
  padding: 15px 10px;
  text-align: center;
}

.result-header h2 {
  font-size: 20px;
  margin: 0;
}

/* ส่วนแสดงคะแนน */
.result-score-container {
  display: flex;
  justify-content: center;
  margin: 10px 0;
}

.result-score {
  width: 140px;
  height: 140px;
}

.score-value {
  font-size: 40px;
}

.score-separator {
  font-size: 30px;
}

.score-max {
  font-size: 30px;
}

.score-percent {
  font-size: 14px;
  padding: 4px 12px;
  bottom: -10px;
}

/* สถิติคะแนน */
.quiz-stats {
  padding: 10px;
  flex-wrap: wrap;
}

.stat-item {
  padding: 8px 5px;
  width: 33%;
  box-sizing: border-box;
}

.stat-item:not(:last-child):after {
  display: none;
}

.stat-value {
  font-size: 24px;
}

.stat-label {
  font-size: 12px;
}

/* ปรับปรุงหัวข้อทบทวนคำถาม */
.review-header {
  padding: 12px;
  margin-bottom: 10px;
}

.review-header h3 {
  font-size: 16px;
  margin: 0;
}

/* ปรับปรุงส่วนทบทวนคำถาม */
.question-review-list {
  padding: 10px;
}

.question-review-item {
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
}

.question-number {
  font-size: 14px;
  margin-bottom: 8px;
}

.question-text {
  font-size: 16px;
  margin-bottom: 12px;
  line-height: 1.4;
}

.choice-item {
  padding: 10px;
  margin-bottom: 6px;
  border-radius: 6px;
}

.choice-marker {
  width: 20px;
  height: 20px;
  font-size: 12px;
  margin-right: 8px;
}

.choice-text {
  font-size: 14px;
  line-height: 1.3;
}

/* ปรับปรุงปุ่มเล่นอีกครั้ง */
.restart-container {
  padding: 15px;
  text-align: center;
}

#restart-quiz {
  width: 100%;
  max-width: 250px;
  padding: 12px;
  font-size: 16px;
}

.login-container {
  width: 90%;
  padding: 20px;
  margin: 15px auto;
}

.login-form h2 {
  font-size: 22px;
}

.login-form p {
  font-size: 15px;
  margin-bottom: 20px;
}

.login-form .form-group {
  margin-bottom: 15px;
}

.login-form label {
  font-size: 15px;
  margin-bottom: 5px;
}

.login-input {
  padding: 10px 12px;
  font-size: 16px;
  border-radius: 8px;
}

.login-btn {
  padding: 12px;
  font-size: 16px;
  margin-top: 20px;
}

.remember-me {
  gap: 8px;
}

.remember-me input[type="checkbox"] {
  width: 18px;
  height: 18px;
}

.remember-me label {
  font-size: 14px;
}

/* สำหรับหน้าจอขนาดเล็กพิเศษ */
@media (max-width: 359px) {
  .quiz-player h1 {
    font-size: 20px;
  }
  
  #quiz-question {
    font-size: 15px;
  }
  
  .option-btn {
    padding: 10px;
    font-size: 14px;
  }
  
  .result-score {
    width: 120px;
    height: 120px;
  }
  
  .score-value {
    font-size: 36px;
  }
  
  .score-separator, .score-max {
    font-size: 26px;
  }
  
  .navigation-btn {
    height: 36px;
  }
  
  #submit-answer {
    padding: 10px;
    font-size: 15px;
  }
}

/* สำหรับอุปกรณ์ขนาดกลาง */
@media (min-width: 480px) and (max-width: 767px) {
  .container.quiz-player {
    padding: 20px;
  }
  
  .quiz-player h1 {
    font-size: 24px;
  }
  
  #quiz-question {
    font-size: 20px;
  }
  
  #quiz-image {
    max-height: 200px;
  }
  
  .option-btn {
    padding: 12px 15px;
    font-size: 16px;
  }
  
  .actions {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  #submit-answer {
    width: 60%;
    order: 2;
    margin: 0;
  }
  
  .navigation-btn {
    width: 45px;
    height: 45px;
  }
  
  #prev-question:not(.hidden) {
    order: 1;
    margin-right: 5px;
  }
  
  #next-question:not(.hidden) {
    order: 3;
    margin-left: 5px;
  }
  
  /* ปรับส่วนแสดงผลคะแนน */
  .quiz-stats {
    flex-direction: row;
  }
  
  .stat-item {
    padding: 10px;
  }
}

/* สำหรับเดสก์ท็อป */
@media (min-width: 768px) {
  .container.quiz-player {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .quiz-player h1 {
    font-size: 28px;
  }
  
  .category-selection-container {
    max-width: 500px;
    padding: 25px;
  }
  
  .category-selection-header h3 {
    font-size: 20px;
  }
  
  .category-selection-header p {
    font-size: 15px;
  }
  
  #start-quiz {
    width: auto;
    padding: 12px 25px;
  }
  
  #quiz-question {
    font-size: 16px;
  }
  
  #quiz-image {
    max-height: 250px;
  }
  
  .option-btn {
    transition: all 0.3s ease;
  }
  
  .option-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(25, 118, 210, 0.15);
  }
  
  .actions {
    flex-direction: row;
    align-items: center;
    justify-content: center;
  }
  
  #submit-answer {
    width: auto;
    min-width: 200px;
    order: 2;
  }
  
  .navigation-btn {
    width: 45px;
    order: initial;
  }
  
  #prev-question:not(.hidden) {
    order: 1;
    margin-right: 10px;
  }
  
  #next-question:not(.hidden) {
    order: 3;
    margin-left: 10px;
  }
  
  /* ปรับส่วนแสดงผลคะแนน */
  #result-screen .result-container {
    max-width: 800px;
    margin: 0 auto;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  .result-score {
    width: 180px;
    height: 180px;
  }
  
  .score-value {
    font-size: 54px;
  }
  
  .score-separator, .score-max {
    font-size: 36px;
  }
  
  #restart-quiz:hover {
    transform: scale(1.05);
    letter-spacing: 1px;
  }
}

@media (max-height: 500px) and (orientation: landscape) {
  .container.quiz-player {
    padding: 10px;
  }
  
  .quiz-player h1 {
    font-size: 18px;
    margin-bottom: 10px;
  }
  
  /* จัดเรียงตัวเลือกในแนวนอน (2 คอลัมน์) */
  #quiz-choices {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  
  .option-btn {
    margin: 0;
    padding: 8px 10px;
    font-size: 14px;
    height: 100%;
  }
  
  .option-btn.selected:after {
    right: 8px;
    font-size: 16px;
  }
  
  /* ทำให้ปุ่มต่างๆ เล็กลง */
  .actions {
    flex-direction: row;
    margin-top: 10px;
    gap: 5px;
    justify-content: center;
    align-items: center;
  }
  
  #submit-answer {
    padding: 8px 15px;
    font-size: 14px;
    margin: 0 5px;
    min-width: 150px;
  }
  
  .navigation-btn {
    height: 36px;
    width: 36px;
  }
  
  /* ปรับส่วนหัวการเล่นเกม */
  .quiz-progress {
    padding: 5px;
    margin: 5px auto 10px;
    font-size: 12px;
  }
  
  #quiz-question {
    font-size: 16px;
    margin-bottom: 10px;
  }
  
  #quiz-image {
    max-height: 120px;
    margin-bottom: 10px;
  }
  
  /* ปรับส่วนล็อกอิน */
  .login-container {
    padding: 15px;
    margin: 10px auto;
  }
  
  .login-form h2 {
    font-size: 20px;
    margin-bottom: 5px;
  }
  
  .login-form p {
    font-size: 14px;
    margin-bottom: 15px;
  }
  
  .login-form .form-group {
    margin-bottom: 10px;
  }
  
  .login-input {
    padding: 8px 10px;
  }
  
  .login-btn {
    padding: 10px;
    margin-top: 15px;
  }
}

/* CSS สำหรับรายละเอียดการเล่นเกม */
.clickable-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.clickable-row:hover {
    background-color: #e3f2fd !important;
    transform: scale(1.01);
}

.game-details-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    padding: 20px;
    box-sizing: border-box;
}

.game-details-modal {
    background-color: white;
    border-radius: 12px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.modal-header {
    background: linear-gradient(135deg, #1976d2, #42a5f5);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
}

.modal-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.modal-title h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.modal-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.modal-close-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.player-result-header {
    display: flex;
    align-items: center;
}

.player-result-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 600;
    margin-right: 15px;
}

.player-result-info {
    flex: 1;
}

.player-result-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.play-datetime {
    font-size: 14px;
    opacity: 0.9;
}

.modal-score-section {
    padding: 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
}

.modal-review-section {
    padding: 20px;
}

.modal-review-section h3 {
    color: #1976d2;
    font-size: 20px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e0e0e0;
}

/* การปรับแต่งสำหรับมือถือ */
@media (max-width: 768px) {
    .game-details-modal-overlay {
        padding: 10px;
    }
    
    .game-details-modal {
        max-height: 95vh;
    }
    
    .modal-header {
        padding: 15px;
    }
    
    .modal-title h2 {
        font-size: 20px;
    }
    
    .player-result-header {
        flex-direction: column;
        text-align: center;
    }
    
    .player-result-avatar {
        margin-right: 0;
        margin-bottom: 10px;
    }
    
    .modal-score-section {
        padding: 15px;
    }
    
    .modal-review-section {
        padding: 15px;
    }
    
    .result-score {
        width: 140px;
        height: 140px;
    }
    
    .score-value {
        font-size: 40px;
    }
    
    .score-separator, .score-max {
        font-size: 28px;
    }
}

/* ปรับแต่งสำหรับมือถือ */
@media (max-width: 768px) {
    .admin-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
    }
    
    .admin-logout-btn {
        top: 10px;
        left: 10px;
        font-size: 12px;
        padding: 8px 12px;
    }
}

/* CSS สำหรับป็อปอัพรหัสผ่านแอดมิน */
.admin-password-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
    animation: fadeInOverlay 0.3s ease;
}

@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}

.admin-password-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
    overflow: hidden;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.admin-password-modal.shake {
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.admin-password-header {
    background: linear-gradient(135deg, #1976d2, #42a5f5);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-password-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.admin-password-header .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.admin-password-header .close-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.admin-password-body {
    padding: 20px;
}

.admin-password-body label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.admin-password-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
    font-family: 'Prompt', sans-serif;
    box-sizing: border-box;
}

.admin-password-input:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
    outline: none;
}

.admin-password-error {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
}

.admin-password-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 15px 20px;
    background-color: #f8f9fa;
}

.admin-password-confirm {
    background: linear-gradient(45deg, #1976d2, #42a5f5);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-family: 'Prompt', sans-serif;
}

.admin-password-confirm:hover {
    background: linear-gradient(45deg, #1565c0, #1976d2);
    transform: translateY(-2px);
}

.admin-password-cancel {
    background: #e0e0e0;
    color: #333;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-family: 'Prompt', sans-serif;
}

.admin-password-cancel:hover {
    background: #d5d5d5;
    transform: translateY(-2px);
}

/* การปรับแต่งสำหรับมือถือ */
@media (max-width: 768px) {
    .admin-password-actions {
        flex-direction: column;
    }
    
    .admin-password-confirm,
    .admin-password-cancel {
        width: 100%;
        margin-bottom: 8px;
    }
}

/* CSS สำหรับ Admin UI - แทนที่ CSS เก่า */
.admin-ui-container {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 9999;
}

/* Admin Mode Indicator (แสดงอย่างเดียว) */
.admin-mode-indicator {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #8b4513;
    border: 2px solid #daa520;
    padding: 10px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
    font-family: 'Prompt', sans-serif;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    box-shadow: 
        0 3px 8px rgba(255, 215, 0, 0.3),
        0 1px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    user-select: none;
    text-align: center;
}

/* Admin Logout Button (กดได้) */
.admin-logout-btn {
    background: linear-gradient(135deg, #f44336, #e57373);
    color: white;
    border: 2px solid #d32f2f;
    padding: 10px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    font-family: 'Prompt', sans-serif;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    box-shadow: 
        0 3px 8px rgba(244, 67, 54, 0.3),
        0 1px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    text-align: center;
}

.admin-logout-btn:hover {
    background: linear-gradient(135deg, #d32f2f, #f44336);
    border-color: #b71c1c;
    transform: translateY(-2px) scale(1.02);
    box-shadow: 
        0 5px 12px rgba(244, 67, 54, 0.4),
        0 2px 6px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.admin-logout-btn:active {
    transform: translateY(0) scale(1);
    box-shadow: 
        0 2px 6px rgba(244, 67, 54, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

/* ปรับแต่งสำหรับหน้าจอมือถือ - ย้ายลงล่างสุด */
@media (max-width: 768px) {
    .admin-ui-container {
        top: auto;
        bottom: 5px;
        right: 10px;
        gap: 6px;
    }
    
    /* ซ่อน indicator บนมือถือ */
    .admin-mode-indicator {
        display: none;
    }
    
    /* ปุ่มออกจากระบบเล็กลงอีก */
    .admin-logout-btn {
        padding: 3px 6px;
        font-size: 9px;
        border-radius: 8px;
    }
}

/* ปิด autocomplete และ suggestions - เพิ่มใน <style> */
.login-input {
    -webkit-autofill: none !important;
    -webkit-autocomplete: off !important;
    autocomplete: off !important;
}

.login-input::-webkit-credentials-auto-fill-button {
    display: none !important;
}

.login-input::-webkit-contacts-auto-fill-button {
    display: none !important;
}

/* ซ่อน dropdown suggestions */
.login-input::-webkit-list-button {
    display: none;
}

.login-input::-webkit-calendar-picker-indicator {
    display: none;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="nav-tabs">
<div class="nav-tab active" id="play-tab">เล่นเกม</div>
<div class="nav-tab" id="history-tab">ประวัติการเล่น</div>
<div class="nav-tab" id="create-tab">ตั้งค่า</div>
</div>

<!-- หน้าสร้าง/แก้ไขคำถาม -->
<div id="create-content" class="tab-content">
<div class="container">
<h1>สร้างและแก้ไขคำถาม</h1>


<!-- ส่วนการจัดการหมวดหมู่แบบใหม่ -->
<div class="management-section category-management-section">
    <h2 class="section-title">จัดการหมวดหมู่</h2>
    
    <!-- ส่วนแสดงและจัดการหมวดหมู่ -->
    <div class="category-management-container">
        <div id="category-tree-container" class="category-tree-container">
            <!-- หมวดหมู่จะถูกสร้างด้วย JavaScript -->
        </div>
        
        <!-- ฟอร์มเพิ่ม/แก้ไขหมวดหมู่ -->
        <div id="category-form-container"></div>
        
        <!-- หน้าต่างยืนยันการลบหมวดหมู่ -->
        <div id="category-confirm-container"></div>
    </div>
</div>
<!-- ส่วนการจัดการคำถามทั้งหมด -->
<div class="management-section" style="background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
  <h2 style="color: #115293; font-size: 20px; margin-top: 0; margin-bottom: 16px; border-bottom: 2px solid #4791db; padding-bottom: 8px;">จัดการคำถามทั้งหมด</h2>
  <div class="actions">
    <button id="export-all" class="secondary">ส่งออกข้อมูลทั้งหมด</button>
    <button id="clear-all" class="delete">ลบคำถามทั้งหมด</button>
    <button id="import-excel" class="secondary">นำเข้าจาก Excel</button>
    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;">
    <button id="download-template" class="secondary">ดาวน์โหลดเทมเพลต Excel</button>
  </div>
</div>

<!-- ส่วนสร้างคำถามใหม่ -->
<div id="question-form" class="question-creation-section">
    <h2 class="section-title">สร้างคำถามใหม่</h2>
    
    <div class="question-form-container">
        <div class="form-field">
            <label for="question-text">คำถาม:</label>
            <textarea id="question-text" rows="2" placeholder="พิมพ์คำถามของคุณที่นี่" class="question-textarea"></textarea>
        </div>

        <div class="form-field">
            <label for="question-image">รูปภาพ:</label>
            <div class="image-upload-container">
                <input type="file" id="question-image" accept="image/*" class="image-input">
                <div class="image-preview-container">
                    <img id="image-preview" class="image-preview">
                </div>
            </div>
        </div>

        <div class="form-field">
            <label class="category-label">หมวดหมู่:</label>
            
            <div class="categories-container">
                <div class="category-field">
                    <label for="question-main-category">หมวดหมู่หลัก:</label>
                    <div class="select-wrapper">
                        <select id="question-main-category" class="category-select">
                            <option value="">เลือกหมวดหมู่หลัก</option>
                        </select>
                        <div class="select-arrow"></div>
                    </div>
                </div>
                
                <div class="category-field">
                    <label for="question-sub-category1">หมวดหมู่ย่อย 1:</label>
                    <div class="select-wrapper">
                        <select id="question-sub-category1" class="category-select" disabled>
                            <option value="">เลือกหมวดหมู่ย่อย 1</option>
                        </select>
                        <div class="select-arrow"></div>
                    </div>
                </div>
                
                <div class="category-field">
                    <label for="question-sub-category2">หมวดหมู่ย่อย 2:</label>
                    <div class="select-wrapper">
                        <select id="question-sub-category2" class="category-select" disabled>
                            <option value="">เลือกหมวดหมู่ย่อย 2</option>
                        </select>
                        <div class="select-arrow"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-field">
            <label>ตัวเลือก <span class="hint-text">(เลือกข้อที่ถูกต้อง)</span></label>

            <div class="choice-container">
              <input type="radio" name="correct-answer" id="choice-a-correct" value="A" class="choice-radio-input">
              <label for="choice-a-correct" class="choice-label">A:</label>
              <input type="text" id="choice-a" placeholder="ตัวเลือก A" class="choice-input">
            </div>

            <div class="choice-container">
              <input type="radio" name="correct-answer" id="choice-b-correct" value="B" class="choice-radio-input">
              <label for="choice-b-correct" class="choice-label">B:</label>
              <input type="text" id="choice-b" placeholder="ตัวเลือก B" class="choice-input">
            </div>

            <div class="choice-container">
              <input type="radio" name="correct-answer" id="choice-c-correct" value="C" class="choice-radio-input">
              <label for="choice-c-correct" class="choice-label">C:</label>
              <input type="text" id="choice-c" placeholder="ตัวเลือก C" class="choice-input">
            </div>

            <div class="choice-container">
              <input type="radio" name="correct-answer" id="choice-d-correct" value="D" class="choice-radio-input">
              <label for="choice-d-correct" class="choice-label">D:</label>
              <input type="text" id="choice-d" placeholder="ตัวเลือก D" class="choice-input">
            </div>
        </div>

        <div class="form-actions">
            <button id="save-question" class="primary-btn">บันทึกคำถาม</button>
            <button id="clear-form" class="secondary-btn">ล้างฟอร์ม</button>
        </div>
    </div>
</div>

<!-- ส่วนคำถามที่บันทึกไว้ -->
<div class="saved-questions-section">
    <div class="section-header">
        <h2 class="section-title">คำถามที่บันทึกไว้ <span class="question-counter">(<span id="question-count">0</span>)</span></h2>
        <div class="question-filters">
            <div class="search-container">
                <input type="text" id="search-questions" placeholder="ค้นหาคำถาม..." class="search-input">
                <span class="search-icon">🔍</span>
            </div>
        </div>
    </div>
    
    <!-- เปลี่ยนจาก questions-grid เป็น questions-list -->
    <div id="questions-container" class="questions-list"></div>
</div>

</div>
</div>

<div id="play-content" class="tab-content active">
  <div class="container quiz-player">
    <h1>เกมตอบคำถาม</h1>
    
    <!-- ส่วนเลือกหมวดหมู่ -->
    <div id="category-selection-container" class="category-selection-container">
      <div class="category-selection-header">
        <h3>เลือกหมวดหมู่ที่ต้องการเล่น</h3>
        <p>กรุณาเลือกหมวดหมู่เพื่อเริ่มเล่นเกมตอบคำถาม</p>
      </div>
      
      <div class="category-selection-form">
        <div class="category-field">
          <label for="play-main-category">หมวดหมู่หลัก</label>
          <div class="select-wrapper">
            <select id="play-main-category" required>
              <option value="" disabled selected>เลือกหมวดหมู่หลัก</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>
        
        <div class="category-field">
          <label for="play-sub-category1">หมวดหมู่ย่อย 1</label>
          <div class="select-wrapper">
            <select id="play-sub-category1" disabled required>
              <option value="" disabled selected>เลือกหมวดหมู่ย่อย 1</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>
        
        <div class="category-field">
          <label for="play-sub-category2">หมวดหมู่ย่อย 2</label>
          <div class="select-wrapper">
            <select id="play-sub-category2" disabled required>
              <option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>
            </select>
            <div class="select-arrow"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ส่วนหน้าเริ่มเล่น -->
    <div id="start-screen" class="hidden">
      <p>เริ่มเล่นเกมตอบคำถามเลย!</p>
      <button id="start-quiz">เริ่มเล่น</button>
    </div>
    
    <!-- ส่วนหน้าเล่นเกม -->
    <div id="quiz-screen" class="hidden">
      <div class="quiz-progress">
        <span id="current-question">คำถามที่ 1</span> จาก <span id="total-questions">10</span>
      </div>

      <div id="question-display">
        <h2 id="quiz-question">คำถามจะปรากฏที่นี่</h2>
        <img id="quiz-image" class="question-image hidden">

        <div id="quiz-choices">
          <!-- ตัวเลือกจะถูกสร้างด้วย JavaScript -->
        </div>
      </div>

      <div class="actions">
        <button id="prev-question" class="navigation-btn secondary hidden">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
        </button>
        <button id="submit-answer" class="submit-btn">ตอบคำถาม</button>
        <button id="next-question" class="navigation-btn secondary hidden">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- หน้าประวัติการเล่น -->
<div id="history-content" class="tab-content">
<div class="container">
<h1>ประวัติการเล่น</h1>

<!-- ส่วนตัวกรอง -->
<div class="history-filter-section">
    <div class="section-header">
        <h2 class="section-title">ตัวกรองประวัติ</h2>
    </div>
    
    <div class="filter-form">
        <div class="filter-row">
            <div class="filter-field">
                <label for="filter-date-from">ตั้งแต่วันที่:</label>
                <input type="date" id="filter-date-from" class="date-input">
            </div>
            
            <div class="filter-field">
                <label for="filter-date-to">ถึงวันที่:</label>
                <input type="date" id="filter-date-to" class="date-input">
            </div>
            
            <div class="filter-field">
                <label for="filter-history-category">หมวดหมู่:</label>
                <select id="filter-history-category" class="filter-select">
                    <option value="">ทุกหมวดหมู่</option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button id="apply-history-filter" class="primary-btn">ค้นหา</button>
                <button id="reset-history-filter" class="secondary-btn">รีเซ็ต</button>
            </div>
        </div>
    </div>
</div>

<!-- ส่วนแสดงประวัติ -->
<div class="history-section">
    <div class="section-header">
    <div class="section-title-container">
        <h2 class="section-title">ประวัติการเล่น</h2>
        <div class="total-history-count">
            ทั้งหมด <span id="total-history-count">0</span> รายการ
        </div>
    </div>
    <div class="items-per-page-container" id="history-items-per-page">
        <label for="history-per-page">แสดง:</label>
        <select id="history-per-page" class="per-page-select">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="500">500</option>
        </select>
        <span>รายการต่อหน้า</span>
    </div>
</div>
    
    <!-- ตารางแสดงประวัติ -->
    <div id="history-container">
        <!-- ข้อมูลจะถูกเติมโดย JavaScript -->
        <div class="empty-state">
            <p>ยังไม่มีประวัติการเล่น</p>
            <p>เริ่มเล่นเกมเพื่อบันทึกประวัติ!</p>
        </div>
    </div>
    
    <!-- ตัวเลข pagination -->
    <div id="history-pagination" class="pagination">
        <!-- ปุ่ม pagination จะถูกสร้างโดย JavaScript -->
    </div>
</div>
</div>
</div>

<div id="login-screen" class="fade-in">
  <div class="login-container">
    <div class="login-form">
      <h2>ลงชื่อเข้าเล่นเกม</h2>
      <p>กรุณากรอกชื่อของคุณเพื่อเริ่มเล่นเกม</p>
      
      <div class="form-group">
        <label for="player-name">ชื่อผู้เล่น</label>
        <input type="text" id="player-name" class="login-input" placeholder="กรอกชื่อของคุณที่นี่" maxlength="20" autocomplete="off" spellcheck="false">
      </div>
      
      <div class="form-group remember-me">
        <input type="checkbox" id="remember-player" checked>
        <label for="remember-player">จำชื่อของฉัน</label>
      </div>
      
      <button id="login-button" class="login-btn" disabled>เริ่มเล่น</button>
    </div>
  </div>
</div>

<div id="start-screen" class="hidden">
<p>เริ่มเล่นเกมตอบคำถามเลย!</p>
<button id="start-quiz">เริ่มเล่น</button>
</div>

<div id="quiz-screen" class="hidden">
<div class="quiz-progress">
<span id="current-question">คำถามที่ 1</span> จาก <span id="total-questions">10</span>
</div>

<div id="question-display">
<h2 id="quiz-question">คำถามจะปรากฏที่นี่</h2>
<img id="quiz-image" class="question-image hidden">

<div id="quiz-choices">
<!-- ตัวเลือกจะถูกสร้างด้วย JavaScript -->
</div>
</div>

<div class="actions">
<button id="prev-question" class="navigation-btn secondary hidden">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>
</button>
<button id="submit-answer" class="submit-btn">ตอบคำถาม</button>
<button id="next-question" class="navigation-btn secondary hidden">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
</button>
</div>
</div>

<div id="result-screen" class="hidden">
  <div class="result-container">
    <div class="result-header">
      <h2>สรุปผลคะแนน</h2>
      
      <div class="result-score-container">
  <div class="result-score">
    <div class="score-display">
      <div class="score-value" id="score">0</div>
      <div class="score-separator">/</div>
      <div class="score-max" id="max-score">0</div>
    </div>
    <div class="score-percent" id="percent-correct">0%</div>
  </div>
</div>
    
    <div class="quiz-stats">
      <div class="stat-item">
        <div class="stat-value correct-value" id="correct-answers">0</div>
        <div class="stat-label">ตอบถูก</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value incorrect-value" id="incorrect-answers">0</div>
        <div class="stat-label">ตอบผิด</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value" id="total-questions-stats">0</div>
        <div class="stat-label">คำถามทั้งหมด</div>
      </div>
    </div>
    
    <div class="review-header">
      <h3>สรุปคำถามและคำตอบ</h3>
    </div>
    
    <div id="question-review" class="question-review-list">
      <!-- รายการคำถามจะถูกเพิ่มที่นี่โดย JavaScript -->
    </div>
    
    <div class="restart-container">
      <button id="restart-quiz">เล่นอีกครั้ง</button>
    </div>
  </div>
</div>
<script>
// Supabase Configuration
const SUPABASE_URL = 'https://sfugtyqygjfdksmpcqhq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdWd0eXF5Z2pmZGtzbXBjcWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NTIzMDgsImV4cCI6MjA2MzUyODMwOH0.G7SrGAbd1t3mioHsXHuyHYJdHwRwrVYp1AbshRwJ6l8';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ตัวแปรสำหรับเก็บโครงสร้างหมวดหมู่
let categories = {
    // โครงสร้าง: { "mainCategory": { "subCategory1": ["subCategory2"] } }
};

// ตัวแปรสำหรับเก็บคำถาม
let questions = [];

// ตัวแปรสำหรับเล่นเกม
let currentQuestionIndex = 0;
let userAnswers = {};
let randomQuestionOrder = [];
let choiceOrderMap = {}; // ใช้เก็บลำดับตัวเลือกที่สลับแล้วของแต่ละคำถาม

// เพิ่มตัวแปร global สำหรับเก็บคำถามที่กรองแล้ว
let currentGameQuestions = [];

// ตัวแปรสำหรับเก็บข้อมูลผู้เล่น
let currentPlayer = null;

// ตัวแปรสำหรับระบบแอดมินใหม่
let currentUser = null;
let isAdminMode = false;
let adminProfile = null;

// ฟังก์ชันตรวจสอบว่าเป็นแอดมินหรือไม่
async function checkIsAdmin(userId) {
    try {
        const { data, error } = await supabaseClient
            .from('admin_users')
            .select('*')
            .eq('id', userId)
            .eq('is_active', true)
            .single();
        
        if (error) {
            console.log('ไม่ใช่แอดมิน:', error.message);
            return null;
        }
        
        return data;
    } catch (error) {
        console.error('Error checking admin:', error);
        return null;
    }
}

// ฟังก์ชันล็อกอินแอดมิน - แก้ไขใหม่
async function loginAdmin(email, password) {
    try {
        // ล็อกอินด้วย Supabase Auth
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            throw error;
        }
        
        // ตรวจสอบว่าเป็นแอดมินหรือไม่
        const adminData = await checkIsAdmin(data.user.id);
        
        if (!adminData) {
            // ไม่ใช่แอดมิน ต้องออกจากระบบ
            await supabaseClient.auth.signOut();
            throw new Error('คุณไม่มีสิทธิ์เข้าใช้งานระบบแอดมิน');
        }
        
        // เป็นแอดมิน - กำหนดค่าตัวแปรระบบ
        currentUser = data.user;
        adminProfile = adminData;
        isAdminMode = true;
        
        console.log('ล็อกอินแอดมินสำเร็จ:', adminData);
        
        // เปิดโหมดแอดมิน
        activateAdminMode();
        
        return true;
        
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการล็อกอิน:', error);
        alert('เกิดข้อผิดพลาด: ' + error.message);
        return false;
    }
}

// ฟังก์ชันออกจากระบบแอดมิน
async function logoutAdmin() {
    try {
        await supabaseClient.auth.signOut();
        
        currentUser = null;
        adminProfile = null;
        isAdminMode = false;
        
        deactivateAdminMode();
        
        console.log('ออกจากระบบแอดมินแล้ว');
        
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการออกจากระบบ:', error);
    }
}

// ตัวแปรระบบสำหรับประวัติการเล่น
let gameHistory = [];
let currentHistoryPage = 1;
let historyItemsPerPage = 10;
let filteredHistory = [];

// ฟังก์ชันเพิ่มประวัติการเล่นใหม่ (ใช้ Database)
async function addGameHistoryEntry(player, score, totalQuestions, category, percentage) {
    try {
        const historyData = {
            player_name: player ? player.name : 'ไม่ระบุชื่อ',
            score: score || 0,
            total_questions: totalQuestions || 0,
            percentage: percentage || 0,
            category: JSON.stringify(category || {}),
            game_data: JSON.stringify({
                questions: currentGameQuestions ? [...currentGameQuestions] : [],
                userAnswers: userAnswers ? {...userAnswers} : {},
                randomOrder: randomQuestionOrder ? [...randomQuestionOrder] : [],
                choiceOrder: choiceOrderMap ? {...choiceOrderMap} : {}
            })
        };

        const { data, error } = await supabaseClient
            .from('game_history')
            .insert([historyData])
            .select();

        if (error) {
            console.error('เกิดข้อผิดพลาดในการบันทึกประวัติ:', error);
            return false;
        }

        console.log('บันทึกประวัติการเล่นสำเร็จ:', data);
        
        // โหลดประวัติใหม่และอัพเดตการแสดงผล
        await loadGameHistory();
        
        // อัพเดตการแสดงผลถ้าเปิดหน้าประวัติอยู่
        const historyTab = document.getElementById('history-tab');
        if (historyTab && historyTab.classList.contains('active')) {
            currentHistoryPage = 1;
            displayGameHistory();
        }
        
        return true;
    } catch (error) {
        console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
        return false;
    }
}

// ฟังก์ชันแปลงวันที่เป็นรูปแบบที่อ่านง่าย
function formatDate(date) {
    // เพิ่ม padding ให้กับตัวเลข
    const pad = (num) => String(num).padStart(2, '0');
    
    const day = pad(date.getDate());
    const month = pad(date.getMonth() + 1);
    const year = date.getFullYear();
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    
    return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// แก้ไขฟังก์ชัน displayGameHistory()
function displayGameHistory() {
    console.log("กำลังแสดงประวัติการเล่น...");
    
    const historyContainer = document.getElementById('history-container');
    
    if (!historyContainer) {
        console.error("ไม่พบ element 'history-container'");
        return false;
    }
    
    // ตรวจสอบตัวแปรระบบที่จำเป็น
    if (!Array.isArray(filteredHistory)) {
        console.error("filteredHistory ไม่ใช่อาเรย์");
        filteredHistory = Array.isArray(gameHistory) ? [...gameHistory] : [];
    }
    
    // แสดงจำนวนรายการประวัติการเล่นที่กรองแล้ว
const totalHistoryCount = document.getElementById('total-history-count');
if (totalHistoryCount) {
    // แสดงจำนวนรายการที่ผ่านการกรองแล้ว - เพิ่มช่องว่าง
    totalHistoryCount.textContent = ` ${filteredHistory.length}`;
}
    
    // ถ้าไม่มีประวัติ
    if (filteredHistory.length === 0) {
        historyContainer.innerHTML = `
            <div class="empty-state">
                <p>ไม่พบประวัติการเล่นตามเงื่อนไขที่ค้นหา</p>
                <p>ลองเปลี่ยนตัวกรองหรือรีเซ็ตการค้นหา</p>
            </div>
        `;
        
        // ซ่อนส่วนเพจเนชั่น
        const paginationElement = document.getElementById('history-pagination');
        const perPageElement = document.getElementById('history-items-per-page');
        
        if (paginationElement) paginationElement.style.display = 'none';
        if (perPageElement) perPageElement.style.display = 'none';
        
        return true;
    }
    
    // คำนวณรายการที่จะแสดงในหน้าปัจจุบัน
    if (typeof currentHistoryPage !== 'number' || isNaN(currentHistoryPage) || currentHistoryPage < 1) {
        currentHistoryPage = 1;
    }
    
    if (typeof historyItemsPerPage !== 'number' || isNaN(historyItemsPerPage) || historyItemsPerPage < 1) {
        historyItemsPerPage = 10;
    }
    
    const totalPages = Math.ceil(filteredHistory.length / historyItemsPerPage);
    if (currentHistoryPage > totalPages) {
        currentHistoryPage = totalPages;
    }
    
    const startIndex = (currentHistoryPage - 1) * historyItemsPerPage;
    const endIndex = Math.min(startIndex + historyItemsPerPage, filteredHistory.length);
    const currentPageItems = filteredHistory.slice(startIndex, endIndex);
    
    // สร้าง HTML สำหรับตาราง
    let historyHTML = `
        <div class="history-table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ลำดับ</th>
                        <th>ชื่อผู้เล่น</th>
                        <th>คะแนน</th>
                        <th>หมวดหมู่</th>
                        <th>วันที่และเวลา</th>
                        <th>การจัดการ</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // เพิ่มแถวข้อมูล
    currentPageItems.forEach((entry, index) => {
        try {
            // แปลงเวลาให้เป็นรูปแบบที่อ่านง่าย (24 ชั่วโมง)
                       const dateTimeFormatted = formatDateTime24Hour(entry.playedAt);
                                              const formattedDate = dateTimeFormatted.date;
                                              const formattedTime = dateTimeFormatted.time;
            
            // แยกชื่อหมวดหมู่และทำให้ดูดีขึ้น
            let categoryHTML = '<div class="category-path">';
            
            if (entry.category) {
                const main = entry.category.main || 'ไม่ระบุ';
                const sub1 = entry.category.sub1 || 'ไม่ระบุ';
                const sub2 = entry.category.sub2 || 'ไม่ระบุ';
                
                categoryHTML += `<span class="category-segment">${main}</span>`;
                categoryHTML += `<span class="category-segment">${sub1}</span>`;
                categoryHTML += `<span class="category-segment">${sub2}</span>`;
            } else {
                categoryHTML += '<span class="category-segment">ไม่ระบุหมวดหมู่</span>';
            }
            
            categoryHTML += '</div>';
            
            // ทำให้การแสดงคะแนนดูดีขึ้น
            const scoreHTML = `
                <div class="score-display">
                    ${entry.score || 0}/${entry.totalQuestions || 0}
                    <small>(${entry.percentage || 0}%)</small>
                </div>
            `;
            
            // คำนวณเลขลำดับตามหน้าปัจจุบัน
            const itemNumber = startIndex + index + 1;
            
            // สร้าง HTML สำหรับวันที่และเวลา
            const dateTimeHTML = `
                <div class="date-time">
                    <span class="date-display">${formattedDate}</span>
                    <span class="time-display">${formattedTime}</span>
                </div>
            `;
            
            historyHTML += `
                    <tr data-id="${entry.id}" class="history-row clickable-row" onclick="showGameDetails('${entry.id}')">
                    <td>${itemNumber}</td>
                    <td><div class="player-name" title="${entry.playerName || 'ไม่ระบุชื่อ'}">${entry.playerName || 'ไม่ระบุชื่อ'}</div></td>
                    <td>${scoreHTML}</td>
                    <td>${categoryHTML}</td>
                    <td>${dateTimeHTML}</td>
                    <td class="action-cell">
                        <button class="delete-history-btn small-btn" onclick="confirmDeleteHistory('${entry.id}')">ลบ</button>
                    </td>
                </tr>
            `;
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการแสดงประวัติรายการที่", index, error);
            historyHTML += `
                <tr>
                    <td colspan="6">เกิดข้อผิดพลาดในการแสดงประวัติรายการนี้</td>
                </tr>
            `;
        }
    });
    
    historyHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    // แสดงผล
    historyContainer.innerHTML = historyHTML;
    
    // อัพเดตเพจเนชั่น
    updateHistoryPagination();
    
    // แสดงส่วนเพจเนชั่นและตัวเลือกจำนวนรายการ
    const paginationElement = document.getElementById('history-pagination');
    const perPageElement = document.getElementById('history-items-per-page');
    
    if (paginationElement) paginationElement.style.display = 'flex';
    if (perPageElement) perPageElement.style.display = 'flex';
    
    console.log("แสดงประวัติการเล่นเรียบร้อยแล้ว:", currentPageItems.length, "รายการ");
    return true;
}

// ฟังก์ชันอัพเดต pagination
function updateHistoryPagination() {
    const paginationContainer = document.getElementById('history-pagination');
    const totalPages = Math.ceil(filteredHistory.length / historyItemsPerPage);
    
    // ไม่มีข้อมูลหรือมีข้อมูลน้อยกว่า 1 หน้า
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // ปุ่มก่อนหน้า
    paginationHTML += `
        <button class="history-page-btn ${currentHistoryPage === 1 ? 'disabled' : ''}" 
                onclick="goToHistoryPage(${currentHistoryPage - 1})" 
                ${currentHistoryPage === 1 ? 'disabled' : ''}>
            &laquo;
        </button>
    `;
    
    // จำนวนปุ่มที่แสดง
    let startPage = Math.max(1, currentHistoryPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    // ปรับจำนวนปุ่มให้แสดงครบ 5 ปุ่ม (ถ้ามีมากพอ)
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    
    // สร้างปุ่มตัวเลข
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="history-page-btn ${i === currentHistoryPage ? 'active' : ''}" 
                    onclick="goToHistoryPage(${i})">
                ${i}
            </button>
        `;
    }
    
    // ปุ่มถัดไป
    paginationHTML += `
        <button class="history-page-btn ${currentHistoryPage === totalPages ? 'disabled' : ''}" 
                onclick="goToHistoryPage(${currentHistoryPage + 1})" 
                ${currentHistoryPage === totalPages ? 'disabled' : ''}>
            &raquo;
        </button>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

// ฟังก์ชันเปลี่ยนหน้า
function goToHistoryPage(page) {
    if (page < 1 || page > Math.ceil(filteredHistory.length / historyItemsPerPage)) {
        return;
    }
    
    currentHistoryPage = page;
    displayGameHistory();
}

// แก้ไขฟังก์ชัน filterGameHistory()
function filterGameHistory() {
    // ดึงค่าจากฟอร์ม
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;
    const playerName = document.getElementById('filter-player-name').value.trim().toLowerCase();
    const mainCategory = document.getElementById('filter-history-main-category').value;
    const sub1Category = document.getElementById('filter-history-sub1-category').value;
    const sub2Category = document.getElementById('filter-history-sub2-category').value;
    
    // เริ่มจากประวัติทั้งหมด
    filteredHistory = [...gameHistory];
    
    // กรองตามวันที่เริ่มต้น
    if (dateFrom) {
        const fromDate = new Date(dateFrom);
        fromDate.setHours(0, 0, 0, 0);
        filteredHistory = filteredHistory.filter(entry => {
            const playedDate = new Date(entry.playedAt);
            return playedDate >= fromDate;
        });
    }
    
    // กรองตามวันที่สิ้นสุด
    if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
        filteredHistory = filteredHistory.filter(entry => {
            const playedDate = new Date(entry.playedAt);
            return playedDate <= toDate;
        });
    }
    
    // กรองตามชื่อผู้เล่น
    if (playerName) {
        filteredHistory = filteredHistory.filter(entry => 
            entry.playerName && entry.playerName.toLowerCase().includes(playerName)
        );
    }
    
    // กรองตามหมวดหมู่หลัก
    if (mainCategory) {
        filteredHistory = filteredHistory.filter(entry => 
            entry.category && entry.category.main === mainCategory
        );
        
        // กรองตามหมวดหมู่ย่อย 1
        if (sub1Category) {
            filteredHistory = filteredHistory.filter(entry => 
                entry.category && entry.category.sub1 === sub1Category
            );
            
            // กรองตามหมวดหมู่ย่อย 2
            if (sub2Category) {
                filteredHistory = filteredHistory.filter(entry => 
                    entry.category && entry.category.sub2 === sub2Category
                );
            }
        }
    }
    
    // รีเซ็ตหน้าปัจจุบัน
    currentHistoryPage = 1;
    
    // แสดงผลใหม่
    displayGameHistory();
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่ในตัวกรอง
function updateHistoryCategoryFilter() {
    const categorySelect = document.getElementById('filter-history-category');
    if (!categorySelect) return;
    
    // เก็บตัวเลือกแรกไว้
    const firstOption = categorySelect.options[0];
    categorySelect.innerHTML = '';
    categorySelect.appendChild(firstOption);
    
    // รวบรวมหมวดหมู่ที่มีในประวัติ
    const uniqueCategories = new Set();
    gameHistory.forEach(entry => {
        if (entry.category && entry.category.main) {
            uniqueCategories.add(entry.category.main);
        }
    });
    
    // เพิ่มหมวดหมู่ทั้งหมดในรายการ
    for (const mainCategory in categories) {
        // เพิ่มเฉพาะหมวดหมู่ที่มีในประวัติ
        if (uniqueCategories.has(mainCategory)) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            categorySelect.appendChild(option);
        }
    }
}

// ฟังก์ชันเริ่มต้นระบบประวัติการเล่น
function initHistorySystem() {
    console.log("กำลังเริ่มต้นระบบประวัติการเล่น...");
    
    // สร้างตัวแปรเริ่มต้นถ้ายังไม่มี
    if (typeof currentHistoryPage !== 'number' || isNaN(currentHistoryPage)) {
        currentHistoryPage = 1;
    }
    
    if (typeof historyItemsPerPage !== 'number' || isNaN(historyItemsPerPage)) {
        historyItemsPerPage = 10;
    }
    
    // โหลดประวัติการเล่น
    try {
        const savedHistory = localStorage.getItem('quiz-game-history');
        if (savedHistory) {
            gameHistory = JSON.parse(savedHistory);
            console.log("โหลดประวัติการเล่นสำเร็จ:", gameHistory.length, "รายการ");
        } else {
            gameHistory = [];
            console.log("ไม่พบประวัติการเล่น สร้างอาเรย์ใหม่");
            localStorage.setItem('quiz-game-history', JSON.stringify(gameHistory));
        }
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการโหลดประวัติการเล่น:", error);
        gameHistory = [];
        localStorage.setItem('quiz-game-history', JSON.stringify(gameHistory));
    }
    
    // กำหนดค่าเริ่มต้นให้กับ filteredHistory
    filteredHistory = [...gameHistory];
    
    // ตรวจสอบและปรับปรุงส่วนตัวกรองในหน้าประวัติ
    updateHistoryFilterSection();
    
    // อัพเดตตัวกรองหมวดหมู่จากโครงสร้างหมวดหมู่ที่มีอยู่
    updateHistoryCategoryFilters();
    
    // เพิ่มปุ่มลบประวัติทั้งหมดในส่วนหัวของหน้าประวัติ
    addClearAllHistoryButton();
    
    // เพิ่มสไตล์สำหรับตารางประวัติการเล่น
    addHistoryTableStyles();
    
    // เพิ่มสไตล์สำหรับปุ่มลบและหน้าต่างยืนยัน
    addHistoryDeleteStyles();
    
    // ตั้งค่า event listeners สำหรับปุ่มต่างๆ
    setupHistoryEventListeners();
    
    // แสดงประวัติ
    try {
        displayGameHistory();
        
        // ตั้งค่าเริ่มต้นจำนวนรายการทั้งหมด
const totalHistoryCount = document.getElementById('total-history-count');
if (totalHistoryCount) {
    totalHistoryCount.textContent = ` ${filteredHistory.length}`;
}
        
        console.log("แสดงประวัติการเล่นครั้งแรกเรียบร้อยแล้ว");
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการแสดงประวัติการเล่น:", error);
    }
    
    console.log("ระบบประวัติการเล่นพร้อมใช้งานแล้ว");
    return true;
}

// แทนที่ฟังก์ชัน deleteHistoryEntry ทั้งหมด
async function deleteHistoryEntry(id) {
    // ตรวจสอบว่าประวัติการเล่นมีหรือไม่
    if (!Array.isArray(gameHistory) || gameHistory.length === 0) {
        console.error("ไม่มีประวัติการเล่นในระบบ");
        return false;
    }
    
    // หาข้อมูลประวัติที่จะลบ
    const historyToDelete = gameHistory.find(entry => entry.id === id);
    if (!historyToDelete) {
        console.error("ไม่พบประวัติการเล่นที่ต้องการลบ");
        alert("ไม่พบประวัติการเล่นที่ต้องการลบ");
        return false;
    }
    
    try {
        // ลบจาก Supabase Database
        const { error } = await supabaseClient
            .from('game_history')
            .delete()
            .eq('id', id);
        
        if (error) {
            console.error('เกิดข้อผิดพลาดในการลบประวัติจาก Database:', error);
            alert('เกิดข้อผิดพลาดในการลบประวัติ: ' + error.message);
            return false;
        }
        
        console.log('ลบประวัติจาก Database สำเร็จ ID:', id);
        
        // ลบออกจาก gameHistory (ในหน่วยความจำ)
        gameHistory = gameHistory.filter(entry => entry.id !== id);
        
        // ลบออกจาก filteredHistory ด้วย
        filteredHistory = filteredHistory.filter(entry => entry.id !== id);
        
        // บันทึกการเปลี่ยนแปลงลง localStorage (สำหรับ sync)
        localStorage.setItem('quiz-game-history', JSON.stringify(gameHistory));
        
        // อัพเดตการแสดงผล
        currentHistoryPage = 1; // รีเซ็ตไปที่หน้าแรก
        displayGameHistory();
        
        console.log("ลบประวัติการเล่นเรียบร้อยแล้ว");
        return true;
        
    } catch (error) {
        console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
        return false;
    }
}

// แทนที่ฟังก์ชัน clearAllHistory ทั้งหมด
async function clearAllHistory() {
    // ตรวจสอบว่ามีประวัติการเล่นหรือไม่
    if (!Array.isArray(gameHistory) || gameHistory.length === 0) {
        alert("ไม่มีประวัติการเล่นในระบบ");
        return false;
    }
    
    try {
        // ลบประวัติทั้งหมดจาก Supabase Database
        const { error } = await supabaseClient
            .from('game_history')
            .delete()
            .neq('id', 0); // ลบทั้งหมด (neq คือ not equal, ใช้เงื่อนไขที่เป็นจริงเสมอ)
        
        if (error) {
            console.error('เกิดข้อผิดพลาดในการลบประวัติทั้งหมดจาก Database:', error);
            alert('เกิดข้อผิดพลาดในการลบประวัติทั้งหมด: ' + error.message);
            return false;
        }
        
        console.log('ลบประวัติทั้งหมดจาก Database สำเร็จ');
        
        // รีเซ็ตตัวแปรระบบ
        gameHistory = [];
        filteredHistory = [];
        currentHistoryPage = 1;
        
        // บันทึกการเปลี่ยนแปลงลง localStorage
        localStorage.setItem('quiz-game-history', JSON.stringify(gameHistory));
        
        // อัพเดตการแสดงผล
        displayGameHistory();
        
        console.log("ลบประวัติการเล่นทั้งหมดเรียบร้อยแล้ว");
        return true;
        
    } catch (error) {
        console.error('เกิดข้อผิดพลาดที่ไม่คาดคิดในการลบประวัติทั้งหมด:', error);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
        return false;
    }
}

// แทนที่ฟังก์ชัน confirmDeleteHistory ทั้งหมด - เพิ่ม confirmation ที่ชัดเจนขึ้น
function confirmDeleteHistory(id) {
    // ป้องกันการกระจายของ event
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // ตรวจสอบว่ามี id หรือไม่
    if (!id) {
        console.error("ไม่มี id สำหรับลบประวัติการเล่น");
        return false;
    }
    
    // ค้นหาข้อมูลของประวัติที่จะลบ
    const historyToDelete = filteredHistory.find(entry => entry.id === id);
    if (!historyToDelete) {
        console.error("ไม่พบประวัติการเล่นที่ต้องการลบ");
        return false;
    }
    
    // สร้างและแสดงหน้าต่างยืนยัน
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'confirm-dialog-overlay';
    confirmDialog.innerHTML = `
        <div class="confirm-dialog">
            <div class="confirm-header">
                <h3>⚠️ ยืนยันการลบประวัติ</h3>
                <button class="close-btn" onclick="closeConfirmDialog()">&times;</button>
            </div>
            <div class="confirm-body">
                <p><strong>คุณต้องการลบประวัติการเล่นนี้ใช่หรือไม่?</strong></p>
                <div style="margin: 15px 0; padding: 10px; background-color: #f0f7ff; border-radius: 6px; border-left: 4px solid #1976d2;">
                    <p><strong>ผู้เล่น:</strong> ${historyToDelete.playerName}</p>
                    <p><strong>คะแนน:</strong> ${historyToDelete.score}/${historyToDelete.totalQuestions} (${historyToDelete.percentage}%)</p>
                    <p><strong>วันที่:</strong> ${formatDateTime24Hour(historyToDelete.playedAt).full}</p>
                </div>
                <p style="color: #f44336; font-weight: 600;">⚠️ การลบนี้จะลบข้อมูลออกจากฐานข้อมูลถาวร และไม่สามารถเรียกคืนได้</p>
            </div>
            <div class="confirm-actions">
                <button class="confirm-delete-btn" onclick="performDeleteHistory('${id}')">🗑️ ยืนยันการลบ</button>
                <button class="cancel-btn" onclick="closeConfirmDialog()">❌ ยกเลิก</button>
            </div>
        </div>
    `;
    
    // เพิ่มหน้าต่างยืนยันเข้าไปใน DOM
    document.body.appendChild(confirmDialog);
    
    return true;
}

// แทนที่ฟังก์ชัน confirmClearAllHistory ทั้งหมด - เพิ่ม confirmation ที่รุนแรงขึ้น
function confirmClearAllHistory() {
    // ป้องกันการกระจายของ event
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // ตรวจสอบว่ามีประวัติการเล่นหรือไม่
    if (!Array.isArray(gameHistory) || gameHistory.length === 0) {
        alert("ไม่มีประวัติการเล่นในระบบ");
        return false;
    }
    
    // สร้างและแสดงหน้าต่างยืนยัน
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'confirm-dialog-overlay';
    confirmDialog.innerHTML = `
        <div class="confirm-dialog">
            <div class="confirm-header">
                <h3>🚨 ยืนยันการลบประวัติทั้งหมด</h3>
                <button class="close-btn" onclick="closeConfirmDialog()">&times;</button>
            </div>
            <div class="confirm-body">
                <p><strong>คุณต้องการลบประวัติการเล่นทั้งหมด ${gameHistory.length} รายการ ใช่หรือไม่?</strong></p>
                
                <div style="margin: 15px 0; padding: 15px; background-color: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                    <p><strong>📊 ข้อมูลที่จะถูกลบ:</strong></p>
                    <p>• ประวัติการเล่นทั้งหมด: ${gameHistory.length} รายการ</p>
                    <p>• ข้อมูลคะแนนและเวลาการเล่น</p>
                    <p>• รายละเอียดคำถามและคำตอบ</p>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background-color: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                    <p style="color: #f44336; font-weight: 600; margin: 0;">
                        🚨 <strong>คำเตือนสำคัญ:</strong> การดำเนินการนี้จะลบข้อมูลออกจากฐานข้อมูลถาวร 
                        และ<u>ไม่สามารถยกเลิกหรือเรียกคืนได้</u>
                    </p>
                </div>
                
                <div style="margin: 15px 0; padding: 10px; background-color: #f5f5f5; border-radius: 6px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="confirm-delete-checkbox" style="margin-right: 8px;">
                        <span>ฉันเข้าใจและยืนยันว่าต้องการลบประวัติทั้งหมดอย่างถาวร</span>
                    </label>
                </div>
            </div>
            <div class="confirm-actions">
                <button class="confirm-delete-btn" id="final-delete-btn" onclick="performClearAllHistory()" disabled>🗑️ ลบประวัติทั้งหมด</button>
                <button class="cancel-btn" onclick="closeConfirmDialog()">❌ ยกเลิก</button>
            </div>
        </div>
    `;
    
    // เพิ่มหน้าต่างยืนยันเข้าไปใน DOM
    document.body.appendChild(confirmDialog);
    
    // เพิ่ม event listener สำหรับ checkbox
    setTimeout(() => {
        const checkbox = document.getElementById('confirm-delete-checkbox');
        const deleteBtn = document.getElementById('final-delete-btn');
        
        if (checkbox && deleteBtn) {
            checkbox.addEventListener('change', function() {
                deleteBtn.disabled = !this.checked;
                if (this.checked) {
                    deleteBtn.style.backgroundColor = '#f44336';
                    deleteBtn.style.cursor = 'pointer';
                } else {
                    deleteBtn.style.backgroundColor = '#ccc';
                    deleteBtn.style.cursor = 'not-allowed';
                }
            });
        }
    }, 100);
    
    return true;
}

// ฟังก์ชันปิดหน้าต่างยืนยัน
function closeConfirmDialog() {
    const dialogs = document.querySelectorAll('.confirm-dialog-overlay');
    dialogs.forEach(dialog => {
        dialog.remove();
    });
}

// ฟังก์ชันใหม่สำหรับการลบจริง (แยกออกจาก confirmation)
async function performDeleteHistory(id) {
    closeConfirmDialog();
    
    // แสดง loading
    const loadingMsg = document.createElement('div');
    loadingMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 10000;
    `;
    loadingMsg.textContent = '🗑️ กำลังลบประวัติ...';
    document.body.appendChild(loadingMsg);
    
    const success = await deleteHistoryEntry(id);
    
    // ลบ loading message
    loadingMsg.remove();
    
    if (success) {
        // แสดงข้อความสำเร็จ
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: 600;
        `;
        successMsg.textContent = '✅ ลบประวัติเรียบร้อยแล้ว';
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
            successMsg.remove();
        }, 3000);
    }
}

// ฟังก์ชันใหม่สำหรับการลบทั้งหมดจริง
async function performClearAllHistory() {
    closeConfirmDialog();
    
    // แสดง loading
    const loadingMsg = document.createElement('div');
    loadingMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 10000;
        text-align: center;
    `;
    loadingMsg.innerHTML = '🗑️ กำลังลบประวัติทั้งหมด...<br><small>โปรดรอสักครู่</small>';
    document.body.appendChild(loadingMsg);
    
    const success = await clearAllHistory();
    
    // ลบ loading message
    loadingMsg.remove();
    
    if (success) {
        // แสดงข้อความสำเร็จ
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: 600;
        `;
        successMsg.textContent = '✅ ลบประวัติทั้งหมดเรียบร้อยแล้ว';
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
            successMsg.remove();
        }, 4000);
    }
}

// ฟังก์ชันเพิ่มปุ่มลบประวัติทั้งหมดในส่วนหัวของหน้าประวัติ
function addClearAllHistoryButton() {
    const historySection = document.querySelector('.history-section');
    if (!historySection) return;
    
    const sectionHeader = historySection.querySelector('.section-header');
    if (!sectionHeader) return;
    
    // ตรวจสอบว่ามีปุ่มลบทั้งหมดอยู่แล้วหรือไม่
    if (sectionHeader.querySelector('#clear-all-history')) return;
    
    // สร้างปุ่มลบประวัติทั้งหมด
    const clearAllBtn = document.createElement('button');
    clearAllBtn.id = 'clear-all-history';
    clearAllBtn.className = 'delete-btn clear-all-history-btn';
    clearAllBtn.innerHTML = 'ลบประวัติทั้งหมด';
    clearAllBtn.addEventListener('click', confirmClearAllHistory);
    
    // เพิ่มปุ่มเข้าไปในส่วนหัว
    sectionHeader.appendChild(clearAllBtn);
}

// เพิ่ม CSS สำหรับสไตล์ของปุ่มลบและหน้าต่างยืนยัน
function addHistoryDeleteStyles() {
    // ตรวจสอบว่ามี style อยู่แล้วหรือไม่
    if (document.getElementById('history-delete-styles')) return;
    
    const styleElement = document.createElement('style');
    styleElement.id = 'history-delete-styles';
    styleElement.textContent = `
        /* สไตล์ปุ่มลบในตาราง */
        .delete-history-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }
        
        .delete-history-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* สไตล์ปุ่มลบทั้งหมด */
        .clear-all-history-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .clear-all-history-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* สไตล์หน้าต่างยืนยันการลบ */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-dialog {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .confirm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f44336;
            color: white;
        }
        
        .confirm-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .confirm-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }
        
        .confirm-body {
            padding: 20px;
        }
        
        .confirm-body p {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .warning-text {
            color: #f44336;
        }
        
        .confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px 20px;
            background-color: #f5f5f5;
        }
        
        .confirm-delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .confirm-delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .cancel-btn {
            background-color: #e0e0e0;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cancel-btn:hover {
            background-color: #d5d5d5;
        }
        
        /* ปรับการแสดงผลบนมือถือ */
        @media (max-width: 768px) {
            .confirm-actions {
                flex-direction: column;
            }
            
            .confirm-delete-btn, .cancel-btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .action-cell {
                text-align: center;
            }
        }
    `;
    
    document.head.appendChild(styleElement);
}

// ฟังก์ชันปรับแต่งสไตล์ตารางประวัติการเล่น
function addHistoryTableStyles() {
    // ตรวจสอบว่ามี style อยู่แล้วหรือไม่
    if (document.getElementById('history-table-styles')) return;
    
    const styleElement = document.createElement('style');
    styleElement.id = 'history-table-styles';
    styleElement.textContent = `

        /* ปรับปรุงส่วนหัวของหน้าประวัติการเล่น */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .total-history-count {
            font-size: 14px;
            color: #666;
            background-color: #f0f7ff;
            padding: 4px 12px;
            border-radius: 16px;
            border: 1px solid rgba(25, 118, 210, 0.2);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }

        .items-per-page-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f8f9fa;
            padding: 6px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
                        
        .history-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .history-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .history-table tbody tr:hover {
            background-color: #f5f9ff;
        }
        
        .history-table td {
            padding: 15px 20px;
            color: #333;
            font-size: 14px;
            vertical-align: middle;
        }
        
        /* กำหนดความกว้างของแต่ละคอลัมน์ - ปรับความกว้างคอลัมน์ */
        .history-table th:nth-child(1), 
        .history-table td:nth-child(1) {
            width: 8%;
            text-align: center;
            min-width: 50px;
            max-width: 60px;
        }
        
        /* ปรับความกว้างช่องชื่อผู้เล่น - ลดลงจาก 20% เหลือ 15% */
        .history-table th:nth-child(2), 
        .history-table td:nth-child(2) {
            width: 15%;
            min-width: 100px;
            max-width: 130px;
        }
        
        /* เพิ่มสไตล์สำหรับช่องชื่อผู้เล่น */
        .history-table td:nth-child(2) {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .history-table th:nth-child(3), 
        .history-table td:nth-child(3) {
            width: 15%;
            text-align: center;
            min-width: 100px;
        }
        
        /* เพิ่มพื้นที่ให้กับช่องหมวดหมู่ */
        .history-table th:nth-child(4), 
        .history-table td:nth-child(4) {
            width: 40%;
            min-width: 200px;
        }
        
        /* คอลัมน์วันที่และเวลา */
        .history-table th:nth-child(5), 
        .history-table td:nth-child(5) {
            width: 12%;
            white-space: nowrap;
            min-width: 100px;
            max-width: 120px;
        }
        
        /* คอลัมน์การจัดการ */
.history-table th:nth-child(6), 
.history-table td:nth-child(6) {
    width: 12%;
    text-align: center;
    min-width: 80px;
    max-width: 100px;
}
        
        /* สไตล์สำหรับแสดงคะแนนให้ดูดีขึ้น */
        .history-table .score-display {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(25, 118, 210, 0.1);
            color: #1976d2;
            font-weight: 600;
        }
        
        /* สไตล์สำหรับแสดงชื่อผู้เล่น */
        .history-table .player-name {
            display: inline-flex;
            align-items: center;
            padding: 2px 0;
            color: #333;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* สไตล์สำหรับแสดงหมวดหมู่ให้ดูดีขึ้น */
        .history-table .category-path {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .history-table .category-segment {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #f0f7ff;
            color: #1976d2;
            font-size: 13px;
            font-weight: 500;
            margin-right: 3px;
        }
        
        .history-table .category-segment:first-child {
            background-color: rgba(25, 118, 210, 0.15);
            font-weight: 600;
        }
        
        .history-table .category-segment:last-child {
            background-color: #e8f5e9;
            color: #4caf50;
        }
        
        /* ปรับปรุงการแสดงวันที่และเวลาให้กระชับ */
        .history-table .date-time {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 13px;
        }
        
        .history-table .date-display {
            font-weight: 500;
            white-space: nowrap;
        }
        
        .history-table .time-display {
            color: #757575;
            font-size: 12px;
            white-space: nowrap;
        }
        
        /* ปรับการแสดงผลบนมือถือ */
        @media (max-width: 768px) {
            .history-table {
                border-radius: 0;
            }
            
            .history-table th, 
            .history-table td {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            .history-table th:nth-child(1), 
            .history-table td:nth-child(1) {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
                padding-left: 8px;
                padding-right: 8px;
            }
            
            /* ปรับช่องชื่อผู้เล่นบนมือถือ */
            .history-table th:nth-child(2), 
            .history-table td:nth-child(2) {
                min-width: 80px;
                max-width: 100px;
            }
            
            .history-table th:nth-child(5), 
            .history-table td:nth-child(5) {
                min-width: 80px;
                max-width: 90px;
            }
            
            .history-table th:nth-child(6), 
            .history-table td:nth-child(6) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
                padding-left: 5px;
                padding-right: 5px;
            }
            
            /* ปรับรูปแบบการแสดงวันที่/เวลาบนมือถือ */
            .history-table .date-time {
                font-size: 12px;
            }
            
            .history-table .date-display,
            .history-table .time-display {
                font-size: 11px;
            }
        }
/* แก้ไขการแสดงผลส่วนหัว */
.section-title-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.total-history-count {
    white-space: nowrap;
    flex-shrink: 0;
}
    `;
    
    document.head.appendChild(styleElement);
}

function updateHistoryFilterSection() {
    const filterForm = document.querySelector('.filter-form');
    if (!filterForm) return;
    
    // ปรับปรุง HTML ของส่วนตัวกรอง - แบบเรียบง่ายและดูดี
    filterForm.innerHTML = `
        <div class="filter-container">
            <!-- ส่วนกรองตามวันที่ -->
            <div class="filter-row">
                <div class="filter-group date-group">
                    <div class="filter-label">ช่วงเวลา:</div>
                    <div class="date-inputs">
                        <div class="date-field">
                            <input type="date" id="filter-date-from" class="date-input" placeholder="เริ่มต้น">
                        </div>
                        <span class="date-separator">-</span>
                        <div class="date-field">
                            <input type="date" id="filter-date-to" class="date-input" placeholder="สิ้นสุด">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ส่วนค้นหาชื่อผู้เล่น -->
            <div class="filter-row">
                <div class="filter-group search-group">
                    <div class="filter-label">ชื่อผู้เล่น:</div>
                    <div class="search-field">
                        <input type="text" id="filter-player-name" class="search-input" placeholder="พิมพ์ชื่อผู้เล่นที่ต้องการค้นหา">
                        <span class="search-icon">🔍</span>
                    </div>
                </div>
            </div>
            
            <!-- ส่วนกรองตามหมวดหมู่ -->
            <div class="filter-row">
                <div class="filter-group category-group">
                    <div class="filter-label">หมวดหมู่:</div>
                    <div class="category-selects">
                        <div class="select-field">
                            <select id="filter-history-main-category" class="filter-select">
                                <option value="">ทุกหมวดหมู่</option>
                            </select>
                            <span class="select-arrow"></span>
                        </div>
                        <div class="select-field">
                            <select id="filter-history-sub1-category" class="filter-select" disabled>
                                <option value="">ทุกหมวดหมู่ย่อย 1</option>
                            </select>
                            <span class="select-arrow"></span>
                        </div>
                        <div class="select-field">
                            <select id="filter-history-sub2-category" class="filter-select" disabled>
                                <option value="">ทุกหมวดหมู่ย่อย 2</option>
                            </select>
                            <span class="select-arrow"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ปุ่มใช้งาน -->
            <div class="filter-row filter-actions-row">
                <button id="apply-history-filter" class="filter-button primary-button">ค้นหา</button>
                <button id="reset-history-filter" class="filter-button secondary-button">รีเซ็ต</button>
            </div>
        </div>
    `;
    
    // เพิ่ม CSS สำหรับตัวกรองแบบใหม่
    const style = document.createElement('style');
    style.textContent = `
        /* สไตล์หลักของฟอร์มกรอง */
        .filter-form {
            background-color: #f9fbff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e0e7f4;
            margin-top: 15px;
        }
        
        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* แถวของแต่ละส่วนตัวกรอง */
        .filter-row {
            display: flex;
            margin-bottom: 2px;
        }
        
        /* กลุ่มตัวกรอง */
        .filter-group {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        
        /* ป้ายกำกับตัวกรอง */
        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #485460;
            margin-right: 15px;
            min-width: 80px;
        }
        
        /* ส่วนตัวกรองวันที่ */
        .date-inputs {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 10px;
        }
        
        .date-field {
            flex: 1;
        }
        
        .date-separator {
            color: #9aa5b1;
            font-weight: 500;
            margin: 0 5px;
        }
        
        .date-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d0d9e4;
            border-radius: 6px;
            font-size: 14px;
            background-color: #f8f9fb;
            transition: all 0.2s ease;
        }
        
        .date-input:focus {
            border-color: #4791db;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(71, 145, 219, 0.15);
            outline: none;
        }
        
        /* ส่วนค้นหาชื่อผู้เล่น */
        .search-field {
            position: relative;
            flex: 1;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            padding-right: 35px; /* ให้พื้นที่สำหรับไอคอนค้นหา */
            border: 1px solid #d0d9e4;
            border-radius: 6px;
            font-size: 14px;
            background-color: #f8f9fb;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: #4791db;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(71, 145, 219, 0.15);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9aa5b1;
            font-size: 14px;
        }
        
        /* ส่วนกรองตามหมวดหมู่ */
        .category-selects {
            display: flex;
            flex: 1;
            gap: 10px;
        }
        
        .select-field {
            position: relative;
            flex: 1;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            padding-right: 30px; /* ให้พื้นที่สำหรับลูกศร */
            border: 1px solid #d0d9e4;
            border-radius: 6px;
            font-size: 14px;
            background-color: #f8f9fb;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            border-color: #4791db;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(71, 145, 219, 0.15);
            outline: none;
        }
        
        .filter-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f0f2f5;
        }
        
        .select-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #9aa5b1;
            pointer-events: none;
        }
        
        /* ปุ่มกระทำ */
        .filter-actions-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 5px;
        }
        
        .filter-button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .primary-button {
            background-color: #1976d2;
            color: white;
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.25);
        }
        
        .primary-button:hover {
            background-color: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }
        
        .secondary-button {
            background-color: #e8eef7;
            color: #485460;
        }
        
        .secondary-button:hover {
            background-color: #d9e2f1;
            transform: translateY(-1px);
        }
        
        /* ปรับแต่งสำหรับอุปกรณ์มือถือ */
        @media (max-width: 768px) {
            .filter-form {
                padding: 12px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                padding: 12px;
            }
            
            .filter-label {
                margin-right: 0;
                margin-bottom: 8px;
                min-width: auto;
            }
            
            .date-inputs,
            .category-selects {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .filter-actions-row {
                flex-direction: column;
                margin-top: 8px;
            }
            
            .filter-button {
                width: 100%;
            }
        }
    `;
    
    document.head.appendChild(style);
    
    // อัพเดตตัวกรองหมวดหมู่
    updateHistoryCategoryFilters();
}

function updateHistoryCategoryFilters() {
    // อัพเดตหมวดหมู่หลักก่อน
    updateHistoryMainCategory();
    
    // ตั้งค่า Event Listeners สำหรับตัวเลือกหมวดหมู่
    setupCategoryFilterListeners();
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่หลัก
function updateHistoryMainCategory() {
    const categorySelect = document.getElementById('filter-history-main-category');
    if (!categorySelect) return;
    
    // เก็บตัวเลือกแรกไว้
    const firstOption = categorySelect.options[0];
    categorySelect.innerHTML = '';
    categorySelect.appendChild(firstOption);
    
    // รวบรวมหมวดหมู่ที่มีในประวัติ
    const uniqueCategories = new Set();
    gameHistory.forEach(entry => {
        if (entry.category && entry.category.main) {
            uniqueCategories.add(entry.category.main);
        }
    });
    
    // เพิ่มหมวดหมู่ทั้งหมดในรายการ
    for (const mainCategory in categories) {
        // เพิ่มเฉพาะหมวดหมู่ที่มีในประวัติ
        if (uniqueCategories.has(mainCategory)) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            categorySelect.appendChild(option);
        }
    }
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่ย่อย 1
function updateHistorySub1Category(mainCategory) {
    const sub1Select = document.getElementById('filter-history-sub1-category');
    if (!sub1Select) return;
    
    // ล้างตัวเลือกเดิม
    sub1Select.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 1</option>';
    
    // ถ้าไม่ได้เลือกหมวดหมู่หลัก ให้ปิดการใช้งาน
    if (!mainCategory) {
        sub1Select.disabled = true;
        return;
    }
    
    // เพิ่มหมวดหมู่ย่อย 1 จากโครงสร้างหมวดหมู่ที่มีอยู่
    if (categories[mainCategory]) {
        for (const sub1 in categories[mainCategory]) {
            const option = document.createElement('option');
            option.value = sub1;
            option.textContent = sub1;
            sub1Select.appendChild(option);
        }
    }
    
    // เปิดใช้งานตัวเลือก
    sub1Select.disabled = false;
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่ย่อย 2
function updateHistorySub2Category(mainCategory, sub1Category) {
    const sub2Select = document.getElementById('filter-history-sub2-category');
    if (!sub2Select) return;
    
    // ล้างตัวเลือกเดิม
    sub2Select.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
    
    // ถ้าไม่ได้เลือกหมวดหมู่หลักหรือหมวดหมู่ย่อย 1 ให้ปิดการใช้งาน
    if (!mainCategory || !sub1Category) {
        sub2Select.disabled = true;
        return;
    }
    
    // เพิ่มหมวดหมู่ย่อย 2 จากโครงสร้างหมวดหมู่ที่มีอยู่
    if (categories[mainCategory] && categories[mainCategory][sub1Category]) {
        for (const sub2 of categories[mainCategory][sub1Category]) {
            const option = document.createElement('option');
            option.value = sub2;
            option.textContent = sub2;
            sub2Select.appendChild(option);
        }
    }
    
    // เปิดใช้งานตัวเลือก
    sub2Select.disabled = false;
}

// ฟังก์ชันตั้งค่า Event Listeners สำหรับตัวเลือกหมวดหมู่
function setupCategoryFilterListeners() {
    const mainCategorySelect = document.getElementById('filter-history-main-category');
    const sub1CategorySelect = document.getElementById('filter-history-sub1-category');
    const sub2CategorySelect = document.getElementById('filter-history-sub2-category');
    
    if (mainCategorySelect) {
        // ลบ event listener เดิม (ถ้ามี)
        const newMainCategorySelect = mainCategorySelect.cloneNode(true);
        if (mainCategorySelect.parentNode) {
            mainCategorySelect.parentNode.replaceChild(newMainCategorySelect, mainCategorySelect);
        }
        
        // เพิ่ม event listener ใหม่
        newMainCategorySelect.addEventListener('change', function() {
            const mainCategory = this.value;
            
            // อัพเดตหมวดหมู่ย่อย 1
            updateHistorySub1Category(mainCategory);
            
            // รีเซ็ตหมวดหมู่ย่อย 2
            if (sub2CategorySelect) {
                sub2CategorySelect.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
                sub2CategorySelect.disabled = true;
            }
            
            // ใช้ตัวกรองใหม่ทันที
            filterGameHistory();
        });
    }
    
    if (sub1CategorySelect) {
        // ลบ event listener เดิม (ถ้ามี)
        const newSub1CategorySelect = sub1CategorySelect.cloneNode(true);
        if (sub1CategorySelect.parentNode) {
            sub1CategorySelect.parentNode.replaceChild(newSub1CategorySelect, sub1CategorySelect);
        }
        
        // เพิ่ม event listener ใหม่
        newSub1CategorySelect.addEventListener('change', function() {
            const mainCategory = document.getElementById('filter-history-main-category').value;
            const sub1Category = this.value;
            
            // อัพเดตหมวดหมู่ย่อย 2
            updateHistorySub2Category(mainCategory, sub1Category);
            
            // ใช้ตัวกรองใหม่ทันที
            filterGameHistory();
        });
    }
    
    if (sub2CategorySelect) {
        // ลบ event listener เดิม (ถ้ามี)
        const newSub2CategorySelect = sub2CategorySelect.cloneNode(true);
        if (sub2CategorySelect.parentNode) {
            sub2CategorySelect.parentNode.replaceChild(newSub2CategorySelect, sub2CategorySelect);
        }
        
        // เพิ่ม event listener ใหม่
        newSub2CategorySelect.addEventListener('change', function() {
            // ใช้ตัวกรองใหม่ทันที
            filterGameHistory();
        });
    }
}

// แก้ไขฟังก์ชัน setupHistoryEventListeners เพื่อเพิ่ม event listener สำหรับการรีเซ็ตตัวกรอง
function setupHistoryEventListeners() {
    const applyFilterBtn = document.getElementById('apply-history-filter');
    if (applyFilterBtn) {
        // ลบ event listener เดิม (ถ้ามี) และเพิ่มใหม่
        const newApplyFilterBtn = applyFilterBtn.cloneNode(true);
        if (applyFilterBtn.parentNode) {
            applyFilterBtn.parentNode.replaceChild(newApplyFilterBtn, applyFilterBtn);
        }
        
        newApplyFilterBtn.addEventListener('click', function() {
            try {
                filterGameHistory();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการกรองประวัติ:", error);
                alert("เกิดข้อผิดพลาดในการกรองประวัติ โปรดลองใหม่อีกครั้ง");
            }
        });
        console.log("ตั้งค่า event listener สำหรับปุ่มค้นหาประวัติเรียบร้อยแล้ว");
    }
    
    const resetFilterBtn = document.getElementById('reset-history-filter');
    if (resetFilterBtn) {
        // ลบ event listener เดิม (ถ้ามี) และเพิ่มใหม่
        const newResetFilterBtn = resetFilterBtn.cloneNode(true);
        if (resetFilterBtn.parentNode) {
            resetFilterBtn.parentNode.replaceChild(newResetFilterBtn, resetFilterBtn);
        }
        
        newResetFilterBtn.addEventListener('click', function() {
            try {
                // รีเซ็ตฟอร์มกรอง
                const fromDateInput = document.getElementById('filter-date-from');
                const toDateInput = document.getElementById('filter-date-to');
                const playerNameInput = document.getElementById('filter-player-name');
                const mainCategorySelect = document.getElementById('filter-history-main-category');
                const sub1CategorySelect = document.getElementById('filter-history-sub1-category');
                const sub2CategorySelect = document.getElementById('filter-history-sub2-category');
                
                if (fromDateInput) fromDateInput.value = '';
                if (toDateInput) toDateInput.value = '';
                if (playerNameInput) playerNameInput.value = '';
                if (mainCategorySelect) mainCategorySelect.value = '';
                if (sub1CategorySelect) {
                    sub1CategorySelect.value = '';
                    sub1CategorySelect.disabled = true;
                }
                if (sub2CategorySelect) {
                    sub2CategorySelect.value = '';
                    sub2CategorySelect.disabled = true;
                }
                
                // รีเซ็ตการกรอง
                filteredHistory = [...gameHistory];
                currentHistoryPage = 1;
                
                // แสดงผลใหม่
                displayGameHistory();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการรีเซ็ตตัวกรอง:", error);
            }
        });
        console.log("ตั้งค่า event listener สำหรับปุ่มรีเซ็ตการกรองเรียบร้อยแล้ว");
    }
    
    // เพิ่ม event listener สำหรับช่องค้นหาชื่อผู้เล่น (กรองทันทีเมื่อพิมพ์)
    const playerNameInput = document.getElementById('filter-player-name');
    if (playerNameInput) {
        let searchTimeout = null;
        playerNameInput.addEventListener('input', function() {
            // ยกเลิกตัวจับเวลาเดิม (ถ้ามี)
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // ตั้งตัวจับเวลาใหม่เพื่อรอให้หยุดพิมพ์ก่อนค้นหา
            searchTimeout = setTimeout(() => {
                filterGameHistory();
                searchTimeout = null;
            }, 500); // รอ 500ms หลังจากหยุดพิมพ์
        });
    }
    
    const historyPerPageSelect = document.getElementById('history-per-page');
    if (historyPerPageSelect) {
        // ลบ event listener เดิม (ถ้ามี) และเพิ่มใหม่
        const newHistoryPerPageSelect = historyPerPageSelect.cloneNode(true);
        if (historyPerPageSelect.parentNode) {
            historyPerPageSelect.parentNode.replaceChild(newHistoryPerPageSelect, historyPerPageSelect);
        }
        
        newHistoryPerPageSelect.addEventListener('change', function() {
            try {
                historyItemsPerPage = parseInt(this.value);
                if (isNaN(historyItemsPerPage) || historyItemsPerPage < 1) {
                    historyItemsPerPage = 10; // ค่าเริ่มต้นถ้าไม่ถูกต้อง
                }
                currentHistoryPage = 1;
                displayGameHistory();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเปลี่ยนจำนวนรายการต่อหน้า:", error);
            }
        });
        console.log("ตั้งค่า event listener สำหรับตัวเลือกจำนวนรายการต่อหน้าเรียบร้อยแล้ว");
    }
}

async function initializeApp() {
    console.log("กำลังเริ่มต้นแอปพลิเคชัน...");
    
    // 1. โหลดข้อมูลจาก Database และ localStorage
    await loadCategories();
    await loadQuestions();
    await loadGameHistory(); 
    
    // 2. ตั้งค่า event listeners สำหรับแท็บ
    setupTabNavigation();
    
    // 3. ตั้งค่าระบบผู้เล่น (ย้ายขึ้นมาก่อน)
    initPlayerSystem();
    
    // 4. ตั้งค่าระบบหมวดหมู่แบบใหม่
    await initCategorySystemNew();
    
    // 5. ตั้งค่าระบบคำถาม
    initQuestionSystem();
    
    // 6. ตั้งค่าระบบประวัติการเล่น
    initHistorySystem();
    
    // 7. ตั้งค่าระบบเล่นเกม
    initPlaySystem();
    
    // 8. ทำให้ระบบเล่นเกมรองรับหมวดหมู่
    enableCategoryPlaySystem();
    
    // 9. ตั้งค่าตัวกรองและการค้นหา
    setupCategoryFilter();
    setupSearchQuestions();
    
    // ตั้งค่าการแสดงผลแท็บเริ่มต้น
    setInitialTabState();
    
    // เริ่มต้นระบบแอดมิน
    initAdminSystem();

    console.log("เริ่มต้นแอปพลิเคชันเรียบร้อยแล้ว");
}

// เพิ่มฟังก์ชันใหม่นี้ถัดจาก initializeApp
function setInitialTabState() {
    // ตรวจสอบแท็บที่กำลังแสดงอยู่
    const activeTabs = document.querySelectorAll('.nav-tab.active');
    if (activeTabs.length > 0) {
        const activeTabId = activeTabs[0].id;
        
        // ซ่อนหน้า login ถ้าไม่ได้อยู่ในแท็บเล่นเกม
        const loginScreen = document.getElementById('login-screen');
        if (loginScreen) {
            if (activeTabId === 'play-tab') {
                // แสดงหน้า login ถ้ายังไม่ได้ login
                if (!currentPlayer) {
                    loginScreen.classList.remove('hidden');
                } else {
                    loginScreen.classList.add('hidden');
                    document.getElementById('start-screen').classList.remove('hidden');
                }
            } else {
                loginScreen.classList.add('hidden');
            }
        }
        
        // เพิ่ม class บน body เพื่อบอกว่ากำลังแสดงแท็บไหน
        document.body.className = 'active-tab-' + activeTabId.replace('-tab', '');
    }
}

// ฟังก์ชันสลับแท็บ - แก้ไขให้รองรับแอดมินแบบสมบูรณ์
function setupTabNavigation() {
    const createTab = document.getElementById('create-tab');
    const playTab = document.getElementById('play-tab');
    const historyTab = document.getElementById('history-tab');
    const createContent = document.getElementById('create-content');
    const playContent = document.getElementById('play-content');
    const historyContent = document.getElementById('history-content');
    const loginScreen = document.getElementById('login-screen');
    
    console.log("Tab elements:", {
        createTab: createTab ? "พบ" : "ไม่พบ", 
        playTab: playTab ? "พบ" : "ไม่พบ", 
        historyTab: historyTab ? "พบ" : "ไม่พบ", 
        createContent: createContent ? "พบ" : "ไม่พบ", 
        playContent: playContent ? "พบ" : "ไม่พบ", 
        historyContent: historyContent ? "พบ" : "ไม่พบ"
    });
    
    // ตรวจสอบว่ามีองค์ประกอบครบหรือไม่
    if (!createTab || !playTab || !historyTab || !createContent || !playContent || !historyContent) {
        console.error("ไม่พบ elements ของแท็บครบถ้วน - จะลองเรียกฟังก์ชันนี้อีกครั้งใน 300ms");
        setTimeout(setupTabNavigation, 300);
        return false;
    }
    
    // สลับไปที่แท็บสร้าง/แก้ไขคำถาม
    createTab.addEventListener('click', function() {
        console.log("กำลังสลับไปที่แท็บสร้าง/แก้ไขคำถาม");
        
        // เปลี่ยนคลาส active ของแท็บ
        createTab.classList.add('active');
        playTab.classList.remove('active');
        historyTab.classList.remove('active');
        
        // เปลี่ยนคลาส active ของเนื้อหา
        createContent.classList.add('active');
        playContent.classList.remove('active');
        historyContent.classList.remove('active');
        
        // ซ่อนหน้าล็อกอินเมื่อสลับไปแท็บสร้าง/แก้ไขคำถาม
        if (loginScreen) loginScreen.classList.add('hidden');
        
        // เพิ่มคลาสเพื่อระบุแท็บที่กำลังแสดง
        document.body.className = 'active-tab-create';
    });

    // สลับไปที่แท็บเล่นเกม - แก้ไขให้รองรับแอดมินสมบูรณ์
    playTab.addEventListener('click', function() {
        console.log("กำลังสลับไปที่แท็บเล่นเกม");
        
        // เปลี่ยนคลาส active ของแท็บ
        createTab.classList.remove('active');
        playTab.classList.add('active');
        historyTab.classList.remove('active');
        
        // เปลี่ยนคลาส active ของเนื้อหา
        createContent.classList.remove('active');
        playContent.classList.add('active');
        historyContent.classList.remove('active');
        
        // เพิ่มคลาสเพื่อระบุแท็บที่กำลังแสดง
        document.body.className = 'active-tab-play';
        
        // ตรวจสอบโหมดแอดมิน
        if (isAdminMode && adminProfile) {
            console.log("อยู่ในโหมดแอดมิน - ข้ามหน้าล็อกอิน");
            
            // ซ่อนหน้าล็อกอิน
            if (loginScreen) loginScreen.classList.add('hidden');
            
            // ตั้งค่าผู้เล่นเป็นแอดมิน (ถ้ายังไม่มี)
            if (!currentPlayer) {
                currentPlayer = {
                    name: adminProfile.name || 'Admin',
                    loginTime: new Date().toISOString(),
                    avatar: '👑'
                };
                console.log("ตั้งค่า currentPlayer เป็นแอดมิน:", currentPlayer);
            }
            
            // แสดงหน้าเล่นเกมและเลือกหมวดหมู่
            const startScreen = document.getElementById('start-screen');
            const categorySelectionContainer = document.getElementById('category-selection-container');
            const quizScreen = document.getElementById('quiz-screen');
            const resultScreen = document.getElementById('result-screen');
            
            // ซ่อนหน้าเกมและผลลัพธ์
            if (quizScreen) quizScreen.classList.add('hidden');
            if (resultScreen) resultScreen.classList.add('hidden');
            
            // แสดงหน้าเริ่มเล่นและเลือกหมวดหมู่
            if (startScreen) startScreen.classList.remove('hidden');
            if (categorySelectionContainer) categorySelectionContainer.classList.remove('hidden');
            
            // อัพเดต UI แสดงชื่อผู้เล่น
            updatePlayerInfoInGame();
            
        } else {
            console.log("โหมดผู้เล่นธรรมดา - ใช้ระบบเดิม");
            // ถ้าไม่ใช่แอดมิน ใช้ระบบเดิม
            updatePlayScreenVisibility();
        }
        
        // อัพเดตตัวเลือกหมวดหมู่ในหน้าเล่นเกม
        updatePlayMainCategorySelect();
    });
    
    // สลับไปที่แท็บประวัติการเล่น
    historyTab.addEventListener('click', function() {
        console.log("กำลังสลับไปที่แท็บประวัติการเล่น");
        
        // เปลี่ยนคลาส active ของแท็บ
        createTab.classList.remove('active');
        playTab.classList.remove('active');
        historyTab.classList.add('active');
        
        // เปลี่ยนคลาส active ของเนื้อหา
        createContent.classList.remove('active');
        playContent.classList.remove('active');
        historyContent.classList.add('active');
        
        // ซ่อนหน้าล็อกอินเมื่อสลับไปแท็บประวัติการเล่น
        if (loginScreen) loginScreen.classList.add('hidden');
        
        // เพิ่มคลาสเพื่อระบุแท็บที่กำลังแสดง
        document.body.className = 'active-tab-history';
        
        // อัพเดตการแสดงประวัติการเล่น
        if (typeof displayGameHistory === 'function') {
            try {
                displayGameHistory();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการแสดงประวัติการเล่น:", error);
            }
        }
    });
    
    console.log("ตั้งค่า Event Listeners สำหรับแท็บเรียบร้อยแล้ว");
    return true;
}

// ฟังก์ชันอัพเดต UI แสดงชื่อผู้เล่นในเกม - เพิ่มใหม่
function updatePlayerInfoInGame() {
    if (!isAdminMode || !currentPlayer) return;
    
    const quizContainer = document.querySelector('.container.quiz-player');
    if (!quizContainer) return;
    
    // ลบข้อมูลผู้เล่นเก่า (ถ้ามี)
    const existingPlayerInfo = quizContainer.querySelector('.player-info.top-right');
    if (existingPlayerInfo) {
        existingPlayerInfo.remove();
    }
    
    // เพิ่มข้อมูลผู้เล่นใหม่
    const playerInfo = document.createElement('div');
    playerInfo.className = 'player-info top-right';
    playerInfo.innerHTML = `
        <div class="player-name">👑 ${currentPlayer.name}</div>
    `;
    quizContainer.appendChild(playerInfo);
    
    console.log("อัพเดต UI แสดงชื่อผู้เล่นแอดมิน:", currentPlayer.name);
}

// ฟังก์ชันโหลดหมวดหมู่จาก Database
async function loadCategories() {
  try {
    // โหลดข้อมูลหมวดหมู่พร้อม is_locked
    const { data, error } = await supabaseClient
      .from('categories')
      .select('*')  // เปลี่ยนจาก select('*') เพื่อให้แน่ใจว่าได้ is_locked มาด้วย
      .order('level', { ascending: true })
      .order('name', { ascending: true });
    
    if (error) {
      console.error('เกิดข้อผิดพลาดในการโหลดหมวดหมู่:', error);
      categories = {};
      return;
    }
    
    // แปลงข้อมูลจาก Database เป็นรูปแบบ nested object เดิม
    // เพิ่มการเก็บข้อมูล is_locked สำหรับหมวดหมู่ย่อย 2
    categories = {};
    
    data.forEach(item => {
      if (item.level === 1) {
        // หมวดหมู่หลัก
        if (!categories[item.name]) {
          categories[item.name] = {};
        }
      } else if (item.level === 2) {
        // หมวดหมู่ย่อย 1
        if (!categories[item.parent_name]) {
          categories[item.parent_name] = {};
        }
        if (!categories[item.parent_name][item.name]) {
          categories[item.parent_name][item.name] = [];
        }
      } else if (item.level === 3) {
        // หมวดหมู่ย่อย 2 - เพิ่มการเก็บข้อมูล is_locked
        const parts = item.parent_name.split(' > ');
        const mainCategory = parts[0];
        const sub1Category = parts[1];
        
        if (!categories[mainCategory]) {
          categories[mainCategory] = {};
        }
        if (!categories[mainCategory][sub1Category]) {
          categories[mainCategory][sub1Category] = [];
        }
        
        // เปลี่ยนจากการเก็บแค่ string เป็น object ที่มี name และ is_locked
        categories[mainCategory][sub1Category].push({
          name: item.name,
          is_locked: item.is_locked || false  // default เป็น false ถ้าเป็น null
        });
      }
    });
    
    console.log('โหลดหมวดหมู่สำเร็จ:', Object.keys(categories).length, 'หมวดหมู่หลัก');
    console.log('ข้อมูลหมวดหมู่พร้อม is_locked:', categories);
    
  } catch (error) {
    console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
    categories = {};
  }
}

async function addCategory(type, parent, grandparent) {
    console.log("เริ่มเพิ่มหมวดหมู่:", type, parent, grandparent);

    const categoryName = document.getElementById('category-name').value.trim();
    
    if (!categoryName) {
        alert('กรุณากรอกชื่อหมวดหมู่');
        return false;
    }
    
    try {
        let categoryData = { name: categoryName };
        
        switch (type) {
            case 'main':
                // ตรวจสอบว่ามีหมวดหมู่หลักนี้อยู่แล้วหรือไม่
                const { data: existingMain } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', categoryName)
                    .eq('level', 1);
                
                if (existingMain && existingMain.length > 0) {
                    alert('มีหมวดหมู่หลักนี้อยู่แล้ว');
                    return false;
                }
                
                categoryData.level = 1;
                categoryData.parent_name = null;
                break;
                
            case 'sub1':
                if (!parent) {
                    alert('ไม่พบหมวดหมู่หลักที่ระบุ');
                    return false;
                }
                
                // ตรวจสอบว่ามีหมวดหมู่ย่อย 1 นี้อยู่แล้วหรือไม่
                const { data: existingSub1 } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', categoryName)
                    .eq('level', 2)
                    .eq('parent_name', parent);
                
                if (existingSub1 && existingSub1.length > 0) {
                    alert('มีหมวดหมู่ย่อย 1 นี้อยู่แล้ว');
                    return false;
                }
                
                categoryData.level = 2;
                categoryData.parent_name = parent;
                break;
                
            case 'sub2':
                if (!parent || !grandparent) {
                    alert('ไม่พบหมวดหมู่ที่ระบุ');
                    return false;
                }
                
                const parentPath = `${parent} > ${grandparent}`;
                
                // ตรวจสอบว่ามีหมวดหมู่ย่อย 2 นี้อยู่แล้วหรือไม่
                const { data: existingSub2 } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', categoryName)
                    .eq('level', 3)
                    .eq('parent_name', parentPath);
                
                if (existingSub2 && existingSub2.length > 0) {
                    alert('มีหมวดหมู่ย่อย 2 นี้อยู่แล้ว');
                    return false;
                }
                
                categoryData.level = 3;
                categoryData.parent_name = parentPath;
                break;
                
            default:
                alert('ประเภทหมวดหมู่ไม่ถูกต้อง');
                return false;
        }
        
        // บันทึกลง database
        const { error } = await supabaseClient
            .from('categories')
            .insert([categoryData]);
        
        if (error) {
            throw new Error('เกิดข้อผิดพลาดในการบันทึก: ' + error.message);
        }
        
        console.log("บันทึกหมวดหมู่สำเร็จ:", categoryName);
        
        // โหลดหมวดหมู่ใหม่จาก Database
        await loadCategories();
        
        // ปิดฟอร์ม
        closeAddCategoryForm();
        
        // อัพเดตการแสดงผล
        renderCategoryTree();
        updateCategoryUI();
        
        alert('เพิ่มหมวดหมู่เรียบร้อยแล้ว');
        
        return true;
        
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการเพิ่มหมวดหมู่:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
    }
    
    return false;
}

// ลบหมวดหมู่
function deleteMainCategory(mainCategory) {
    if (categories[mainCategory]) {
        delete categories[mainCategory];
        saveCategories();
        updateCategoryUI();
        return true;
    }
    return false;
}

function deleteSubCategory1(mainCategory, subCategory1) {
    if (categories[mainCategory] && categories[mainCategory][subCategory1]) {
        delete categories[mainCategory][subCategory1];
        saveCategories();
        updateCategoryUI();
        return true;
    }
    return false;
}

function deleteSubCategory2(mainCategory, subCategory1, subCategory2) {
    if (categories[mainCategory] && 
        categories[mainCategory][subCategory1] && 
        categories[mainCategory][subCategory1].includes(subCategory2)) {
        
        const index = categories[mainCategory][subCategory1].indexOf(subCategory2);
        categories[mainCategory][subCategory1].splice(index, 1);
        saveCategories();
        updateCategoryUI();
        return true;
    }
    return false;
}

async function updateCategoryUI() {
    console.log("กำลังอัพเดต UI ทั้งหมด...");
    
    // โหลดหมวดหมู่ใหม่จาก database
    await loadCategories();
    
    // อัพเดตตัวเลือกหมวดหมู่ในทุกฟอร์ม
    updateCategorySelects();
    updateQuestionCategorySelects();
    updateFilterMainCategory();
    updatePlayMainCategorySelect();
    
    // รีเซ็ตการแสดงผลคำถามแทนการแสดงทั้งหมด
    resetFiltersAndDisplay();
    
    console.log("อัพเดต UI เรียบร้อยแล้ว");
}

// อัพเดทการแสดงผลแบบ Tree View
function updateCategoriesTree() {
    const treeContainer = document.getElementById('categories-tree');
    treeContainer.innerHTML = '';
    
    for (const mainCategory in categories) {
        const mainCatDiv = document.createElement('div');
        mainCatDiv.className = 'category-item';
        mainCatDiv.innerHTML = `<strong>${mainCategory}</strong>`;
        
        const subCatContainer = document.createElement('div');
        subCatContainer.className = 'sub-categories';
        
        for (const subCategory1 in categories[mainCategory]) {
            const subCat1Div = document.createElement('div');
            subCat1Div.className = 'category-item';
            subCat1Div.innerHTML = `<strong>${subCategory1}</strong>`;
            
            const subCat2Container = document.createElement('div');
            subCat2Container.className = 'sub-categories';
            
            for (const subCategory2 of categories[mainCategory][subCategory1]) {
                const subCat2Div = document.createElement('div');
                subCat2Div.className = 'category-item';
                subCat2Div.textContent = subCategory2;
                subCat2Container.appendChild(subCat2Div);
            }
            
            subCat1Div.appendChild(subCat2Container);
            subCatContainer.appendChild(subCat1Div);
        }
        
        mainCatDiv.appendChild(subCatContainer);
        treeContainer.appendChild(mainCatDiv);
    }
}

// อัพเดท Select สำหรับการเพิ่มหมวดหมู่
function updateCategorySelects() {
    // อัพเดท select สำหรับเพิ่มหมวดหมู่
    const newMainCategorySelect = document.getElementById('new-main-category');
    if (newMainCategorySelect) {
        // เก็บตัวเลือกแรกไว้
        const firstOption = newMainCategorySelect.options[0];
        newMainCategorySelect.innerHTML = '';
        newMainCategorySelect.appendChild(firstOption);
        
        // เพิ่มหมวดหมู่หลักที่มีอยู่
        for (const mainCategory in categories) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            newMainCategorySelect.appendChild(option);
        }
    }
    
    // อัพเดท select ในฟอร์มคำถาม
    updateQuestionCategorySelects();
}

// อัพเดท Select สำหรับการแก้ไข/ลบหมวดหมู่
function updateEditCategorySelects() {
    const editMainCategory = document.getElementById('edit-main-category');
    const editSubCategory1 = document.getElementById('edit-sub-category1');
    const editSubCategory2 = document.getElementById('edit-sub-category2');
    
    if (editMainCategory) {
        editMainCategory.innerHTML = '<option value="">เลือกหมวดหมู่หลัก</option>';
        
        for (const mainCategory in categories) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            editMainCategory.appendChild(option);
        }
    }
    
    // รีเซ็ตอื่นๆ
    if (editSubCategory1) {
        editSubCategory1.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
        editSubCategory1.disabled = true;
    }
    
    if (editSubCategory2) {
        editSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
        editSubCategory2.disabled = true;
    }
}

// ฟังก์ชันอัพเดท Select ในฟอร์มคำถาม
function updateQuestionCategorySelects() {
    const questionMainCategory = document.getElementById('question-main-category');
    const questionSubCategory1 = document.getElementById('question-sub-category1');
    const questionSubCategory2 = document.getElementById('question-sub-category2');
    
    if (questionMainCategory) {
        // เก็บตัวเลือกแรกไว้
        const firstOption = questionMainCategory.options[0];
        questionMainCategory.innerHTML = '';
        questionMainCategory.appendChild(firstOption);
        
        // เพิ่มหมวดหมู่หลักที่มีอยู่
        for (const mainCategory in categories) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            questionMainCategory.appendChild(option);
        }
    }
    
    // รีเซ็ตตัวเลือกหมวดหมู่ย่อย
    if (questionSubCategory1) {
        questionSubCategory1.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
        questionSubCategory1.disabled = true;
    }
    
    if (questionSubCategory2) {
        questionSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
        questionSubCategory2.disabled = true;
    }
    
    console.log("อัพเดตตัวเลือกหมวดหมู่ในฟอร์มคำถามเรียบร้อย");
}

// ตั้งค่า Event Listeners สำหรับเลือกหมวดหมู่ในฟอร์มคำถาม
function setupQuestionCategoryListeners() {
    console.log("กำลังตั้งค่า Event Listeners สำหรับตัวเลือกหมวดหมู่ในฟอร์มคำถาม...");
    
    const questionMainCategory = document.getElementById('question-main-category');
    const questionSubCategory1 = document.getElementById('question-sub-category1');
    const questionSubCategory2 = document.getElementById('question-sub-category2');
    
    if (questionMainCategory) {
        // ลบ event listener เดิม (ถ้ามี)
        const newMainCategory = questionMainCategory.cloneNode(true);
        questionMainCategory.parentNode.replaceChild(newMainCategory, questionMainCategory);
        
        // เพิ่ม event listener ใหม่
        newMainCategory.addEventListener('change', function() {
    console.log("เลือกหมวดหมู่หลัก:", this.value);
    const mainCategory = this.value;
    
    // รีเซ็ตค่าของ dropdown หมวดย่อย - เพิ่มบรรทัดนี้
    document.getElementById('question-sub-category1').value = '';
    document.getElementById('question-sub-category2').value = '';
    
    // รีเซ็ตตัวเลือกหมวดย่อย 2 - เพิ่มบรรทัดนี้
    document.getElementById('question-sub-category2').innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
    document.getElementById('question-sub-category2').disabled = true;
    
    if (mainCategory) {
        updateSubCategory1Select(document.getElementById('question-sub-category1'), mainCategory);
    } else {
        document.getElementById('question-sub-category1').innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
        document.getElementById('question-sub-category1').disabled = true;
    }
});
    }
    
    if (questionSubCategory1) {
        // ลบ event listener เดิม (ถ้ามี)
        const newSubCategory1 = questionSubCategory1.cloneNode(true);
        questionSubCategory1.parentNode.replaceChild(newSubCategory1, questionSubCategory1);
        
        // เพิ่ม event listener ใหม่
        newSubCategory1.addEventListener('change', function() {
    console.log("เลือกหมวดหมู่ย่อย 1:", this.value);
    const mainCategory = document.getElementById('question-main-category').value;
    const subCategory1 = this.value;
    
    // รีเซ็ตค่าของ dropdown หมวดย่อย 2 - เพิ่มบรรทัดนี้
    document.getElementById('question-sub-category2').value = '';
    
    if (mainCategory && subCategory1) {
        updateSubCategory2Select(document.getElementById('question-sub-category2'), mainCategory, subCategory1);
    } else {
        document.getElementById('question-sub-category2').innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
        document.getElementById('question-sub-category2').disabled = true;
    }
});
    }
    
    console.log("ตั้งค่า Event Listeners สำหรับตัวเลือกหมวดหมู่ในฟอร์มคำถามเรียบร้อยแล้ว");
}

// ฟังก์ชันปรับปรุงใหม่สำหรับ radio buttons
function setupChoiceRadioButtons() {
  // เลือกทุก radio button ในฟอร์มแบบตรงไปตรงมา
  const radioButtons = document.querySelectorAll('input[name="correct-answer"]');
  
  // ล้างสถานะการเลือกทั้งหมด (ป้องกันการค้างสถานะ)
  radioButtons.forEach(radio => {
    radio.checked = false;
    
    // ลบ event listener เดิม (ถ้ามี) โดยใช้ replaceWith แทน cloneNode
    radio.addEventListener('click', function() {
      console.log("เลือกคำตอบที่ถูกต้อง:", this.value);
    });
  });
}

// อัพเดทหมวดหมู่ย่อย 1 เมื่อเลือกหมวดหมู่หลัก
function updateSubCategory1Select(selectElement, mainCategory) {
    selectElement.innerHTML = '<option value="" disabled selected>-- เลือกหมวดหมู่ย่อย 1 --</option>';
    
    if (mainCategory && categories[mainCategory]) {
        for (const subCategory1 in categories[mainCategory]) {
            const option = document.createElement('option');
            option.value = subCategory1;
            option.textContent = subCategory1;
            selectElement.appendChild(option);
        }
        selectElement.disabled = false;
    } else {
        selectElement.disabled = true;
    }
}

// ฟังก์ชันอัพเดทหมวดหมู่ย่อย 2 เมื่อเลือกหมวดหมู่ย่อย 1
function updateSubCategory2Select(selectElement, mainCategory, subCategory1) {
    selectElement.innerHTML = '<option value="" disabled selected>-- เลือกหมวดหมู่ย่อย 2 --</option>';
    
    if (mainCategory && subCategory1 && 
        categories[mainCategory] && 
        categories[mainCategory][subCategory1]) {
        
        // วนลูปหมวดหมู่ย่อย 2 ที่เป็น object แบบใหม่
        for (const subCategory2Item of categories[mainCategory][subCategory1]) {
            const option = document.createElement('option');
            option.value = subCategory2Item.name;
            
            // แสดงไอคอนล็อกถ้าหมวดหมู่ถูกล็อก
            const lockIcon = subCategory2Item.is_locked ? ' 🔒' : '';
            option.textContent = `${subCategory2Item.name}${lockIcon}`;
            
            selectElement.appendChild(option);
        }
        selectElement.disabled = false;
    } else {
        selectElement.disabled = true;
    }
}

// ฟังก์ชันสำหรับตรวจสอบว่าหมวดหมู่ถูกล็อกหรือไม่
function isCategoryLocked(mainCategory, subCategory1, subCategory2) {
    try {
        if (!categories[mainCategory] || !categories[mainCategory][subCategory1]) {
            return false;
        }
        
        const subCategory2List = categories[mainCategory][subCategory1];
        const categoryItem = subCategory2List.find(item => item.name === subCategory2);
        
        return categoryItem ? categoryItem.is_locked : false;
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการตรวจสอบการล็อก:', error);
        return false;
    }
}

// ฟังก์ชันจัดการ Event Listeners
function setupCategoryEventListeners() {
    // แท็บจัดการหมวดหมู่
    const viewCategoriesTab = document.getElementById('view-categories-tab');
    const addCategoryTab = document.getElementById('add-category-tab');
    const editCategoryTab = document.getElementById('edit-category-tab');
    
    const viewCategoriesContent = document.getElementById('view-categories-content');
    const addCategoryContent = document.getElementById('add-category-content');
    const editCategoryContent = document.getElementById('edit-category-content');
    
    // สลับแท็บหมวดหมู่
    if (viewCategoriesTab) {
        viewCategoriesTab.addEventListener('click', function() {
            viewCategoriesTab.classList.add('active');
            addCategoryTab.classList.remove('active');
            editCategoryTab.classList.remove('active');
            
            viewCategoriesContent.classList.add('active');
            addCategoryContent.classList.remove('active');
            editCategoryContent.classList.remove('active');
        });
    }
    
    if (addCategoryTab) {
        addCategoryTab.addEventListener('click', function() {
            viewCategoriesTab.classList.remove('active');
            addCategoryTab.classList.add('active');
            editCategoryTab.classList.remove('active');
            
            viewCategoriesContent.classList.remove('active');
            addCategoryContent.classList.add('active');
            editCategoryContent.classList.remove('active');
        });
    }
    
    if (editCategoryTab) {
        editCategoryTab.addEventListener('click', function() {
            viewCategoriesTab.classList.remove('active');
            addCategoryTab.classList.remove('active');
            editCategoryTab.classList.add('active');
            
            viewCategoriesContent.classList.remove('active');
            addCategoryContent.classList.remove('active');
            editCategoryContent.classList.add('active');
        });
    }
    
    // ปุ่มบันทึกหมวดหมู่
    const saveCategoryBtn = document.getElementById('save-category');
    if (saveCategoryBtn) {
        saveCategoryBtn.addEventListener('click', function() {
            const newMainCategorySelect = document.getElementById('new-main-category');
            const newMainCategoryText = document.getElementById('new-main-category-text');
            const newSubCategory1Select = document.getElementById('new-sub-category1');
            const newSubCategory1Text = document.getElementById('new-sub-category1-text');
            const newSubCategory2Select = document.getElementById('new-sub-category2');
            const newSubCategory2Text = document.getElementById('new-sub-category2-text');
            
            let mainCategory, subCategory1, subCategory2;
            
            // ตรวจสอบและใช้ค่าหมวดหมู่หลัก
            if (newMainCategorySelect.value === 'new') {
                if (newMainCategoryText.value.trim() === '') {
                    alert('กรุณาระบุชื่อหมวดหมู่หลักใหม่');
                    return;
                }
                mainCategory = newMainCategoryText.value.trim();
            } else {
                mainCategory = newMainCategorySelect.value;
            }
            
            // ตรวจสอบและใช้ค่าหมวดหมู่ย่อย 1
            if (newSubCategory1Select.value === 'new') {
                if (newSubCategory1Text.value.trim() === '') {
                    alert('กรุณาระบุชื่อหมวดหมู่ย่อย 1 ใหม่');
                    return;
                }
                subCategory1 = newSubCategory1Text.value.trim();
            } else if (newSubCategory1Select.value) {
                subCategory1 = newSubCategory1Select.value;
            } else {
                subCategory1 = '';
            }
            
            // ตรวจสอบและใช้ค่าหมวดหมู่ย่อย 2
            if (newSubCategory2Select.value === 'new') {
                if (newSubCategory2Text.value.trim() === '') {
                    alert('กรุณาระบุชื่อหมวดหมู่ย่อย 2 ใหม่');
                    return;
                }
                subCategory2 = newSubCategory2Text.value.trim();
            } else if (newSubCategory2Select.value) {
                subCategory2 = newSubCategory2Select.value;
            } else {
                subCategory2 = '';
            }
            
            // ตรวจสอบค่าขั้นต่ำ
            if (!mainCategory) {
                alert('กรุณาเลือกหรือระบุหมวดหมู่หลัก');
                return;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหรือระบุหมวดหมู่ย่อย 1');
                return;
            }
            
            // เพิ่มหมวดหมู่
            addCategory(mainCategory, subCategory1, subCategory2);
            
            // รีเซ็ตฟอร์ม
            newMainCategoryText.value = '';
            newSubCategory1Text.value = '';
            newSubCategory2Text.value = '';
            newMainCategorySelect.value = 'new';
            newSubCategory1Select.value = 'new';
            newSubCategory2Select.value = 'new';
            
            alert('บันทึกหมวดหมู่เรียบร้อยแล้ว');
        });
    }
    
    // Event Listeners สำหรับ Selects ในฟอร์มเพิ่มหมวดหมู่
    const newMainCategorySelect = document.getElementById('new-main-category');
    const newSubCategory1Select = document.getElementById('new-sub-category1');
    
    if (newMainCategorySelect) {
        newMainCategorySelect.addEventListener('change', function() {
            const mainCategory = this.value;
            const newMainCategoryText = document.getElementById('new-main-category-text');
            
            if (mainCategory === 'new') {
                newMainCategoryText.style.display = 'block';
                // รีเซ็ตหมวดหมู่ย่อย
                if (newSubCategory1Select) {
                    newSubCategory1Select.innerHTML = '<option value="new">+ สร้างหมวดหมู่ย่อย 1 ใหม่</option>';
                }
            } else {
                newMainCategoryText.style.display = 'none';
                
                // อัพเดตตัวเลือกหมวดหมู่ย่อย 1
                if (newSubCategory1Select) {
                    newSubCategory1Select.innerHTML = '<option value="new">+ สร้างหมวดหมู่ย่อย 1 ใหม่</option>';
                    
                    if (categories[mainCategory]) {
                        for (const subCategory1 in categories[mainCategory]) {
                            const option = document.createElement('option');
                            option.value = subCategory1;
                            option.textContent = subCategory1;
                            newSubCategory1Select.appendChild(option);
                        }
                    }
                }
            }
        });
    }
    
    if (newSubCategory1Select) {
        newSubCategory1Select.addEventListener('change', function() {
            const mainCategory = newMainCategorySelect.value;
            const subCategory1 = this.value;
            const newSubCategory1Text = document.getElementById('new-sub-category1-text');
            const newSubCategory2Select = document.getElementById('new-sub-category2');
            
            if (subCategory1 === 'new') {
                newSubCategory1Text.style.display = 'block';
                // รีเซ็ตหมวดหมู่ย่อย 2
                if (newSubCategory2Select) {
                    newSubCategory2Select.innerHTML = '<option value="new">+ สร้างหมวดหมู่ย่อย 2 ใหม่</option>';
                }
            } else {
                newSubCategory1Text.style.display = 'none';
                
                // อัพเดตตัวเลือกหมวดหมู่ย่อย 2
                if (newSubCategory2Select && mainCategory !== 'new' && categories[mainCategory] && categories[mainCategory][subCategory1]) {
                    newSubCategory2Select.innerHTML = '<option value="new">+ สร้างหมวดหมู่ย่อย 2 ใหม่</option>';
                    
                    for (const subCategory2 of categories[mainCategory][subCategory1]) {
                        const option = document.createElement('option');
                        option.value = subCategory2;
                        option.textContent = subCategory2;
                        newSubCategory2Select.appendChild(option);
                    }
                }
            }
        });
    }
    
    // Event Listeners สำหรับการแก้ไข/ลบหมวดหมู่
    const editMainCategory = document.getElementById('edit-main-category');
    const editSubCategory1 = document.getElementById('edit-sub-category1');
    const editSubCategory2 = document.getElementById('edit-sub-category2');
    
    if (editMainCategory) {
        editMainCategory.addEventListener('change', function() {
            const mainCategory = this.value;
            
            if (mainCategory) {
                updateSubCategory1Select(editSubCategory1, mainCategory);
            } else {
                editSubCategory1.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
                editSubCategory1.disabled = true;
                editSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                editSubCategory2.disabled = true;
            }
        });
    }
    
    if (editSubCategory1) {
        editSubCategory1.addEventListener('change', function() {
            const mainCategory = editMainCategory.value;
            const subCategory1 = this.value;
            
            if (mainCategory && subCategory1) {
                updateSubCategory2Select(editSubCategory2, mainCategory, subCategory1);
            } else {
                editSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                editSubCategory2.disabled = true;
            }
        });
    }
    
    // ปุ่มลบหมวดหมู่
    const deleteMainCategoryBtn = document.getElementById('delete-main-category');
    const deleteSubCategory1Btn = document.getElementById('delete-sub-category1');
    const deleteSubCategory2Btn = document.getElementById('delete-sub-category2');
    
    if (deleteMainCategoryBtn) {
        deleteMainCategoryBtn.addEventListener('click', function() {
            const mainCategory = editMainCategory.value;
            
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลักที่ต้องการลบ');
                return;
            }
            
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่หลัก "${mainCategory}" และหมวดหมู่ย่อยทั้งหมด?`)) {
                if (deleteMainCategory(mainCategory)) {
                    alert('ลบหมวดหมู่หลักเรียบร้อยแล้ว');
                    
                    // รีเซ็ตการเลือก
                    editMainCategory.value = '';
                    editSubCategory1.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
                    editSubCategory1.disabled = true;
                    editSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                    editSubCategory2.disabled = true;
                } else {
                    alert('เกิดข้อผิดพลาดในการลบหมวดหมู่หลัก');
                }
            }
        });
    }
    
    if (deleteSubCategory1Btn) {
        deleteSubCategory1Btn.addEventListener('click', function() {
            const mainCategory = editMainCategory.value;
            const subCategory1 = editSubCategory1.value;
            
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลัก');
                return;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 1 ที่ต้องการลบ');
                return;
            }
            
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ย่อย 1 "${subCategory1}" และหมวดหมู่ย่อย 2 ทั้งหมด?`)) {
                if (deleteSubCategory1(mainCategory, subCategory1)) {
                    alert('ลบหมวดหมู่ย่อย 1 เรียบร้อยแล้ว');
                    
                    // รีเซ็ตการเลือกหมวดหมู่ย่อย
                    updateSubCategory1Select(editSubCategory1, mainCategory);
                    editSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                    editSubCategory2.disabled = true;
                } else {
                    alert('เกิดข้อผิดพลาดในการลบหมวดหมู่ย่อย 1');
                }
            }
        });
    }
    
    if (deleteSubCategory2Btn) {
        deleteSubCategory2Btn.addEventListener('click', function() {
            const mainCategory = editMainCategory.value;
            const subCategory1 = editSubCategory1.value;
            const subCategory2 = editSubCategory2.value;
            
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลัก');
                return;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 1');
                return;
            }
            
            if (!subCategory2) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 2 ที่ต้องการลบ');
                return;
            }
            
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ย่อย 2 "${subCategory2}"?`)) {
                if (deleteSubCategory2(mainCategory, subCategory1, subCategory2)) {
                    alert('ลบหมวดหมู่ย่อย 2 เรียบร้อยแล้ว');
                    
                    // รีเซ็ตการเลือกหมวดหมู่ย่อย 2
                    updateSubCategory2Select(editSubCategory2, mainCategory, subCategory1);
                } else {
                    alert('เกิดข้อผิดพลาดในการลบหมวดหมู่ย่อย 2');
                }
            }
        });
    }
    
    // Event Listeners สำหรับ Select ในฟอร์มคำถาม
    const questionMainCategory = document.getElementById('question-main-category');
    const questionSubCategory1 = document.getElementById('question-sub-category1');
    const questionSubCategory2 = document.getElementById('question-sub-category2');
    
    if (questionMainCategory) {
        questionMainCategory.addEventListener('change', function() {
            const mainCategory = this.value;
            
            if (mainCategory) {
                updateSubCategory1Select(questionSubCategory1, mainCategory);
            } else {
                questionSubCategory1.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 1</option>';
                questionSubCategory1.disabled = true;
                questionSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                questionSubCategory2.disabled = true;
            }
        });
    }
    
    if (questionSubCategory1) {
        questionSubCategory1.addEventListener('change', function() {
            const mainCategory = questionMainCategory.value;
            const subCategory1 = this.value;
            
            if (mainCategory && subCategory1) {
                updateSubCategory2Select(questionSubCategory2, mainCategory, subCategory1);
            } else {
                questionSubCategory2.innerHTML = '<option value="">เลือกหมวดหมู่ย่อย 2</option>';
                questionSubCategory2.disabled = true;
            }
        });
    }
}

// ฟังก์ชันปรับปรุงระบบบันทึกคำถาม
function updateQuestionSystem() {
    // จัดการเมื่อบันทึกคำถาม
    const saveQuestionBtn = document.getElementById('save-question');
    if (saveQuestionBtn) {
        // ดึง event listener เดิมออก (ถ้ามี)
        const oldClickEvent = saveQuestionBtn.onclick;
        
        // แทนที่ด้วย event listener ใหม่
        saveQuestionBtn.onclick = function(event) {
            // ตรวจสอบหมวดหมู่
            const mainCategory = document.getElementById('question-main-category').value;
            const subCategory1 = document.getElementById('question-sub-category1').value;
            const subCategory2 = document.getElementById('question-sub-category2').value;
            
            // ตรวจสอบว่าต้องเลือกหมวดหมู่ครบทั้ง 3 ระดับหรือไม่
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลัก');
                event.preventDefault();
                return false;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 1');
                event.preventDefault();
                return false;
            }
            
            if (!subCategory2) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 2');
                event.preventDefault();
                return false;
            }
            
            // เรียกใช้ event listener เดิมถ้ามี
            if (typeof oldClickEvent === 'function') {
                return oldClickEvent.call(this, event);
            }
        };
    }
}

// ฟังก์ชันบันทึกคำถามลง Database
async function saveQuestion() {
  const questionText = document.getElementById('question-text').value.trim();
  const choiceA = document.getElementById('choice-a').value.trim();
  const choiceB = document.getElementById('choice-b').value.trim();
  const choiceC = document.getElementById('choice-c').value.trim();
  const choiceD = document.getElementById('choice-d').value.trim();
  
  const correctAnswerElem = document.querySelector('input[name="correct-answer"]:checked');
  const correctAnswer = correctAnswerElem ? correctAnswerElem.value : null;
  
  // ตรวจสอบข้อมูลจำเป็น
  if (!questionText) {
    alert('กรุณากรอกคำถาม');
    return false;
  }
  
  if (!choiceA || !choiceB || !choiceC || !choiceD) {
    alert('กรุณากรอกตัวเลือกให้ครบทุกข้อ');
    return false;
  }
  
  if (!correctAnswer) {
    alert('กรุณาเลือกคำตอบที่ถูกต้อง');
    return false;
  }
  
  // ตรวจสอบหมวดหมู่
  const mainCategory = document.getElementById('question-main-category').value;
  const subCategory1 = document.getElementById('question-sub-category1').value;
  const subCategory2 = document.getElementById('question-sub-category2').value;
  
  if (!mainCategory || !subCategory1 || !subCategory2) {
    alert('กรุณาเลือกหมวดหมู่ให้ครบทั้ง 3 ระดับ');
    return false;
  }
  
  // ตรวจสอบรูปภาพ
  let imageValue = null;
  const imagePreview = document.getElementById('image-preview');
  if (imagePreview.src && imagePreview.src !== "about:blank" && 
      imagePreview.style.display !== 'none' &&
      (imagePreview.src.startsWith('data:') || 
       imagePreview.src.startsWith('http://') || 
       imagePreview.src.startsWith('https://'))) {
    imageValue = imagePreview.src;
  }

  // สร้างข้อมูลคำถาม
  const questionData = {
    text: questionText,
    image_url: imageValue,
    choices: JSON.stringify([
      { id: 'A', text: choiceA },
      { id: 'B', text: choiceB },
      { id: 'C', text: choiceC },
      { id: 'D', text: choiceD }
    ]),
    correct_answer: correctAnswer,
    category_main: mainCategory,
    category_sub1: subCategory1,
    category_sub2: subCategory2
  };
  
  try {
    // บันทึกลง Supabase
    const { data, error } = await supabaseClient
      .from('questions')
      .insert([questionData])
      .select();
    
    if (error) {
      console.error('เกิดข้อผิดพลาดในการบันทึก:', error);
      alert('เกิดข้อผิดพลาดในการบันทึกคำถาม: ' + error.message);
      return false;
    }
    
    console.log('บันทึกคำถามสำเร็จ:', data);
    
    // โหลดคำถามใหม่จาก Database
    await loadQuestions();
    
    // รีเซ็ตตัวกรองและแสดงข้อความ "กรุณาเลือกหมวดหมู่"
    resetFiltersAndDisplay();
    
    // อัพเดตการแสดงผลหมวดหมู่ (tree)
    renderCategoryTree();
    
    // รีเซ็ตฟอร์ม
    clearForm();
    
    alert('บันทึกคำถามเรียบร้อยแล้ว');
    return true;
    
  } catch (error) {
    console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
    alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
    return false;
  }
}

function resetFiltersAndDisplay() {
    // รีเซ็ตตัวกรองทั้งหมด
    const filterMainCategory = document.getElementById('filter-main-category');
    const filterSubCategory1 = document.getElementById('filter-sub-category1');
    const filterSubCategory2 = document.getElementById('filter-sub-category2');
    const searchInput = document.getElementById('search-questions');
    
    if (filterMainCategory) {
        filterMainCategory.value = '';
    }
    
    if (filterSubCategory1) {
        filterSubCategory1.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 1</option>';
        filterSubCategory1.disabled = true;
    }
    
    if (filterSubCategory2) {
        filterSubCategory2.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
        filterSubCategory2.disabled = true;
    }
    
    if (searchInput) {
        searchInput.value = '';
    }
    
    // แสดงข้อความ "กรุณาเลือกหมวดหมู่"
    displayFilteredQuestions([], false, true);
}

// ฟังก์ชันโหลดคำถามจาก Database
async function loadQuestions() {
  try {
    const { data, error } = await supabaseClient
      .from('questions')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('เกิดข้อผิดพลาดในการโหลดคำถาม:', error);
      questions = []; // ใช้ array ว่างถ้าโหลดไม่ได้
      return;
    }
    
    // แปลงข้อมูลจาก Database เป็นรูปแบบที่โค้ดเดิมใช้
    questions = data.map(item => ({
      id: item.id.toString(),
      text: item.text,
      image: item.image_url,
      choices: JSON.parse(item.choices),
      correctAnswer: item.correct_answer,
      category: {
        main: item.category_main,
        sub1: item.category_sub1,
        sub2: item.category_sub2
      }
    }));
    
    console.log('โหลดคำถามสำเร็จ:', questions.length, 'ข้อ');
    
  } catch (error) {
    console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
    questions = [];
  }
}

// ฟังก์ชันโหลดประวัติการเล่นจาก Database
async function loadGameHistory() {
    try {
        const { data, error } = await supabaseClient
            .from('game_history')
            .select('*')
            .order('played_at', { ascending: false });

        if (error) {
            console.error('เกิดข้อผิดพลาดในการโหลดประวัติ:', error);
            gameHistory = [];
            filteredHistory = [];
            return;
        }

        // แปลงข้อมูลจาก Database เป็นรูปแบบที่โค้ดเดิมใช้
        gameHistory = data.map(item => ({
            id: item.id.toString(),
            playerName: item.player_name,
            score: item.score,
            totalQuestions: item.total_questions,
            percentage: item.percentage,
            category: JSON.parse(item.category || '{}'),
            playedAt: item.played_at,
            gameData: JSON.parse(item.game_data || '{}')
        }));

        filteredHistory = [...gameHistory];
        console.log('โหลดประวัติการเล่นสำเร็จ:', gameHistory.length, 'รายการ');

    } catch (error) {
        console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
        gameHistory = [];
        filteredHistory = [];
    }
}

// นำไปแทนที่ฟังก์ชัน displayQuestions ทั้งหมด
function displayQuestions(filtered = false, isReset = false) {
    if (filtered) {
        // ถ้ามีการระบุว่ามีการกรอง ให้เรียกใช้ฟังก์ชันกรอง
        applyFilters(isReset);
    } else {
        // ถ้าไม่มีการกรอง แสดงคำถามทั้งหมด หรือไม่แสดงเลยถ้าเป็นการรีเซ็ต
        displayFilteredQuestions(questions, false, isReset);
    }
    return true;
}

// ฟังก์ชันล้างฟอร์ม
function clearForm() {
  document.getElementById('question-text').value = '';
  document.getElementById('choice-a').value = '';
  document.getElementById('choice-b').value = '';
  document.getElementById('choice-c').value = '';
  document.getElementById('choice-d').value = '';
  
  // ล้างการเลือกตัวเลือกถูกต้อง - วิธีที่เรียบง่ายกว่า
  const radioButtons = document.querySelectorAll('input[name="correct-answer"]');
  radioButtons.forEach(radio => {
    radio.checked = false;
  });
  
  // ล้างรูปภาพ
  const imagePreview = document.getElementById('image-preview');
  imagePreview.src = '';
  imagePreview.style.display = 'none';
  document.getElementById('question-image').value = '';
  
  // รีเซ็ตการเลือกหมวดหมู่
  document.getElementById('question-main-category').value = '';
  document.getElementById('question-sub-category1').value = '';
  document.getElementById('question-sub-category2').disabled = true;
  document.getElementById('question-sub-category1').disabled = true;
}
// แทนที่ฟังก์ชัน deleteQuestion() เดิมด้วยโค้ดนี้
async function deleteQuestion(questionId) {
    if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบคำถามนี้?')) {
        try {
            // ลบจาก Supabase Database
            const { error } = await supabaseClient
                .from('questions')
                .delete()
                .eq('id', questionId);
            
            if (error) {
                console.error('เกิดข้อผิดพลาดในการลบคำถาม:', error);
                alert('เกิดข้อผิดพลาดในการลบคำถาม: ' + error.message);
                return;
            }
            
            // โหลดคำถามใหม่จาก Database
            await loadQuestions();
            
            // อัพเดตการแสดงผล
            displayQuestions();
            
            // อัพเดตตัวเลขแสดงจำนวนคำถามในหมวดหมู่
            renderCategoryTree();
            
            console.log('ลบคำถามสำเร็จ ID:', questionId);
            alert('ลบคำถามเรียบร้อยแล้ว');
            
        } catch (error) {
            console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
        }
    }
}

// แทนที่ฟังก์ชัน editQuestion() เดิมด้วยโค้ดนี้
async function editQuestion(questionId) {
    const question = questions.find(q => q.id === questionId);
    
    if (question) {
        try {
            // เติมข้อมูลในฟอร์ม
            document.getElementById('question-text').value = question.text;
            document.getElementById('choice-a').value = question.choices.find(c => c.id === 'A')?.text || '';
            document.getElementById('choice-b').value = question.choices.find(c => c.id === 'B')?.text || '';
            document.getElementById('choice-c').value = question.choices.find(c => c.id === 'C')?.text || '';
            document.getElementById('choice-d').value = question.choices.find(c => c.id === 'D')?.text || '';
            
            // เลือกคำตอบที่ถูกต้อง
            const correctRadio = document.querySelector(`input[name="correct-answer"][value="${question.correctAnswer}"]`);
            if (correctRadio) {
                correctRadio.checked = true;
            }
            
            // แสดงรูปภาพ (ถ้ามี)
            const imagePreview = document.getElementById('image-preview');
            if (question.image) {
                imagePreview.src = question.image;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
            
            // เลือกหมวดหมู่
            if (question.category) {
                const mainCategorySelect = document.getElementById('question-main-category');
                mainCategorySelect.value = question.category.main || '';
                
                // อัพเดต dropdown หมวดหมู่ย่อย 1
                if (question.category.main) {
                    updateSubCategory1Select(
                        document.getElementById('question-sub-category1'),
                        question.category.main
                    );
                    
                    // เลือกหมวดหมู่ย่อย 1
                    document.getElementById('question-sub-category1').value = question.category.sub1 || '';
                    
                    // อัพเดต dropdown หมวดหมู่ย่อย 2
                    if (question.category.sub1) {
                        updateSubCategory2Select(
                            document.getElementById('question-sub-category2'),
                            question.category.main,
                            question.category.sub1
                        );
                        
                        // เลือกหมวดหมู่ย่อย 2
                        document.getElementById('question-sub-category2').value = question.category.sub2 || '';
                    }
                }
            }
            
            // ลบคำถามเดิมจาก Database
            const { error } = await supabaseClient
                .from('questions')
                .delete()
                .eq('id', questionId);
            
            if (error) {
                console.error('เกิดข้อผิดพลาดในการลบคำถามเดิม:', error);
                alert('เกิดข้อผิดพลาดในการแก้ไขคำถาม: ' + error.message);
                return;
            }
            
            // โหลดคำถามใหม่จาก Database
            await loadQuestions();
            
            // อัพเดตการแสดงผล
            displayQuestions();
            
            // เลื่อนไปที่ฟอร์ม
            document.getElementById('question-form').scrollIntoView({ behavior: 'smooth' });
            
            // ตั้งค่า Radio Buttons ใหม่
            setupChoiceRadioButtons();
            
            console.log('เตรียมแก้ไขคำถาม ID:', questionId);
            
        } catch (error) {
            console.error('เกิดข้อผิดพลาดในการแก้ไขคำถาม:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
        }
    }
}

// ฟังก์ชันสำหรับส่งออกข้อมูลทั้งหมด
function exportAllData() {
    // สร้างอ็อบเจกต์สำหรับส่งออก
    const exportData = {
        categories: categories,
        questions: questions
    };
    
    // แปลงเป็น JSON string
    const jsonString = JSON.stringify(exportData, null, 2);
    
    // สร้าง Blob
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // สร้าง URL
    const url = URL.createObjectURL(blob);
    
    // สร้าง <a> element สำหรับดาวน์โหลด
    const a = document.createElement('a');
    a.href = url;
    a.download = 'quiz-data.json';
    
    // เพิ่มลงใน document และคลิก
    document.body.appendChild(a);
    a.click();
    
    // ลบออกจาก document
    document.body.removeChild(a);
    
    // เคลียร์ URL
    URL.revokeObjectURL(url);
}

// ฟังก์ชันลบคำถามทั้งหมด - แก้ไขให้ลบใน Database ด้วย
async function clearAllData() {
    if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบคำถามทั้งหมด? การกระทำนี้ไม่สามารถเรียกคืนได้')) {
        try {
            // ลบจาก Supabase Database
            const { error } = await supabaseClient
                .from('questions')
                .delete()
                .neq('id', 0); // ลบทั้งหมด (neq คือ not equal, ใช้เงื่อนไขที่เป็นจริงเสมอ)
            
            if (error) {
                console.error('เกิดข้อผิดพลาดในการลบคำถามทั้งหมด:', error);
                alert('เกิดข้อผิดพลาดในการลบคำถาม: ' + error.message);
                return;
            }
            
            // โหลดคำถามใหม่จาก Database (จะเป็น array ว่าง)
            await loadQuestions();
            
            // อัพเดตการแสดงผล
            displayQuestions();
            
            // อัพเดตตัวเลขแสดงจำนวนคำถามในหมวดหมู่
            renderCategoryTree();
            
            alert('ลบคำถามทั้งหมดเรียบร้อยแล้ว');
            
        } catch (error) {
            console.error('เกิดข้อผิดพลาดที่ไม่คาดคิด:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
        }
    }
}

// ฟังก์ชันสำหรับดาวน์โหลดเทมเพลต Excel
function downloadExcelTemplate() {
    // สร้างอาเรย์สำหรับข้อมูลตัวอย่าง
    const data = [
        ['คำถาม', 'รูปภาพ (URL)', 'ตัวเลือก A', 'ตัวเลือก B', 'ตัวเลือก C', 'ตัวเลือก D', 'คำตอบที่ถูกต้อง (A, B, C, D)', 'หมวดหมู่หลัก', 'หมวดหมู่ย่อย 1', 'หมวดหมู่ย่อย 2'],
        ['นี่คือตัวอย่างคำถาม?', '', 'ตัวเลือก A', 'ตัวเลือก B', 'ตัวเลือก C', 'ตัวเลือก D', 'A', 'ความรู้ทั่วไป', 'วิทยาศาสตร์', 'ฟิสิกส์']
    ];
    
    // สร้าง workbook
    const wb = XLSX.utils.book_new();
    
    // สร้าง worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // กำหนดความกว้างคอลัมน์
    const wscols = [
        {wch: 25}, // คำถาม
        {wch: 20}, // รูปภาพ (URL)
        {wch: 15}, // ตัวเลือก A
        {wch: 15}, // ตัวเลือก B
        {wch: 15}, // ตัวเลือก C
        {wch: 15}, // ตัวเลือก D
        {wch: 25}, // คำตอบที่ถูกต้อง
        {wch: 15}, // หมวดหมู่หลัก
        {wch: 15}, // หมวดหมู่ย่อย 1
        {wch: 15}  // หมวดหมู่ย่อย 2
    ];
    ws['!cols'] = wscols;
    
    // เพิ่ม worksheet ลงใน workbook
    XLSX.utils.book_append_sheet(wb, ws, 'คำถาม');
    
    // สร้างไฟล์ Excel และดาวน์โหลด
    XLSX.writeFile(wb, 'quiz-template.xlsx');
}

// ฟังก์ชันตรวจสอบว่าคำถามซ้ำหรือไม่
function isDuplicateQuestion(questionText) {
    return questions.some(q => q.text.trim().toLowerCase() === questionText.trim().toLowerCase());
}

// ฟังก์ชันสำหรับนำเข้าจาก Excel - แทนที่ฟังก์ชันเดิมทั้งหมด
async function importFromExcel(file) {
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            // เพิ่มตัวแสดงความคืบหน้า
            const progressDiv = document.createElement('div');
            progressDiv.id = 'import-progress';
            progressDiv.style.cssText = `
                margin: 10px 0;
                padding: 15px;
                background-color: #f0f7ff;
                border-radius: 8px;
                border: 1px solid #1976d2;
                text-align: center;
            `;
            progressDiv.innerHTML = '<p>🔄 กำลังประมวลผลไฟล์ Excel... โปรดรอสักครู่</p>';
            document.getElementById('import-excel').parentNode.appendChild(progressDiv);
            
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellText: false });
            
            // ใช้ชีทแรก
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // แปลงเป็น JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "", raw: false });
            
            if (jsonData.length === 0) {
                removeProgressDiv();
                alert('ไม่พบข้อมูลในไฟล์ Excel');
                return;
            }
            
            console.log("ข้อมูลที่อ่านได้:", jsonData);
            updateProgressDiv('📊 กำลังตรวจสอบและเตรียมข้อมูล...');
            
            // ขั้นตอนที่ 1: ประมวลผลข้อมูลและตรวจสอบ
            const { validQuestions, errors, newCategoriesToCreate } = await processExcelData(jsonData);
            
            if (validQuestions.length === 0) {
                removeProgressDiv();
                showImportResult(0, errors.length, errors);
                return;
            }
            
            // ขั้นตอนที่ 2: สร้างหมวดหมู่ใหม่ (ถ้ามี)
            updateProgressDiv('📝 กำลังสร้างหมวดหมู่ใหม่...');
            await createNewCategories(newCategoriesToCreate);
            
            // ขั้นตอนที่ 3: บันทึกคำถามแบบ batch
            updateProgressDiv('💾 กำลังบันทึกคำถาม...');
            const { successCount, batchErrors } = await saveQuestionsInBatches(validQuestions);
            
            // รวมข้อผิดพลาดทั้งหมด
            const allErrors = [...errors, ...batchErrors];
            
            // โหลดข้อมูลใหม่
            await loadCategories();
            await loadQuestions();
            
            // อัพเดตการแสดงผล
            renderCategoryTree();
            updateCategoryUI();
            resetFiltersAndDisplay();
            
            // ลบตัวแสดงความคืบหน้า
            removeProgressDiv();
            
            // แสดงผลลัพธ์
            showImportResult(successCount, allErrors.length, allErrors);
            
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการประมวลผลไฟル์ Excel:", error);
            removeProgressDiv();
            alert(`เกิดข้อผิดพลาดในการประมวลผลไฟล์: ${error.message}`);
        }
    };
    
    reader.onerror = function(error) {
        console.error('เกิดข้อผิดพลาดในการอ่านไฟล์:', error);
        removeProgressDiv();
        alert('เกิดข้อผิดพลาดในการอ่านไฟล์');
    };
    
    reader.readAsArrayBuffer(file);
}

// ฟังก์ชันประมวลผลข้อมูล Excel - เพิ่มใหม่
async function processExcelData(jsonData) {
    const validQuestions = [];
    const errors = [];
    const newCategoriesToCreate = new Set();
    
    // สร้าง map ของชื่อคอลัมน์ที่ยอมรับได้
    const columnMap = {
        'คำถาม': ['คำถาม', 'question', 'text', 'ข้อคำถาม', 'คำถาม?'],
        'รูปภาพ (URL)': ['รูปภาพ (URL)', 'รูปภาพ', 'image', 'url', 'รูป'],
        'ตัวเลือก A': ['ตัวเลือก A', 'ตัวเลือกA', 'choice A', 'choiceA', 'A', 'ตัวเลือก a', 'ตัวเลือกa'],
        'ตัวเลือก B': ['ตัวเลือก B', 'ตัวเลือกB', 'choice B', 'choiceB', 'B', 'ตัวเลือก b', 'ตัวเลือกb'],
        'ตัวเลือก C': ['ตัวเลือก C', 'ตัวเลือกC', 'choice C', 'choiceC', 'C', 'ตัวเลือก c', 'ตัวเลือกc'],
        'ตัวเลือก D': ['ตัวเลือก D', 'ตัวเลือกD', 'choice D', 'choiceD', 'D', 'ตัวเลือก d', 'ตัวเลือกd'],
        'คำตอบที่ถูกต้อง (A, B, C, D)': ['คำตอบที่ถูกต้อง (A, B, C, D)', 'คำตอบที่ถูกต้อง', 'correct answer', 'answer', 'คำตอบ', 'เฉลย'],
        'หมวดหมู่หลัก': ['หมวดหมู่หลัก', 'main category', 'category', 'หมวดหมู่', 'หมวด'],
        'หมวดหมู่ย่อย 1': ['หมวดหมู่ย่อย 1', 'sub category 1', 'subcategory1', 'หมวดหมู่ย่อย1', 'หมวดย่อย 1', 'หมวดย่อย1'],
        'หมวดหมู่ย่อย 2': ['หมวดหมู่ย่อย 2', 'sub category 2', 'subcategory2', 'หมวดหมู่ย่อย2', 'หมวดย่อย 2', 'หมวดย่อย2']
    };
    
    // หา key ในข้อมูลที่ตรงกับชื่อคอลัมน์ที่ต้องการ
    function findColumnKey(row, columnType) {
        const possibleNames = columnMap[columnType];
        for (const name of possibleNames) {
            if (row[name] !== undefined) {
                return name;
            }
        }
        return null;
    }
    
    // สร้างรายการคำถามที่มีอยู่แล้วเพื่อตรวจสอบการซ้ำ
    const existingQuestions = new Set();
    questions.forEach(q => {
        if (q.category) {
            const key = `${q.text.trim().toLowerCase()}|${q.category.main}|${q.category.sub1}|${q.category.sub2}`;
            existingQuestions.add(key);
        }
    });
    
    // ประมวลผลข้อมูลทีละแถว
    for (let index = 0; index < jsonData.length; index++) {
        const row = jsonData[index];
        
        try {
            // แปลงข้อมูลให้เป็นรูปแบบมาตรฐาน
            const formattedRow = {};
            for (const columnType in columnMap) {
                const key = findColumnKey(row, columnType);
                formattedRow[columnType] = key ? String(row[key]).trim() : "";
            }
            
            // ตรวจสอบข้อมูลจำเป็น
            if (!formattedRow['คำถาม']) {
                errors.push(`แถวที่ ${index + 2}: ไม่พบข้อมูลคำถาม`);
                continue;
            }
            
            // ตรวจสอบตัวเลือก
            if (!formattedRow['ตัวเลือก A'] || !formattedRow['ตัวเลือก B'] || 
                !formattedRow['ตัวเลือก C'] || !formattedRow['ตัวเลือก D']) {
                errors.push(`แถวที่ ${index + 2}: ตัวเลือกไม่ครบทั้ง 4 ตัวเลือก`);
                continue;
            }
            
            // ตรวจสอบและแปลงคำตอบที่ถูกต้อง
            let correctAnswer = String(formattedRow['คำตอบที่ถูกต้อง (A, B, C, D)']).trim().toUpperCase();
            if (!correctAnswer) {
                errors.push(`แถวที่ ${index + 2}: ไม่พบข้อมูลคำตอบที่ถูกต้อง`);
                continue;
            }
            
            // รองรับรูปแบบคำตอบที่หลากหลาย
            if (correctAnswer.includes('A') || correctAnswer.includes('1')) correctAnswer = 'A';
            else if (correctAnswer.includes('B') || correctAnswer.includes('2')) correctAnswer = 'B';
            else if (correctAnswer.includes('C') || correctAnswer.includes('3')) correctAnswer = 'C';
            else if (correctAnswer.includes('D') || correctAnswer.includes('4')) correctAnswer = 'D';
            
            if (!['A', 'B', 'C', 'D'].includes(correctAnswer)) {
                errors.push(`แถวที่ ${index + 2}: รูปแบบคำตอบไม่ถูกต้อง (${correctAnswer})`);
                continue;
            }
            
            // กำหนดหมวดหมู่ (ใช้ค่าเริ่มต้นถ้าไม่มี)
            const mainCategory = formattedRow['หมวดหมู่หลัก'] || 'ทั่วไป';
            const subCategory1 = formattedRow['หมวดหมู่ย่อย 1'] || 'ทั่วไป';
            const subCategory2 = formattedRow['หมวดหมู่ย่อย 2'] || 'ทั่วไป';
            
            // ตรวจสอบคำถามซ้ำ
            const questionKey = `${formattedRow['คำถาม'].toLowerCase()}|${mainCategory}|${subCategory1}|${subCategory2}`;
            if (existingQuestions.has(questionKey)) {
                errors.push(`แถวที่ ${index + 2}: คำถามซ้ำกับที่มีอยู่แล้ว "${formattedRow['คำถาม'].substring(0, 30)}..."`);
                continue;
            }
            
            // เพิ่มเข้าไปในรายการที่ตรวจสอบแล้ว
            existingQuestions.add(questionKey);
            
            // เก็บหมวดหมู่ที่ต้องสร้างใหม่
            if (!categories[mainCategory]) {
                newCategoriesToCreate.add(`main|${mainCategory}`);
            }
            if (!categories[mainCategory] || !categories[mainCategory][subCategory1]) {
                newCategoriesToCreate.add(`sub1|${mainCategory}|${subCategory1}`);
            }
            if (!categories[mainCategory] || !categories[mainCategory][subCategory1] || 
                !categories[mainCategory][subCategory1].includes(subCategory2)) {
                newCategoriesToCreate.add(`sub2|${mainCategory}|${subCategory1}|${subCategory2}`);
            }
            
            // สร้างข้อมูลคำถาม
            const questionData = {
                text: formattedRow['คำถาม'],
                image_url: formattedRow['รูปภาพ (URL)'] || null,
                choices: JSON.stringify([
                    { id: 'A', text: formattedRow['ตัวเลือก A'] },
                    { id: 'B', text: formattedRow['ตัวเลือก B'] },
                    { id: 'C', text: formattedRow['ตัวเลือก C'] },
                    { id: 'D', text: formattedRow['ตัวเลือก D'] }
                ]),
                correct_answer: correctAnswer,
                category_main: mainCategory,
                category_sub1: subCategory1,
                category_sub2: subCategory2
            };
            
            validQuestions.push(questionData);
            
        } catch (err) {
            console.error(`เกิดข้อผิดพลาดในแถวที่ ${index + 2}:`, err);
            errors.push(`แถวที่ ${index + 2}: ${err.message}`);
        }
    }
    
    return { validQuestions, errors, newCategoriesToCreate };
}

// ฟังก์ชันสร้างหมวดหมู่ใหม่ - เพิ่มใหม่
async function createNewCategories(newCategoriesToCreate) {
    if (newCategoriesToCreate.size === 0) return;
    
    const categoriesToInsert = [];
    
    for (const categoryStr of newCategoriesToCreate) {
        const parts = categoryStr.split('|');
        const type = parts[0];
        
        if (type === 'main') {
            categoriesToInsert.push({
                name: parts[1],
                level: 1,
                parent_name: null
            });
        } else if (type === 'sub1') {
            categoriesToInsert.push({
                name: parts[2],
                level: 2,
                parent_name: parts[1]
            });
        } else if (type === 'sub2') {
            categoriesToInsert.push({
                name: parts[3],
                level: 3,
                parent_name: `${parts[1]} > ${parts[2]}`
            });
        }
    }
    
    if (categoriesToInsert.length > 0) {
        const { error } = await supabaseClient
            .from('categories')
            .insert(categoriesToInsert);
        
        if (error) {
            console.error('เกิดข้อผิดพลาดในการสร้างหมวดหมู่:', error);
            throw new Error('ไม่สามารถสร้างหมวดหมู่ใหม่ได้: ' + error.message);
        }
        
        console.log('สร้างหมวดหมู่ใหม่สำเร็จ:', categoriesToInsert.length, 'หมวดหมู่');
    }
}

// ฟังก์ชันบันทึกคำถามแบบ batch - เพิ่มใหม่
async function saveQuestionsInBatches(questions) {
    const BATCH_SIZE = 25;
    let successCount = 0;
    const batchErrors = [];
    
    // แยกคำถามเป็นกลุ่มๆ
    const batches = [];
    for (let i = 0; i < questions.length; i += BATCH_SIZE) {
        batches.push(questions.slice(i, i + BATCH_SIZE));
    }
    
    console.log(`กำลังบันทึก ${questions.length} คำถาม เป็น ${batches.length} batch`);
    
    // บันทึกทีละ batch
    for (let i = 0; i < batches.length; i++) {
        const batch = batches[i];
        const batchNumber = i + 1;
        
        try {
            updateProgressDiv(`💾 กำลังบันทึก batch ${batchNumber}/${batches.length} (${batch.length} ข้อ)...`);
            
            const { data, error } = await supabaseClient
                .from('questions')
                .insert(batch);
            
            if (error) {
                console.error(`Batch ${batchNumber} ผิดพลาด:`, error);
                batchErrors.push(`Batch ${batchNumber} (${batch.length} ข้อ): ${error.message}`);
            } else {
                successCount += batch.length;
                console.log(`Batch ${batchNumber} สำเร็จ: ${batch.length} ข้อ`);
            }
            
        } catch (err) {
            console.error(`เกิดข้อผิดพลาดใน batch ${batchNumber}:`, err);
            batchErrors.push(`Batch ${batchNumber} (${batch.length} ข้อ): ${err.message}`);
        }
    }
    
    return { successCount, batchErrors };
}

// ฟังก์ชันอัพเดตแถบความคืบหน้า - เพิ่มใหม่
function updateProgressDiv(message) {
    const progressDiv = document.getElementById('import-progress');
    if (progressDiv) {
        progressDiv.innerHTML = `<p>${message}</p>`;
    }
}

// ฟังก์ชันลบแถบความคืบหน้า - เพิ่มใหม่
function removeProgressDiv() {
    const progressDiv = document.getElementById('import-progress');
    if (progressDiv) {
        progressDiv.remove();
    }
}

// ฟังก์ชันแสดงผลการนำเข้า - เพิ่มใหม่
function showImportResult(successCount, errorCount, errors) {
    let message = `🎉 การนำเข้าเสร็จสิ้น!\n\n`;
    message += `✅ นำเข้าสำเร็จ: ${successCount} คำถาม\n`;
    message += `❌ ไม่สามารถนำเข้าได้: ${errorCount} รายการ\n`;
    
    if (errorCount > 0 && errors.length > 0) {
        message += `\n📋 รายละเอียดข้อผิดพลาด:\n`;
        const displayErrors = errors.slice(0, 10);
        message += displayErrors.join('\n');
        
        if (errors.length > 10) {
            message += `\n... และอีก ${errors.length - 10} ข้อผิดพลาด`;
        }
    }
    
    alert(message);
}

// ฟังก์ชันสำหรับแสดงรูปภาพคำถาม
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('image-preview');
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// เพิ่ม Event Listeners
function setupQuestionSystemEventListeners() {
    // ฟอร์มคำถาม
    const saveQuestionBtn = document.getElementById('save-question');
    if (saveQuestionBtn) {
        saveQuestionBtn.addEventListener('click', saveQuestion);
    }
    
    const clearFormBtn = document.getElementById('clear-form');
    if (clearFormBtn) {
        clearFormBtn.addEventListener('click', clearForm);
    }
    
    const questionImage = document.getElementById('question-image');
    if (questionImage) {
        questionImage.addEventListener('change', handleImageUpload);
    }
    
    // ปุ่มจัดการข้อมูลทั้งหมด
    const exportAllBtn = document.getElementById('export-all');
    if (exportAllBtn) {
        exportAllBtn.addEventListener('click', exportAllData);
    }
    
    const clearAllBtn = document.getElementById('clear-all');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllData);
    }
    
    const downloadTemplateBtn = document.getElementById('download-template');
    if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
    }
    
    // อัพโหลด Excel
    const excelFileInput = document.getElementById('excel-file');
    if (excelFileInput) {
        excelFileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                importFromExcel(e.target.files[0]);
            }
        });
    }
    
    const importExcelBtn = document.getElementById('import-excel');
if (importExcelBtn) {
    importExcelBtn.addEventListener('click', function() {
        if (questions.length > 0) {
            if (confirm('มีคำถามอยู่แล้ว การนำเข้าไฟล์ใหม่จะเพิ่มคำถามเข้าไปในรายการเดิม ต้องการดำเนินการต่อหรือไม่?')) {
                document.getElementById('excel-file').click();
            }
        } else {
            document.getElementById('excel-file').click();
        }
    });
}
}
 // ฟังก์ชันเริ่มต้นระบบคำถาม
function initQuestionSystem() {
    console.log("กำลังเริ่มต้นระบบคำถาม...");
    
    // โหลดคำถามจาก localStorage
    loadQuestions();
    
    // ตั้งค่า Event Listeners
    setupQuestionSystemEventListeners();
    
    // ตั้งค่า Event Listeners สำหรับตัวเลือกหมวดหมู่
    setupQuestionCategoryListeners();
    
    // ตั้งค่า Radio Buttons สำหรับตัวเลือกคำตอบ
    setupChoiceRadioButtons();
    
    // อัพเดตการแสดงผลคำถาม - เรียกโดยส่ง isReset เป็น true เพื่อไม่ให้แสดงคำถามทันที
        displayQuestions(false, true);
    
    // แก้ไขระบบบันทึกคำถาม
    updateQuestionSystem();
    
    // อัพเดตตัวเลือกหมวดหมู่ในฟอร์มคำถาม
    updateQuestionCategorySelects();
    
    console.log("ระบบคำถามพร้อมใช้งานแล้ว");
}
// ปรับปรุงระบบเล่นเกม
function updatePlaySystem() {
    console.log("กำลังอัพเดตระบบเล่นเกม...");
    
    // ปุ่มเริ่มเล่น
    const startQuizBtn = document.getElementById('start-quiz');
    if (startQuizBtn) {
        // ลบ event listener เดิม (ถ้ามี)
        const newStartQuizBtn = startQuizBtn.cloneNode(true);
        if (startQuizBtn.parentNode) {
            startQuizBtn.parentNode.replaceChild(newStartQuizBtn, startQuizBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newStartQuizBtn.addEventListener('click', startQuiz);
    }
    
    // ปุ่มเล่นอีกครั้ง
    const restartQuizBtn = document.getElementById('restart-quiz');
    if (restartQuizBtn) {
        // ลบ event listener เดิม (ถ้ามี)
        const newRestartQuizBtn = restartQuizBtn.cloneNode(true);
        if (restartQuizBtn.parentNode) {
            restartQuizBtn.parentNode.replaceChild(newRestartQuizBtn, restartQuizBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newRestartQuizBtn.addEventListener('click', restartQuiz);
    }
    
    // อัพเดตปุ่มต่างๆ ในหน้าเล่นเกม
    const submitAnswerBtn = document.getElementById('submit-answer');
    if (submitAnswerBtn) {
        // ลบ event listener เดิม (ถ้ามี)
        const newSubmitAnswerBtn = submitAnswerBtn.cloneNode(true);
        if (submitAnswerBtn.parentNode) {
            submitAnswerBtn.parentNode.replaceChild(newSubmitAnswerBtn, submitAnswerBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newSubmitAnswerBtn.addEventListener('click', submitAnswer);
    }
    
    const nextQuestionBtn = document.getElementById('next-question');
    if (nextQuestionBtn) {
        // ลบ event listener เดิม (ถ้ามี)
        const newNextQuestionBtn = nextQuestionBtn.cloneNode(true);
        if (nextQuestionBtn.parentNode) {
            nextQuestionBtn.parentNode.replaceChild(newNextQuestionBtn, nextQuestionBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newNextQuestionBtn.addEventListener('click', showNextQuestion);
    }
    
    const prevQuestionBtn = document.getElementById('prev-question');
    if (prevQuestionBtn) {
        // ลบ event listener เดิม (ถ้ามี)
        const newPrevQuestionBtn = prevQuestionBtn.cloneNode(true);
        if (prevQuestionBtn.parentNode) {
            prevQuestionBtn.parentNode.replaceChild(newPrevQuestionBtn, prevQuestionBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newPrevQuestionBtn.addEventListener('click', showPrevQuestion);
    }
    
    console.log("อัพเดตระบบเล่นเกมเรียบร้อยแล้ว");
}

// แทนที่ฟังก์ชัน startQuiz ทั้งหมด
function startQuiz() {
    console.log("กำลังเริ่มเล่นเกม...");
    
    // ตรวจสอบว่ามีคำถามหรือไม่
    if (!Array.isArray(currentGameQuestions) || currentGameQuestions.length === 0) {
        alert('ยังไม่มีคำถามในหมวดหมู่ที่เลือก กรุณาเลือกหมวดหมู่อื่น');
        return;
    }
    
    console.log("เริ่มเล่นเกม: คำถามทั้งหมด =", currentGameQuestions.length);
    
    // ซ่อนหน้าเลือกหมวดหมู่
    const categorySelectionContainer = document.getElementById('category-selection-container');
    if (categorySelectionContainer) {
        categorySelectionContainer.classList.add('hidden');
    }
    
    // ซ่อนหน้าเริ่มต้น
    const startScreen = document.getElementById('start-screen');
    if (startScreen) startScreen.classList.add('hidden');
    
    // แสดงหน้าเล่นเกม
    const quizScreen = document.getElementById('quiz-screen');
    if (quizScreen) quizScreen.classList.remove('hidden');
    
    // รีเซ็ตการเล่นเกม
    currentQuestionIndex = 0;
    userAnswers = {}; // เคลียร์คำตอบเดิม
    choiceOrderMap = {}; // รีเซ็ตตำแหน่งตัวเลือก
    
    // สร้างลำดับคำถามแบบสุ่ม
    randomQuestionOrder = Array.from(Array(currentGameQuestions.length).keys());
    for (let i = randomQuestionOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [randomQuestionOrder[i], randomQuestionOrder[j]] = [randomQuestionOrder[j], randomQuestionOrder[i]];
    }
    
    // สลับลำดับตัวเลือกสำหรับแต่ละคำถาม
    randomQuestionOrder.forEach(questionIndex => {
        // สร้างลำดับตัวเลือก [0, 1, 2, 3] สำหรับ A, B, C, D
        const choiceOrder = [0, 1, 2, 3];
        
        // สลับลำดับตัวเลือก
        for (let i = choiceOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choiceOrder[i], choiceOrder[j]] = [choiceOrder[j], choiceOrder[i]];
        }
        
        // บันทึกลำดับตัวเลือกของคำถามนี้
        choiceOrderMap[questionIndex] = choiceOrder;
    });
    
    // เพิ่มส่วนแสดงชื่อผู้เล่นเข้าไปในกรอบเกมที่มุมขวาบน (ไม่มีอวตาร์)
    const quizContainer = document.querySelector('.container.quiz-player');
    if (quizContainer && currentPlayer && !quizContainer.querySelector('.player-info.top-right')) {
        const playerInfo = document.createElement('div');
        playerInfo.className = 'player-info top-right';
        playerInfo.innerHTML = `
            <div class="player-name">ผู้เล่น: ${currentPlayer.name}</div>
        `;
        quizContainer.appendChild(playerInfo);
    }
    
    // อัพเดตหน้าเล่นเกม
    updateQuizScreen();
}

// แทนที่ฟังก์ชัน updateQuizScreen ทั้งหมด
function updateQuizScreen() {
    console.log("กำลังอัพเดตหน้าเล่นเกม...");
    
    // ตรวจสอบว่ามีคำถามหรือไม่
    if (!Array.isArray(currentGameQuestions) || currentGameQuestions.length === 0) {
        console.error("ไม่มีคำถามในระบบ");
        return;
    }
    
    // ตรวจสอบว่ามี elements ที่จำเป็นหรือไม่
    const currentQuestionElement = document.getElementById('current-question');
    const totalQuestionsElement = document.getElementById('total-questions');
    const quizQuestionElement = document.getElementById('quiz-question');
    const quizImageElement = document.getElementById('quiz-image');
    const quizChoicesElement = document.getElementById('quiz-choices');
    
    if (!currentQuestionElement || !totalQuestionsElement || !quizQuestionElement || 
        !quizImageElement || !quizChoicesElement) {
        console.error("ไม่พบ elements ที่จำเป็นสำหรับการแสดงคำถาม");
        return;
    }
    
    // อัพเดตข้อมูลคำถามปัจจุบัน
    currentQuestionElement.textContent = `คำถามที่ ${currentQuestionIndex + 1}`;
    totalQuestionsElement.textContent = currentGameQuestions.length;
    
    // แสดงคำถามปัจจุบัน
    const questionIndex = randomQuestionOrder[currentQuestionIndex];
    const currentQuestion = currentGameQuestions[questionIndex];
    
    quizQuestionElement.textContent = currentQuestion.text;
    
    // แสดงรูปภาพ (ถ้ามี และถ้าเป็น URL ที่ถูกต้อง)
    if (currentQuestion.image && 
        (currentQuestion.image.startsWith('data:') || 
         currentQuestion.image.startsWith('http://') || 
         currentQuestion.image.startsWith('https://'))) {
        quizImageElement.src = currentQuestion.image;
        quizImageElement.classList.remove('hidden');
    } else {
        quizImageElement.src = ''; // รีเซ็ต src ให้ว่างเพื่อไม่ให้แสดงไอคอนรูปแตก
        quizImageElement.classList.add('hidden');
    }
    
    // แสดงตัวเลือก
    quizChoicesElement.innerHTML = '';
    
    // ดึงลำดับตัวเลือกที่สลับไว้
    const choiceOrder = choiceOrderMap[questionIndex] || [0, 1, 2, 3];
    console.log("ลำดับการแสดงตัวเลือกคำถามที่ " + (currentQuestionIndex + 1) + ":", choiceOrder);
    
    // คำตอบที่เลือกไว้
    const userAnswer = userAnswers[questionIndex];
    
    // สร้างตัวเลือกและจัดการการคลิก
    const handleOptionClick = function(selectedId) {
        console.log("เลือกคำตอบ:", selectedId, "สำหรับคำถามที่", currentQuestionIndex);
        
        // ลบคลาส selected จากทุกปุ่ม
        const buttons = quizChoicesElement.querySelectorAll('.option-btn');
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('selected');
        }
        
        // หาปุ่มที่มีข้อมูลตรงกับที่เลือกและเพิ่มคลาส selected
        const targetButton = quizChoicesElement.querySelector(`.option-btn[data-choice-id="${selectedId}"]`);
        if (targetButton) {
            targetButton.classList.add('selected');
        }
        
        // บันทึกคำตอบ
        userAnswers[questionIndex] = selectedId;
        console.log("บันทึกคำตอบ:", userAnswers);
    };
    
    // สร้างตัวเลือกตามลำดับที่สลับไว้
    const choiceLabels = ['A', 'B', 'C', 'D']; // รายการตัวอักษรสำหรับตัวเลือก
    
    choiceOrder.forEach((index, displayIndex) => {
        if (!currentQuestion.choices || !currentQuestion.choices[index]) {
            console.error("ไม่พบข้อมูลตัวเลือกที่", index);
            return;
        }
        
        const choice = currentQuestion.choices[index];
        
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.dataset.choiceId = choice.id; // เก็บ ID ดั้งเดิมไว้เพื่อใช้ในการตรวจคำตอบ
        
        // ตรวจสอบว่าผู้เล่นเลือกตัวเลือกนี้หรือไม่
        if (userAnswer === choice.id) {
            button.classList.add('selected');
        }
        
        // แสดงตัวอักษรตามลำดับการแสดงผล ไม่ใช่ตาม id ดั้งเดิม
        button.innerHTML = `${choiceLabels[displayIndex]}. ${choice.text}`;
        
        // เพิ่ม event listener
        button.onclick = function(e) {
            e.preventDefault(); // ป้องกันพฤติกรรมปกติของปุ่ม
            handleOptionClick(choice.id);
        };
        
        quizChoicesElement.appendChild(button);
    });
    
    // อัพเดตปุ่มนำทาง
    updateNavigationButtons();
    
    console.log("อัพเดตหน้าเล่นเกมเรียบร้อยแล้ว");
}

// อัพเดตปุ่มนำทาง
function updateNavigationButtons() {
    const prevButton = document.getElementById('prev-question');
    const nextButton = document.getElementById('next-question');
    const submitButton = document.getElementById('submit-answer');
    
    // ซ่อน/แสดงปุ่มตามความเหมาะสม
    if (currentQuestionIndex > 0) {
        prevButton.classList.remove('hidden');
    } else {
        prevButton.classList.add('hidden');
    }
    
    if (currentQuestionIndex < currentGameQuestions.length - 1) {
        nextButton.classList.remove('hidden');
    } else {
        nextButton.classList.add('hidden');
    }
    
    // แสดงปุ่มส่งคำตอบเสมอ (ไม่ต้องรอให้เลือกคำตอบ)
    submitButton.classList.remove('hidden');
}
// แทนที่ฟังก์ชัน submitAnswer ทั้งหมด
function submitAnswer() {
    console.log("กำลังตรวจสอบคำตอบ...");
    
    // ตรวจสอบว่ามีคำถามหรือไม่
    if (!Array.isArray(currentGameQuestions) || currentGameQuestions.length === 0) {
        console.error("ไม่มีคำถามในระบบ");
        return;
    }
    
    // บันทึกคำตอบอีกครั้งให้แน่ใจ
    const questionIndex = randomQuestionOrder[currentQuestionIndex];
    const selectedOption = document.querySelector('.option-btn.selected');
    if (selectedOption) {
        userAnswers[questionIndex] = selectedOption.dataset.choiceId;
    }
    
    console.log(`ตอบคำถามข้อที่ ${currentQuestionIndex + 1}/${currentGameQuestions.length}`);
    
    // ถ้าถึงข้อสุดท้ายหรือมีเพียงข้อเดียว
    if (currentGameQuestions.length === 1 || currentQuestionIndex >= currentGameQuestions.length - 1) {
        console.log("ถึงข้อสุดท้ายแล้ว ตรวจสอบว่าตอบครบทุกข้อหรือไม่");
        
        // ตรวจสอบว่าตอบคำถามครบทุกข้อหรือไม่
        const { allAnswered, unansweredQuestions } = checkAllAnswered();
        
        if (!allAnswered) {
            // ถ้ายังตอบไม่ครบ แจ้งเตือนผู้เล่น
            alert(`คุณยังไม่ได้ตอบคำถามข้อที่: ${unansweredQuestions.join(', ')} กรุณาตอบให้ครบทุกข้อ`);
            
            // ไปที่ข้อแรกที่ยังไม่ได้ตอบ
            currentQuestionIndex = unansweredQuestions[0] - 1;
            updateQuizScreen();
        } else {
            // ถ้าตอบครบแล้ว แสดงผลลัพธ์
            showResult();
        }
    } else {
        // มีข้อถัดไป ไปที่ข้อถัดไป
        showNextQuestion();
    }
}

// ฟังก์ชันตรวจสอบว่าตอบครบทุกข้อหรือไม่ก่อนแสดงผลลัพธ์
function checkAllAnsweredAndShowResult() {
    const unansweredQuestions = [];
    
    // ตรวจสอบทุกคำถามว่าได้รับคำตอบหรือไม่
    for (let i = 0; i < randomQuestionOrder.length; i++) {
        const questionIndex = randomQuestionOrder[i];
        if (!userAnswers[questionIndex]) {
            unansweredQuestions.push(i + 1); // เก็บลำดับคำถามที่ยังไม่ได้ตอบ
        }
    }
    
    if (unansweredQuestions.length > 0) {
        // แสดงคำเตือนถ้ายังมีคำถามที่ไม่ได้ตอบ
        let message = 'คุณยังไม่ได้ตอบคำถามบางข้อ:\n';
        message += 'ข้อที่: ' + unansweredQuestions.join(', ');
        message += '\nกรุณาตอบคำถามให้ครบทุกข้อก่อนดูผลลัพธ์';
        alert(message);
        
        // ไปที่คำถามแรกที่ยังไม่ได้ตอบ
        currentQuestionIndex = unansweredQuestions[0] - 1;
        updateQuizScreen();
    } else {
        // ตอบครบทุกข้อแล้ว แสดงผลลัพธ์
        showResult();
    }
}
function showNextQuestion() {
    if (currentQuestionIndex < currentGameQuestions.length - 1) {
        currentQuestionIndex++;
        updateQuizScreen();
    }
}

function showPrevQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        updateQuizScreen();
    }
}

// ฟังก์ชันตรวจสอบว่าตอบครบทุกข้อหรือไม่
function checkAllAnswered() {
    const unansweredQuestions = [];
    
    for (let i = 0; i < randomQuestionOrder.length; i++) {
        const qIndex = randomQuestionOrder[i];
        if (!userAnswers[qIndex]) {
            unansweredQuestions.push(i + 1);
        }
    }
    
    return {
        allAnswered: unansweredQuestions.length === 0,
        unansweredQuestions: unansweredQuestions
    };
}

// แทนที่ฟังก์ชัน showResult ทั้งหมด
function showResult() {
    console.log("กำลังแสดงผลลัพธ์...");
    
    // ตรวจสอบว่ามีคำถามหรือไม่
    if (!Array.isArray(currentGameQuestions) || currentGameQuestions.length === 0) {
        console.error("ไม่มีคำถามในระบบ");
        return;
    }
    
    console.log("แสดงผลลัพธ์: คำถามทั้งหมด =", currentGameQuestions.length);
    console.log("คำตอบของผู้ใช้:", userAnswers);
    
    // ซ่อนหน้าเล่นเกม
    const quizScreen = document.getElementById('quiz-screen');
    if (quizScreen) quizScreen.classList.add('hidden');
    
    // แสดงหน้าผลลัพธ์
    const resultScreen = document.getElementById('result-screen');
    if (!resultScreen) {
        console.error("ไม่พบ element 'result-screen'");
        return;
    }
    
    resultScreen.classList.remove('hidden');
    
    // นับคะแนน
    let correctCount = 0;
    
    // สร้าง HTML สำหรับแสดงคำตอบทั้งหมด
    const questionReview = resultScreen.querySelector('#question-review');
    if (!questionReview) {
        console.error("ไม่พบ element 'question-review'");
        return;
    }
    
    questionReview.innerHTML = '';
    
    // ดึงข้อมูลหมวดหมู่จากคำถามแรก
    const firstQuestion = currentGameQuestions[randomQuestionOrder[0]];
    if (firstQuestion && firstQuestion.category) {
        const categoryInfo = document.createElement('div');
        categoryInfo.className = 'category-summary';
        categoryInfo.innerHTML = `
            <div class="category-title">หมวดหมู่:</div>
            <div class="category-path">${firstQuestion.category.main || 'ไม่ระบุ'} > ${firstQuestion.category.sub1 || 'ไม่ระบุ'} > ${firstQuestion.category.sub2 || 'ไม่ระบุ'}</div>
        `;
        questionReview.appendChild(categoryInfo);
    }
    
    // สร้างรายการคำถามและคำตอบ
    randomQuestionOrder.forEach((questionIndex, index) => {
        const question = currentGameQuestions[questionIndex];
        const userAnswer = userAnswers[questionIndex] || ''; // อาจเป็น undefined ถ้าไม่ได้ตอบ
        const isCorrect = userAnswer === question.correctAnswer;
        
        if (isCorrect) {
            correctCount++;
        }
        
        // สร้าง HTML สำหรับคำถามนี้
        const reviewItem = document.createElement('div');
        reviewItem.className = `question-review-item ${isCorrect ? 'correct' : 'incorrect'}`;
        
        let choicesHTML = '';
        question.choices.forEach(choice => {
            const isUserSelected = choice.id === userAnswer;
            const isCorrectAnswer = choice.id === question.correctAnswer;
            
            let className = 'choice-item';
            if (isUserSelected) className += ' user-selected';
            if (isCorrectAnswer) className += ' correct-answer';
            
            let icon = '';
            if (isUserSelected && isCorrectAnswer) {
                icon = '<span class="choice-icon correct-icon">✓</span>';
            } else if (isUserSelected && !isCorrectAnswer) {
                icon = '<span class="choice-icon incorrect-icon">✗</span>';
            } else if (!isUserSelected && isCorrectAnswer) {
                icon = '<span class="choice-icon correct-icon">✓</span>';
            }
            
            choicesHTML += `
                <div class="${className}">
                    <span class="choice-marker">${choice.id}</span>
                    <span class="choice-text">${choice.text}</span>
                    ${icon}
                </div>
            `;
        });
        
        reviewItem.innerHTML = `
            <div class="question-number">
                <span>ข้อที่ ${index + 1}</span>
                <span class="question-status ${isCorrect ? 'status-correct' : 'status-incorrect'}">
                    ${isCorrect ? 'ตอบถูก' : 'ตอบผิด'}
                </span>
            </div>
            <div class="question-text">${question.text}</div>
            ${question.image ? `<img src="${question.image}" class="question-image">` : ''}
            <div class="choice-list">
                ${choicesHTML}
            </div>
        `;
        
        questionReview.appendChild(reviewItem);
    });
    
    // คำนวณเปอร์เซ็นต์
    const percentage = Math.round((correctCount / currentGameQuestions.length) * 100);
    
    // อัพเดตผลลัพธ์
    const scoreElement = resultScreen.querySelector('#score');
    const maxScoreElement = resultScreen.querySelector('#max-score');
    const percentCorrectElement = resultScreen.querySelector('#percent-correct');
    const correctAnswersElement = resultScreen.querySelector('#correct-answers');
    const incorrectAnswersElement = resultScreen.querySelector('#incorrect-answers');
    const totalQuestionsStatsElement = resultScreen.querySelector('#total-questions-stats');
    
    if (scoreElement) scoreElement.textContent = correctCount;
    if (maxScoreElement) maxScoreElement.textContent = currentGameQuestions.length;
    if (percentCorrectElement) percentCorrectElement.textContent = `${percentage}%`;
    if (correctAnswersElement) correctAnswersElement.textContent = correctCount;
    if (incorrectAnswersElement) incorrectAnswersElement.textContent = currentGameQuestions.length - correctCount;
    if (totalQuestionsStatsElement) totalQuestionsStatsElement.textContent = currentGameQuestions.length;
    
    // บันทึกประวัติการเล่น
    if (currentPlayer) {
        // ดึงหมวดหมู่จากคำถามแรก
        const category = firstQuestion ? firstQuestion.category : null;
        
        // บันทึกประวัติ
        addGameHistoryEntry(currentPlayer, correctCount, currentGameQuestions.length, category, percentage);
    }
    
    // อัพเดตการแสดงผลหน้าต่างๆ
    updatePlayScreenVisibility();
    
    console.log("แสดงผลลัพธ์เรียบร้อยแล้ว");
}

// ปุ่มเล่นอีกครั้ง
function restartQuiz() {
    console.log("เริ่มเล่นเกมใหม่...");
    
    // ซ่อนหน้าผลลัพธ์
    const resultScreen = document.getElementById('result-screen');
    if (resultScreen) resultScreen.classList.add('hidden');
    
    // ซ่อนหน้าเล่นเกม
    const quizScreen = document.getElementById('quiz-screen');
    if (quizScreen) quizScreen.classList.add('hidden');
    
    // แสดงหน้าเลือกหมวดหมู่
    const categorySelectionContainer = document.getElementById('category-selection-container');
    if (categorySelectionContainer) {
        categorySelectionContainer.classList.remove('hidden');
    }
    
    // แสดงหน้าเริ่มต้น
    const startScreen = document.getElementById('start-screen');
    if (startScreen) startScreen.classList.remove('hidden');
    
    // รีเซ็ตค่าต่างๆ
    currentQuestionIndex = 0;
    userAnswers = {};
    randomQuestionOrder = [];
    choiceOrderMap = {};
    
    // อัพเดตตัวเลือกหมวดหมู่ในหน้าเล่นเกม (กรณีที่อาจมีหมวดหมู่เพิ่ม/ลบ)
    updatePlayMainCategorySelect();
}

// เริ่มต้นระบบเล่นเกม
function initPlaySystem() {
    updatePlaySystem();
    console.log('ระบบเล่นเกมพร้อมใช้งานแล้ว');
}

// ปรับปรุงระบบเลือกหมวดหมู่ในการเล่นเกม
function updatePlaySystemWithCategories() {
    // หา container ของแท็บเล่นเกม
    const playContent = document.getElementById('play-content');
    if (!playContent) {
        console.error("ไม่พบ element 'play-content'");
        return;
    }

    // หา startScreen ภายใน play-content เท่านั้น
    const startScreen = playContent.querySelector('#start-screen');
    if (startScreen) {
        // ตรวจสอบว่ามี div เลือกหมวดหมู่หรือไม่
        if (!playContent.querySelector('#play-categories')) {
            // สร้าง div สำหรับเลือกหมวดหมู่
            const categoriesDiv = document.createElement('div');
            categoriesDiv.id = 'play-categories';
            categoriesDiv.className = 'category-selection-container';
            
            categoriesDiv.innerHTML = `
                <div class="category-selection-header">
                    <h3>เลือกหมวดหมู่ที่ต้องการเล่น</h3>
                    <p>กรุณาเลือกหมวดหมู่เพื่อเริ่มเล่นเกมตอบคำถาม</p>
                </div>
                
                <div class="category-selection-form">
                    <div class="category-field">
                        <label for="play-main-category">หมวดหมู่หลัก</label>
                        <div class="select-wrapper">
                            <select id="play-main-category" required>
                                <option value="" disabled selected>เลือกหมวดหมู่หลัก</option>
                            </select>
                            <div class="select-arrow"></div>
                        </div>
                    </div>
                    
                    <div class="category-field">
                        <label for="play-sub-category1">หมวดหมู่ย่อย 1</label>
                        <div class="select-wrapper">
                            <select id="play-sub-category1" disabled required>
                                <option value="" disabled selected>เลือกหมวดหมู่ย่อย 1</option>
                            </select>
                            <div class="select-arrow"></div>
                        </div>
                    </div>
                    
                    <div class="category-field">
                        <label for="play-sub-category2">หมวดหมู่ย่อย 2</label>
                        <div class="select-wrapper">
                            <select id="play-sub-category2" disabled required>
                                <option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>
                            </select>
                            <div class="select-arrow"></div>
                        </div>
                    </div>
                </div>
            `;

            // เพิ่ม CSS สำหรับสไตล์ใหม่ (คงไว้เหมือนเดิม)
            const styleElement = document.createElement('style');
            styleElement.textContent = `
    .category-selection-container {
        background: linear-gradient(145deg, #ffffff, #f0f7ff);
        border-radius: 16px;
        box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
        padding: 25px;
        margin: 0 auto 25px;
        border: 1px solid rgba(25, 118, 210, 0.1);
        max-width: 500px; /* จำกัดความกว้างสูงสุด */
    }
        
    .category-selection-header {
        text-align: center;
        margin-bottom: 20px; /* ปรับลดขนาดช่องว่าง */
    }
    
    .category-selection-header h3 {
        color: #1976d2;
        font-size: 20px; /* ลดขนาดฟอนต์ลง */
        font-weight: 600;
        margin-bottom: 8px;
        position: relative;
        display: inline-block;
    }
    
    .category-selection-header h3:after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, #1976d2, #4791db);
        border-radius: 3px;
    }
    
    .category-selection-header p {
        color: #555;
        font-size: 15px; /* ลดขนาดฟอนต์ลง */
        margin-top: 12px;
    }
    
    .category-selection-form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px; /* ลดช่องว่างระหว่างฟิลด์ */
    }
    
    .category-field {
        margin-bottom: 3px; /* ลดช่องว่าง */
    }
    
    .category-field label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1976d2;
        margin-bottom: 6px; /* ลดช่องว่าง */
        transition: all 0.2s ease;
    }
    
    .select-wrapper {
        position: relative;
    }
    
    .select-wrapper select {
        width: 100%;
        padding: 10px 14px; /* ลดขนาด padding */
        border: 2px solid #e0e0e0;
        border-radius: 10px; /* ลดความโค้ง */
        background-color: white;
        font-size: 15px; /* ลดขนาดฟอนต์ */
        font-weight: 500;
        color: #333;
        appearance: none;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .select-wrapper select:focus {
        border-color: #1976d2;
        box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.25);
        outline: none;
    }
    
    .select-wrapper select:hover:not(:disabled) {
        border-color: #1976d2;
        background-color: #f8f9ff;
    }
    
    .select-wrapper select:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }
    
    .select-arrow {
        position: absolute;
        top: 50%;
        right: 14px;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #1976d2;
        pointer-events: none;
        transition: all 0.2s ease;
    }
    
    .select-wrapper:hover .select-arrow {
        border-top-color: #115293;
    }
    
    #start-quiz {
        background: linear-gradient(45deg, #1976d2, #4791db);
        color: white;
        border: none;
        padding: 12px 25px; /* ลดขนาด padding */
        font-size: 16px; /* ลดขนาดฟอนต์ */
        font-weight: 600;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin: 20px auto 0; /* ลดขนาดช่องว่าง */
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        letter-spacing: 0.5px;
    }
    
    #start-quiz:hover {
        background: linear-gradient(45deg, #115293, #1976d2);
        transform: translateY(-2px); /* ลดการเคลื่อนไหว */
        box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
    }
    
    #start-quiz:active {
        transform: translateY(0);
        box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
    }
    
    @media (max-width: 600px) {
        .category-selection-container {
            padding: 18px;
            margin: 0 15px 20px;
        }
        
        .category-selection-header h3 {
            font-size: 18px;
        }
        
        .category-selection-header p {
            font-size: 14px;
        }
    }
`;
            
            document.head.appendChild(styleElement);
            
            // แก้ไขสไตล์สำหรับกรอบเกมตอบคำถาม (คงไว้เหมือนเดิม)
            const fixContainerStyle = document.createElement('style');
            fixContainerStyle.textContent = `
                .container {
                transform: none !important;
                transition: box-shadow 0.3s ease;
                }
                .container:hover {
                transform: none !important;
                }
            `;
            document.head.appendChild(fixContainerStyle);

            // ตรวจสอบว่ามีปุ่ม start-quiz หรือไม่
            const startButton = startScreen.querySelector('#start-quiz');
            if (startButton) {
                // เพิ่ม div ก่อนปุ่มเริ่มเล่น แต่อยู่ภายใน startScreen
                startScreen.insertBefore(categoriesDiv, startButton);
            } else {
                // ถ้าไม่พบปุ่ม เพิ่มต่อท้าย
                startScreen.appendChild(categoriesDiv);
            }
            
            // อัพเดตตัวเลือกหมวดหมู่หลัก
            updatePlayMainCategorySelect();
            
            // Event Listener สำหรับการเปลี่ยนหมวดหมู่หลัก
            const playMainCategory = document.getElementById('play-main-category');
            const playSubCategory1 = document.getElementById('play-sub-category1');
            const playSubCategory2 = document.getElementById('play-sub-category2');
            
            if (playMainCategory) {
                playMainCategory.addEventListener('change', function() {
                    const mainCategory = this.value;
                    
                    // รีเซ็ตค่าของ dropdown หมวดย่อย
                    playSubCategory1.value = '';
                    playSubCategory2.value = '';
                    
                    // รีเซ็ตตัวเลือกหมวดย่อย 2
                    playSubCategory2.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>';
                    playSubCategory2.disabled = true;
                    
                    if (mainCategory) {
                        updateSubCategory1Select(playSubCategory1, mainCategory);
                    } else {
                        playSubCategory1.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 1</option>';
                        playSubCategory1.disabled = true;
                    }
                });
            }
            
            if (playSubCategory1) {
                playSubCategory1.addEventListener('change', function() {
                    const mainCategory = playMainCategory.value;
                    const subCategory1 = this.value;
                    
                    // รีเซ็ตค่าของ dropdown หมวดย่อย 2
                    playSubCategory2.value = '';
                    
                    if (mainCategory && subCategory1) {
                        updateSubCategory2Select(playSubCategory2, mainCategory, subCategory1);
                    } else {
                        playSubCategory2.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>';
                        playSubCategory2.disabled = true;
                    }
                });
            }
        }
    }
    
    // แก้ไขปุ่มเริ่มเล่น
    const startQuizBtn = playContent.querySelector('#start-quiz');
    if (startQuizBtn) {
        // ดึง event listener เดิมออก (ถ้ามี)
        const newStartQuiz = startQuizBtn.cloneNode(true);
        startQuizBtn.parentNode.replaceChild(newStartQuiz, startQuizBtn);
        
        // เพิ่ม event listener ใหม่
        newStartQuiz.addEventListener('click', function() {
            // ตรวจสอบการเลือกหมวดหมู่
            const mainCategory = document.getElementById('play-main-category').value;
            const subCategory1 = document.getElementById('play-sub-category1').value;
            const subCategory2 = document.getElementById('play-sub-category2').value;
            
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลัก');
                return;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 1');
                return;
            }
            
            if (!subCategory2) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 2');
                return;
            }
            
            // กรองคำถามตามหมวดหมู่
            currentGameQuestions = questions.filter(q => 
                q.category && 
                q.category.main === mainCategory && 
                q.category.sub1 === subCategory1 && 
                q.category.sub2 === subCategory2
            );
            
            if (currentGameQuestions.length === 0) {
                alert('ไม่พบคำถามในหมวดหมู่ที่เลือก');
                return;
            }
            
            console.log(`พบคำถามในหมวดหมู่ที่เลือก: ${currentGameQuestions.length} ข้อ`);
            
            // เริ่มเล่นเกม
            startQuiz();
        });
    }
}

// แทนที่ฟังก์ชัน updatePlayMainCategorySelect ทั้งหมด
function updatePlayMainCategorySelect() {
    console.log("กำลังอัพเดตตัวเลือกหมวดหมู่หลักในหน้าเล่นเกม...");
    
    const playMainCategory = document.getElementById('play-main-category');
    if (!playMainCategory) {
        console.warn("ไม่พบ element 'play-main-category'");
        return;
    }
    
    // เก็บตัวเลือกแรกไว้
    const firstOption = document.createElement('option');
    firstOption.value = "";
    firstOption.textContent = "เลือกหมวดหมู่หลัก";
    firstOption.disabled = true;
    firstOption.selected = true;
    
    // ล้างตัวเลือกเดิม
    playMainCategory.innerHTML = '';
    playMainCategory.appendChild(firstOption);
    
    // เพิ่มหมวดหมู่หลักที่มีอยู่
    for (const mainCategory in categories) {
        const option = document.createElement('option');
        option.value = mainCategory;
        option.textContent = mainCategory;
        playMainCategory.appendChild(option);
    }
    
    // รีเซ็ตตัวเลือกหมวดหมู่ย่อย
    const playSubCategory1 = document.getElementById('play-sub-category1');
    const playSubCategory2 = document.getElementById('play-sub-category2');
    
    if (playSubCategory1) {
        playSubCategory1.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 1</option>';
        playSubCategory1.disabled = true;
    }
    
    if (playSubCategory2) {
        playSubCategory2.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>';
        playSubCategory2.disabled = true;
    }
    
    console.log("อัพเดตตัวเลือกหมวดหมู่หลักในหน้าเล่นเกมเรียบร้อยแล้ว");
}

// แทนที่ฟังก์ชัน enableCategoryPlaySystem ทั้งหมด
function enableCategoryPlaySystem() {
    console.log("กำลังตั้งค่าระบบเล่นเกมให้รองรับหมวดหมู่...");
    
    // อัพเดตตัวเลือกหมวดหมู่ในหน้าเล่นเกม
    updatePlayMainCategorySelect();
    
    // ตั้งค่า event listeners สำหรับตัวเลือกหมวดหมู่
    setupPlayCategoryListeners();
    
    // อัพเดตตัวเลือกหมวดหมู่เมื่อมีการเปลี่ยนแปลงหมวดหมู่
    const oldUpdateCategoryUI = updateCategoryUI;
    updateCategoryUI = function() {
        oldUpdateCategoryUI();
        updatePlayMainCategorySelect();
    };
    
    console.log("ระบบเล่นเกมพร้อมใช้งานแล้ว");
}

// เพิ่มฟังก์ชันใหม่นี้ถัดจาก enableCategoryPlaySystem
function setupPlayCategoryListeners() {
    console.log("กำลังตั้งค่าตัวฟังเหตุการณ์สำหรับตัวเลือกหมวดหมู่ในหน้าเล่นเกม...");
    
    const playMainCategory = document.getElementById('play-main-category');
    const playSubCategory1 = document.getElementById('play-sub-category1');
    const playSubCategory2 = document.getElementById('play-sub-category2');
    
    if (!playMainCategory || !playSubCategory1 || !playSubCategory2) {
        console.warn("ไม่พบ elements ของตัวเลือกหมวดหมู่ในหน้าเล่นเกม");
        return;
    }
    
    // ตั้งค่า event listener สำหรับหมวดหมู่หลัก
    playMainCategory.addEventListener('change', function() {
        const mainCategory = this.value;
        
        // รีเซ็ตค่าของ dropdown หมวดย่อย
        playSubCategory1.value = '';
        playSubCategory2.value = '';
        
        // รีเซ็ตตัวเลือกหมวดย่อย 2
        playSubCategory2.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>';
        playSubCategory2.disabled = true;
        
        if (mainCategory) {
            updateSubCategory1Select(playSubCategory1, mainCategory);
        } else {
            playSubCategory1.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 1</option>';
            playSubCategory1.disabled = true;
        }
    });
    
    // ตั้งค่า event listener สำหรับหมวดหมู่ย่อย 1
    playSubCategory1.addEventListener('change', function() {
        const mainCategory = playMainCategory.value;
        const subCategory1 = this.value;
        
        // รีเซ็ตค่าของ dropdown หมวดย่อย 2
        playSubCategory2.value = '';
        
        if (mainCategory && subCategory1) {
            updateSubCategory2Select(playSubCategory2, mainCategory, subCategory1);
        } else {
            playSubCategory2.innerHTML = '<option value="" disabled selected>เลือกหมวดหมู่ย่อย 2</option>';
            playSubCategory2.disabled = true;
        }
    });
    
    // ตั้งค่า event listener สำหรับปุ่มเริ่มเล่น
    const startQuizBtn = document.getElementById('start-quiz');
    if (startQuizBtn) {
        // ลบ event listeners เดิม (ถ้ามี)
        const newStartQuiz = startQuizBtn.cloneNode(true);
        if (startQuizBtn.parentNode) {
            startQuizBtn.parentNode.replaceChild(newStartQuiz, startQuizBtn);
        }
        
        // เพิ่ม event listener ใหม่
        newStartQuiz.addEventListener('click', function() {
            // ตรวจสอบการเลือกหมวดหมู่
            const mainCategory = document.getElementById('play-main-category').value;
            const subCategory1 = document.getElementById('play-sub-category1').value;
            const subCategory2 = document.getElementById('play-sub-category2').value;
            
            if (!mainCategory) {
                alert('กรุณาเลือกหมวดหมู่หลัก');
                return;
            }
            
            if (!subCategory1) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 1');
                return;
            }
            
            if (!subCategory2) {
                alert('กรุณาเลือกหมวดหมู่ย่อย 2');
                return;
            }
            
            // กรองคำถามตามหมวดหมู่
            currentGameQuestions = questions.filter(q => 
                q.category && 
                q.category.main === mainCategory && 
                q.category.sub1 === subCategory1 && 
                q.category.sub2 === subCategory2
            );
            
            if (currentGameQuestions.length === 0) {
                alert('ไม่พบคำถามในหมวดหมู่ที่เลือก');
                return;
            }
            
            console.log(`พบคำถามในหมวดหมู่ที่เลือก: ${currentGameQuestions.length} ข้อ`);
            
            // เริ่มเล่นเกม
            startQuiz();
        });
    }
    
    console.log("ตั้งค่าตัวฟังเหตุการณ์สำหรับตัวเลือกหมวดหมู่ในหน้าเล่นเกมเรียบร้อยแล้ว");
}

// เพิ่มในส่วน DOMContentLoaded
document.addEventListener('DOMContentLoaded', async function() {
    // เพิ่มคลาส fade-in เพื่อให้เนื้อหาค่อยๆ ปรากฏ
    document.getElementById('play-content').classList.add('fade-in');
    
    // เริ่มต้นแอปพลิเคชัน
    await initializeApp(); // ใหม่
});

function initPlayerSystem() {
    console.log("กำลังเริ่มต้นระบบผู้เล่น...");
    
    // กำหนดค่าเริ่มต้นให้ currentPlayer
    currentPlayer = null;
    
    // โหลดชื่อผู้เล่นจาก localStorage (ถ้ามี) แต่ไม่ล็อกอินอัตโนมัติ
    const savedPlayerName = localStorage.getItem('quiz-player-name');
    
    // เพิ่ม event listeners
    const playerNameInput = document.getElementById('player-name');
    const loginButton = document.getElementById('login-button');
    
    if (playerNameInput && loginButton) {
        // ตรวจสอบการพิมพ์ชื่อผู้เล่น
        playerNameInput.addEventListener('input', function() {
            // ปุ่มล็อกอินจะใช้งานได้เมื่อมีการกรอกชื่อ
            loginButton.disabled = this.value.trim() === '';
        });
        
        // กรอกชื่อผู้เล่นที่บันทึกไว้ (ถ้ามี)
        if (savedPlayerName) {
            playerNameInput.value = savedPlayerName;
            loginButton.disabled = false;
        }
        
        // เหตุการณ์เมื่อคลิกปุ่มล็อกอิน
        loginButton.addEventListener('click', loginPlayer);
        
        // รองรับการกด Enter ในช่องกรอกชื่อ
        playerNameInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter' && this.value.trim() !== '') {
                loginPlayer();
            }
        });
    }
    
    // สำคัญมาก: ตั้งค่าการแสดงผลของหน้า login และหน้าอื่นๆ
    updateLoginDisplay();
    
    console.log("ระบบผู้เล่นพร้อมใช้งานแล้ว");
}

function updateLoginDisplay() {
    console.log("กำลังอัพเดตการแสดงผลหน้าล็อกอิน...");
    
    const loginScreen = document.getElementById('login-screen');
    const startScreen = document.getElementById('start-screen');
    const categorySelectionContainer = document.getElementById('category-selection-container');
    
    if (!loginScreen || !startScreen) {
        console.error("ไม่พบ elements ที่จำเป็น");
        return;
    }
    
    // ตรวจสอบว่าอยู่ในแท็บเล่นเกมหรือไม่
    const playTabActive = document.getElementById('play-tab').classList.contains('active');
    
    if (playTabActive) {
        if (currentPlayer) {
            // ถ้าล็อกอินแล้ว ซ่อนหน้าล็อกอิน แสดงหน้าเริ่มเล่นและหน้าเลือกหมวดหมู่
            loginScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            if (categorySelectionContainer) categorySelectionContainer.classList.remove('hidden');
            
            // เพิ่มชื่อผู้เล่นเข้าไปในกรอบเกม
            const quizContainer = document.querySelector('.container.quiz-player');
            if (quizContainer && !quizContainer.querySelector('.player-info.top-right')) {
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info top-right';
                playerInfo.innerHTML = `
                    <div class="player-name">ผู้เล่น: ${currentPlayer.name}</div>
                `;
                quizContainer.appendChild(playerInfo);
            }
        } else {
            // ถ้ายังไม่ได้ล็อกอิน แสดงหน้าล็อกอิน ซ่อนหน้าอื่นๆ
            loginScreen.classList.remove('hidden');
            startScreen.classList.add('hidden');
            if (categorySelectionContainer) categorySelectionContainer.classList.add('hidden');
        }
    } else {
        // ซ่อนหน้าล็อกอินเมื่ออยู่ในแท็บอื่น
        loginScreen.classList.add('hidden');
    }
    
    console.log("อัพเดตการแสดงผลหน้าล็อกอินเรียบร้อยแล้ว");
}

// เพิ่มฟังก์ชันนี้ในไฟล์ JavaScript ของคุณ
function updatePlayScreenVisibility() {
    const resultScreen = document.getElementById('result-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const categorySelectionContainer = document.getElementById('category-selection-container');
    const startScreen = document.getElementById('start-screen');
    const loginScreen = document.getElementById('login-screen');
    
    // ถ้าไม่มี element ที่จำเป็น ให้ออกจากฟังก์ชันเลย
    if (!resultScreen || !categorySelectionContainer || !startScreen) {
        console.error("ไม่พบ elements ที่จำเป็นสำหรับการแสดงผลหน้าเล่นเกม");
        return;
    }
    
    // 1. ตรวจสอบสถานะล็อกอิน
    if (!currentPlayer) {
        // ถ้ายังไม่ได้ล็อกอิน
        if (loginScreen) loginScreen.classList.remove('hidden');
        startScreen.classList.add('hidden');
        categorySelectionContainer.classList.add('hidden');
        quizScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        return;
    }
    
    // 2. ถ้าล็อกอินแล้ว ซ่อนหน้าล็อกอิน
    if (loginScreen) loginScreen.classList.add('hidden');
    
    // 3. ตรวจสอบว่ากำลังแสดงผลคะแนนอยู่หรือไม่
    if (!resultScreen.classList.contains('hidden')) {
        // กำลังแสดงผลคะแนนอยู่ ซ่อนหน้าอื่นๆ ทั้งหมด
        startScreen.classList.add('hidden');
        categorySelectionContainer.classList.add('hidden');
        quizScreen.classList.add('hidden');
    } else if (!quizScreen.classList.contains('hidden')) {
        // กำลังเล่นเกมอยู่ ซ่อนหน้าอื่นๆ
        startScreen.classList.add('hidden');
        categorySelectionContainer.classList.add('hidden');
        resultScreen.classList.add('hidden');
    } else {
        // ไม่ได้เล่นเกมและไม่ได้แสดงผลคะแนน แสดงหน้าเริ่มเล่นและเลือกหมวดหมู่
        startScreen.classList.remove('hidden');
        categorySelectionContainer.classList.remove('hidden');
        resultScreen.classList.add('hidden');
        quizScreen.classList.add('hidden');
    }
}

function loginPlayer() {
    const playerNameInput = document.getElementById('player-name');
    const rememberPlayer = document.getElementById('remember-player');
    
    if (!playerNameInput) {
        console.error("ไม่พบ element 'player-name'");
        return;
    }
    
    // ตรวจสอบว่ามีการกรอกชื่อผู้เล่นหรือไม่
    const playerName = playerNameInput.value.trim();
    if (!playerName) {
        alert('กรุณากรอกชื่อผู้เล่น');
        return;
    }

    // ตรวจสอบว่าเป็นการเข้าสู่โหมดแอดมินหรือไม่
    if (playerName.toLowerCase() === 'admin') {
        showAdminLoginForm();
        return;
    }
    
    // ป้องกันการใช้ชื่อ admin
    if (playerName.toLowerCase().includes('admin')) {
        alert('ไม่สามารถใช้ชื่อที่มีคำว่า "admin" ได้ กรุณาเลือกชื่ออื่น');
        return;
    }
    
    // ล็อกอินผู้เล่นธรรมดา
    currentPlayer = {
        name: playerName,
        loginTime: new Date().toISOString(),
        avatar: getPlayerInitials(playerName)
    };
    
    // บันทึกชื่อผู้เล่นลงใน localStorage ถ้าเลือก "จำชื่อของฉัน"
    if (rememberPlayer && rememberPlayer.checked) {
        localStorage.setItem('quiz-player-name', playerName);
    } else if (rememberPlayer && !rememberPlayer.checked) {
        localStorage.removeItem('quiz-player-name');
    }
    
    // ซ่อนหน้าล็อกอินและแสดงหน้าเริ่มเกม
    const loginScreen = document.getElementById('login-screen');
    const startScreen = document.getElementById('start-screen');
    const categorySelectionContainer = document.getElementById('category-selection-container');
    
    if (loginScreen) loginScreen.classList.add('hidden');
    if (startScreen) startScreen.classList.remove('hidden');
    if (categorySelectionContainer) categorySelectionContainer.classList.remove('hidden');
    
    // เพิ่มส่วนแสดงชื่อผู้เล่นเข้าไปในกรอบเกมที่มุมขวาบน
    const quizContainer = document.querySelector('.container.quiz-player');
    if (quizContainer && !quizContainer.querySelector('.player-info.top-right')) {
        const playerInfo = document.createElement('div');
        playerInfo.className = 'player-info top-right';
        playerInfo.innerHTML = `
            <div class="player-name">ผู้เล่น: ${currentPlayer.name}</div>
        `;
        quizContainer.appendChild(playerInfo);
    }
    
    // อัพเดตการแสดงผลหน้าต่างๆ
    updateLoginDisplay();
    
    // อัพเดตตัวเลือกหมวดหมู่ในหน้าเล่นเกม
    updatePlayMainCategorySelect();
    
    console.log("ล็อกอินสำเร็จ:", currentPlayer);
}

// ฟังก์ชันแสดงฟอร์มล็อกอินแอดมิน
function showAdminLoginForm() {
    // ลบฟอร์มเก่า (ถ้ามี)
    const existingForm = document.getElementById('admin-login-overlay');
    if (existingForm) {
        existingForm.remove();
    }
    
    // สร้างฟอร์มล็อกอินแอดมิน
    const overlay = document.createElement('div');
    overlay.id = 'admin-login-overlay';
    overlay.className = 'admin-password-overlay';
    
    overlay.innerHTML = `
        <div class="admin-password-modal">
            <div class="admin-password-header">
                <h3>🔐 ล็อกอินแอดมิน</h3>
                <button class="close-btn" onclick="closeAdminLoginForm()">×</button>
            </div>
            <div class="admin-password-body">
                <div style="margin-bottom: 15px;">
                    <label for="admin-email-input">อีเมล:</label>
                    <input type="email" id="admin-email-input" class="admin-password-input" placeholder="admin@yoursite.com">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="admin-password-input">รหัสผ่าน:</label>
                    <input type="password" id="admin-password-input" class="admin-password-input" placeholder="ใส่รหัสผ่านที่นี่">
                </div>
                <div class="admin-password-error" id="admin-login-error" style="display: none;">
                    ❌ อีเมลหรือรหัสผ่านไม่ถูกต้อง
                </div>
            </div>
            <div class="admin-password-actions">
                <button class="admin-password-confirm" onclick="submitAdminLogin()">เข้าสู่ระบบ</button>
                <button class="admin-password-cancel" onclick="closeAdminLoginForm()">ยกเลิก</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // โฟกัสที่ input อีเมล
    setTimeout(() => {
        const emailInput = document.getElementById('admin-email-input');
        if (emailInput) {
            emailInput.focus();
            
            // รองรับการกด Enter
            emailInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('admin-password-input').focus();
                }
            });
            
            document.getElementById('admin-password-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    submitAdminLogin();
                }
            });
        }
    }, 100);
    
    // ป้องกัน scroll
    document.body.style.overflow = 'hidden';
}

// ฟังก์ชันปิดฟอร์มล็อกอินแอดมิน
function closeAdminLoginForm() {
    const overlay = document.getElementById('admin-login-overlay');
    if (overlay) {
        overlay.remove();
    }
    document.body.style.overflow = '';
    
    // ล้างค่าในช่องชื่อผู้เล่น
    const playerNameInput = document.getElementById('player-name');
    if (playerNameInput) {
        playerNameInput.value = '';
    }
}

// ฟังก์ชันส่งข้อมูลล็อกอินแอดมิน
async function submitAdminLogin() {
    const emailInput = document.getElementById('admin-email-input');
    const passwordInput = document.getElementById('admin-password-input');
    const errorDiv = document.getElementById('admin-login-error');
    
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    
    if (!email || !password) {
        alert('กรุณากรอกอีเมลและรหัสผ่าน');
        return;
    }
    
    // แสดง loading
    const confirmBtn = document.querySelector('.admin-password-confirm');
    const originalText = confirmBtn.textContent;
    confirmBtn.textContent = 'กำลังตรวจสอบ...';
    confirmBtn.disabled = true;
    
    // ลองล็อกอิน
    const success = await loginAdmin(email, password);
    
    if (success) {
        // ล็อกอินสำเร็จ
        closeAdminLoginForm();
        
        // ซ่อนหน้าล็อกอินหลัก
        const loginScreen = document.getElementById('login-screen');
        if (loginScreen) loginScreen.classList.add('hidden');
        
        alert('ยินดีต้อนรับสู่ระบบแอดมิน! 👑');
        
    } else {
        // ล็อกอินไม่สำเร็จ
        errorDiv.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
        
        // เขย่า modal
        const modal = document.querySelector('.admin-password-modal');
        if (modal) {
            modal.classList.add('shake');
            setTimeout(() => {
                modal.classList.remove('shake');
            }, 500);
        }
        
        // ซ่อนข้อผิดพลาดหลัง 3 วินาที
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 3000);
    }
    
    // คืนค่าปุ่ม
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
}

// ฟังก์ชันสุ่มไอคอนน่ารักๆ สำหรับผู้เล่น
function getPlayerInitials(name) {
    // รายการไอคอนน่ารักๆ
    const icons = [
        '🎮', '🎯', '🧠', '🎓', '🌟', '🏆', '📚', '😊', 
        '🚀', '🎨', '🔍', '💡', '🎪', '🎭', '🎬', '🎧',
        '🌈', '🦄', '🐱', '🐶', '🦊', '🦁', '🐼', '🐰'
    ];
    
    // ถ้าไม่มีชื่อ ให้ใช้เครื่องหมายคำถาม
    if (!name) return '?';
    
    // สุ่มไอคอนจากชื่อ (ใช้ชื่อเป็น seed ให้ได้ไอคอนเดิมทุกครั้ง)
    let sum = 0;
    for (let i = 0; i < name.length; i++) {
        sum += name.charCodeAt(i);
    }
    
    // ใช้ผลรวมของรหัส ASCII ในชื่อเป็นดัชนีสำหรับเลือกไอคอน
    const index = sum % icons.length;
    return icons[index];
}

// ฟังก์ชันอัพเดตการแสดงผลคำถามในรูปแบบใหม่
function displayQuestionsEnhanced(filtered = false) {
    const questionsContainer = document.getElementById('questions-container');
    const questionCount = document.getElementById('question-count');
    
    // ตรวจสอบว่ามีการเลือกตัวกรองหรือไม่
    const filterMainCategory = document.getElementById('filter-main-category');
    const mainCategoryValue = filterMainCategory ? filterMainCategory.value : '';
    
    // ตรวจสอบว่าเลือก "แสดงคำถามทั้งหมด" หรือไม่
    const showAllQuestions = mainCategoryValue === 'all';
    
    // ตรวจสอบว่ามีการค้นหาหรือไม่
    const searchInput = document.getElementById('search-questions');
    const hasSearch = searchInput && searchInput.value.trim() !== '';
    
    // มีการกรองถ้า filtered=true หรือถ้ามีการเลือกหมวดหมู่หรือค้นหา
    const filterSelected = filtered || showAllQuestions || hasSearch;
    
    if (questionsContainer) {
        questionsContainer.innerHTML = '';
        
        // ถ้าไม่มีคำถาม
        if (questions.length === 0) {
            questionsContainer.innerHTML = `
                <div class="empty-state">
                    <p>ยังไม่มีคำถามที่บันทึกไว้</p>
                    <p>เริ่มสร้างคำถามใหม่เลย!</p>
                </div>
            `;
        } 
        // ถ้าไม่ได้เลือกตัวกรอง (หรือเป็นตัวเลือกเริ่มต้น)
        else if (!filterSelected && mainCategoryValue === '') {
            questionsContainer.innerHTML = `
                <div class="empty-state">
                    <p>กรุณาเลือกหมวดหมู่เพื่อแสดงคำถาม</p>
                    <p>หรือเลือก "แสดงคำถามทั้งหมด" เพื่อดูคำถามทั้งหมด ${questions.length} ข้อ</p>
                </div>
            `;
        }
        // แสดงคำถามตามตัวกรอง
        else {
            questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                let choicesHTML = '<div class="choices">';
                question.choices.forEach(choice => {
                    const isCorrect = choice.id === question.correctAnswer;
                    choicesHTML += `
                        <div class="choice ${isCorrect ? 'correct' : ''}">
                            ${choice.id}: ${choice.text}
                        </div>
                    `;
                });
                choicesHTML += '</div>';
                
                let categoryText = `
                    <div class="question-category">
                        <strong>หมวดหมู่:</strong> 
                        ${question.category?.main || 'ไม่ระบุ'} > 
                        ${question.category?.sub1 || 'ไม่ระบุ'} > 
                        ${question.category?.sub2 || 'ไม่ระบุ'}
                    </div>
                `;
                
                questionCard.innerHTML = `
                    <h3>คำถามที่ ${index + 1}: ${question.text}</h3>
                    ${question.image ? `<img src="${question.image}" class="question-image">` : ''}
                    ${choicesHTML}
                    ${categoryText}
                    <div class="question-actions">
                        <button class="action-btn edit-btn" onclick="editQuestion('${question.id}')">แก้ไข</button>
                        <button class="action-btn delete-btn" onclick="deleteQuestion('${question.id}')">ลบ</button>
                    </div>
                `;
                
                questionsContainer.appendChild(questionCard);
            });
        }
        
        // อัพเดตจำนวนคำถาม
        if (questionCount) {
            questionCount.textContent = questions.length;
        }
    }
}
// เพิ่มฟังก์ชันช่วยแสดงทุกคำถาม
function displayAllQuestions(container) {
    questions.forEach((question, index) => {
        container.appendChild(createQuestionCard(question, index));
    });
}

// เพิ่มฟังก์ชันช่วยแสดงคำถามที่กรองแล้ว
function displayFilteredQuestions(container) {
    questions.forEach((question, index) => {
        container.appendChild(createQuestionCard(question, index));
    });
}

// ฟังก์ชันช่วยสร้างการ์ดคำถาม (แยกออกมาเพื่อลดการทำซ้ำ)
function createQuestionCard(question, index) {
    const questionCard = document.createElement('div');
    questionCard.className = 'question-card';
    
    let choicesHTML = '<div class="choices">';
    question.choices.forEach(choice => {
        const isCorrect = choice.id === question.correctAnswer;
        choicesHTML += `
            <div class="choice ${isCorrect ? 'correct' : ''}">
                ${choice.id}: ${choice.text}
            </div>
        `;
    });
    choicesHTML += '</div>';
    
    let categoryText = `
        <div class="question-category">
            <strong>หมวดหมู่:</strong> 
            ${question.category?.main || 'ไม่ระบุ'} > 
            ${question.category?.sub1 || 'ไม่ระบุ'} > 
            ${question.category?.sub2 || 'ไม่ระบุ'}
        </div>
    `;
    
    questionCard.innerHTML = `
        <h3>คำถามที่ ${index + 1}: ${question.text}</h3>
        ${question.image ? `<img src="${question.image}" class="question-image">` : ''}
        ${choicesHTML}
        ${categoryText}
        <div class="question-actions">
            <button class="action-btn edit-btn" onclick="editQuestion('${question.id}')">แก้ไข</button>
            <button class="action-btn delete-btn" onclick="deleteQuestion('${question.id}')">ลบ</button>
        </div>
    `;
    
    return questionCard;
}

// ฟังก์ชันตั้งค่าระบบค้นหาคำถาม
function setupSearchQuestions() {
    const searchInput = document.getElementById('search-questions');
    if (searchInput) {
        // ล้าง event handler เดิม (ถ้ามี)
        const newSearchInput = searchInput.cloneNode(true);
        if (searchInput.parentNode) {
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        }
        
        // เพิ่ม event handler ใหม่ - ใช้ตัวหน่วงเวลาเพื่อไม่ให้ค้นหาทุกครั้งที่พิมพ์
        let searchTimeout = null;
        newSearchInput.addEventListener('input', function() {
            // ยกเลิกตัวหน่วงเวลาเดิม (ถ้ามี)
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // สร้างตัวหน่วงเวลาใหม่ - ค้นหาหลังจากพิมพ์เสร็จ 300ms
            searchTimeout = setTimeout(() => {
                applyFilters();
                searchTimeout = null;
            }, 300);
        });
    }
}
// เพิ่ม event listener หลังจากที่หน้าเว็บโหลดเสร็จ
document.addEventListener('DOMContentLoaded', function() {
    // ตั้งค่าระบบค้นหา
    setupSearchQuestions();
});

// ฟังก์ชันตั้งค่าตัวกรองหมวดหมู่
function setupCategoryFilter() {
    // อัพเดตโครงสร้าง HTML สำหรับส่วนกรอง
    const questionFilters = document.querySelector('.question-filters');
    if (questionFilters) {
        // เพิ่มส่วนตัวกรองหมวดหมู่
        const categoryFilter = document.createElement('div');
        categoryFilter.className = 'category-filter-container';
        categoryFilter.innerHTML = `
            <div class="filter-group">
                <select id="filter-main-category" class="filter-select">
                    <option value="">ทุกหมวดหมู่หลัก</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-sub-category1" class="filter-select" disabled>
                    <option value="">ทุกหมวดหมู่ย่อย 1</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-sub-category2" class="filter-select" disabled>
                    <option value="">ทุกหมวดหมู่ย่อย 2</option>
                </select>
            </div>
            <button id="reset-filters" class="filter-btn">รีเซ็ตตัวกรอง</button>
        `;
        
        questionFilters.appendChild(categoryFilter);
        
        // เพิ่ม CSS สำหรับตัวกรอง
        const style = document.createElement('style');
        style.textContent = `
            .section-header {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            
            .question-filters {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                margin-top: 10px;
            }
            
            .search-container {
                position: relative;
                flex-grow: 1;
                max-width: 300px;
            }
            
            .search-input {
                width: 100%;
                padding: 10px 35px 10px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            }
            
            .search-input:focus {
                border-color: #1976d2;
                box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
                outline: none;
            }
            
            .search-icon {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #757575;
            }
            
            .category-filter-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 10px;
                width: 100%;
            }
            
            .filter-group {
                position: relative;
                min-width: 150px;
                flex-grow: 1;
            }
            
            .filter-select {
                width: 100%;
                padding: 8px 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                background-color: white;
                cursor: pointer;
                appearance: none;
                transition: all 0.3s ease;
            }
            
            .filter-select:focus {
                border-color: #1976d2;
                box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
                outline: none;
            }
            
            .filter-select:disabled {
                background-color: #f5f5f5;
                color: #757575;
                cursor: not-allowed;
            }
            
            .filter-btn {
                padding: 8px 15px;
                background-color: #f5f5f5;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s ease;
                white-space: nowrap;
                color: #000000;
                font-weight: 500;
            }
            
            .filter-btn:hover {
                background-color: #e0e0e0;
            }
            
            @media (max-width: 768px) {
                .section-header {
                    flex-direction: column;
                    align-items: flex-start;
                }
                
                .question-filters {
                    width: 100%;
                    margin-top: 15px;
                }
                
                .search-container {
                    max-width: 100%;
                    width: 100%;
                }
                
                .category-filter-container {
                    flex-direction: column;
                }
                
                .filter-group {
                    width: 100%;
                }
            }
        `;
        document.head.appendChild(style);
        
        // เพิ่มตัวเลือกหมวดหมู่หลัก
        const filterMainCategory = document.getElementById('filter-main-category');
        const filterSubCategory1 = document.getElementById('filter-sub-category1');
        const filterSubCategory2 = document.getElementById('filter-sub-category2');
        
        // อัพเดตตัวเลือกหมวดหมู่หลัก
        updateFilterMainCategory();
        
        // Event Listeners สำหรับการเปลี่ยนหมวดหมู่ - ส่วนที่มีการเปลี่ยนแปลง
        filterMainCategory.addEventListener('change', function() {
            const mainCategory = this.value;
            
            // รีเซ็ตค่าของ dropdown หมวดย่อย
            filterSubCategory1.value = '';
            filterSubCategory2.value = '';
            
            // รีเซ็ตหมวดหมู่ย่อย
            filterSubCategory1.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 1</option>';
            filterSubCategory2.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
            filterSubCategory2.disabled = true;
            
            if (mainCategory) {
                // อัพเดตตัวเลือกหมวดหมู่ย่อย 1
                updateFilterSubCategory1(mainCategory);
                filterSubCategory1.disabled = false;
            } else {
                filterSubCategory1.disabled = true;
            }
            
            // ใช้ตัวกรองปัจจุบัน - เรียกใช้ฟังก์ชันกรองที่ปรับปรุงแล้ว
            applyFilters();
        });
        
        filterSubCategory1.addEventListener('change', function() {
            const mainCategory = filterMainCategory.value;
            const subCategory1 = this.value;
            
            // รีเซ็ตค่าของ dropdown หมวดย่อย 2
            filterSubCategory2.value = '';
            
            // รีเซ็ตหมวดหมู่ย่อย 2
            filterSubCategory2.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
            
            if (mainCategory && subCategory1) {
                // อัพเดตตัวเลือกหมวดหมู่ย่อย 2
                updateFilterSubCategory2(mainCategory, subCategory1);
                filterSubCategory2.disabled = false;
            } else {
                filterSubCategory2.disabled = true;
            }
            
            // ใช้ตัวกรองปัจจุบัน - เรียกใช้ฟังก์ชันกรองที่ปรับปรุงแล้ว
            applyFilters();
        });
        
        filterSubCategory2.addEventListener('change', function() {
            // ใช้ตัวกรองปัจจุบัน - เรียกใช้ฟังก์ชันกรองที่ปรับปรุงแล้ว
            applyFilters();
        });
        
        // ปุ่มรีเซ็ตตัวกรอง
const resetFiltersBtn = document.getElementById('reset-filters');
if (resetFiltersBtn) {
    resetFiltersBtn.addEventListener('click', function() {
        // รีเซ็ตตัวเลือกทั้งหมด
        filterMainCategory.value = '';
        filterSubCategory1.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 1</option>';
        filterSubCategory2.innerHTML = '<option value="">ทุกหมวดหมู่ย่อย 2</option>';
        filterSubCategory1.disabled = true;
        filterSubCategory2.disabled = true;
        
        // รีเซ็ตการค้นหา
        const searchInput = document.getElementById('search-questions');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // แสดงคำถาม - ส่ง true เพื่อบอกว่าเป็นการรีเซ็ต
        displayQuestions(false, true);
    });
}
    }
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่หลักสำหรับตัวกรอง
function updateFilterMainCategory() {
    const filterMainCategory = document.getElementById('filter-main-category');
    if (filterMainCategory) {
        // ล้างตัวเลือกเดิม
        filterMainCategory.innerHTML = '';
        
        // เพิ่มตัวเลือกเริ่มต้น (placeholder) ที่ไม่แสดงคำถามใดๆ
        const placeholderOption = document.createElement('option');
        placeholderOption.value = "";
        placeholderOption.textContent = "กรุณาเลือกหมวดหมู่";
        placeholderOption.selected = true;
        placeholderOption.disabled = true;
        filterMainCategory.appendChild(placeholderOption);
        
        // เพิ่มตัวเลือก "แสดงคำถามทั้งหมด"
        const allQuestionsOption = document.createElement('option');
        allQuestionsOption.value = "all";
        allQuestionsOption.textContent = "แสดงคำถามทั้งหมด";
        filterMainCategory.appendChild(allQuestionsOption);
        
        // เพิ่มหมวดหมู่หลักที่มีอยู่
        for (const mainCategory in categories) {
            const option = document.createElement('option');
            option.value = mainCategory;
            option.textContent = mainCategory;
            filterMainCategory.appendChild(option);
        }
    }
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่ย่อย 1 สำหรับตัวกรอง
function updateFilterSubCategory1(mainCategory) {
    const filterSubCategory1 = document.getElementById('filter-sub-category1');
    if (filterSubCategory1 && mainCategory) {
        // เก็บตัวเลือกแรกไว้
        const firstOption = filterSubCategory1.options[0];
        filterSubCategory1.innerHTML = '';
        filterSubCategory1.appendChild(firstOption);
        
        // เพิ่มหมวดหมู่ย่อย 1 ที่มีอยู่
        if (categories[mainCategory]) {
            for (const subCategory1 in categories[mainCategory]) {
                const option = document.createElement('option');
                option.value = subCategory1;
                option.textContent = subCategory1;
                filterSubCategory1.appendChild(option);
            }
        }
    }
}

// ฟังก์ชันอัพเดตตัวเลือกหมวดหมู่ย่อย 2 สำหรับตัวกรอง
function updateFilterSubCategory2(mainCategory, subCategory1) {
    const filterSubCategory2 = document.getElementById('filter-sub-category2');
    if (filterSubCategory2 && mainCategory && subCategory1) {
        // เก็บตัวเลือกแรกไว้
        const firstOption = filterSubCategory2.options[0];
        filterSubCategory2.innerHTML = '';
        filterSubCategory2.appendChild(firstOption);
        
        // เพิ่มหมวดหมู่ย่อย 2 ที่มีอยู่
        if (categories[mainCategory] && categories[mainCategory][subCategory1]) {
            for (const subCategory2 of categories[mainCategory][subCategory1]) {
                const option = document.createElement('option');
                option.value = subCategory2;
                option.textContent = subCategory2;
                filterSubCategory2.appendChild(option);
            }
        }
    }
}

// นำไปแทนที่ฟังก์ชัน applyFilters ทั้งหมด
function applyFilters(isReset = false) {
    const searchInput = document.getElementById('search-questions');
    const filterMainCategory = document.getElementById('filter-main-category');
    const filterSubCategory1 = document.getElementById('filter-sub-category1');
    const filterSubCategory2 = document.getElementById('filter-sub-category2');
    
    // ถ้าเป็นการรีเซ็ต ส่งอาเรย์ว่างไปแสดงผล
    if (isReset) {
        displayFilteredQuestions([], true, true);
        return;
    }
    
    // ดึงค่าตัวกรอง
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const mainCategory = filterMainCategory ? filterMainCategory.value : '';
    const subCategory1 = filterSubCategory1 ? filterSubCategory1.value : '';
    const subCategory2 = filterSubCategory2 ? filterSubCategory2.value : '';
    
    // กรองคำถามโดยไม่แก้ไขอาเรย์ questions เดิม
    let filteredQuestions = questions.filter(question => {
        // กรองตามคำค้นหา
        const matchesSearch = searchTerm === '' || 
            question.text.toLowerCase().includes(searchTerm) || 
            question.choices.some(choice => choice.text.toLowerCase().includes(searchTerm)) ||
            (question.category?.main && question.category.main.toLowerCase().includes(searchTerm)) ||
            (question.category?.sub1 && question.category.sub1.toLowerCase().includes(searchTerm)) ||
            (question.category?.sub2 && question.category.sub2.toLowerCase().includes(searchTerm));
        
        // ถ้าเลือก "แสดงคำถามทั้งหมด" ให้แสดงคำถามทั้งหมด
        if (mainCategory === 'all') {
            return matchesSearch; // แสดงทุกคำถามที่ตรงกับคำค้นหา
        }
        
        // ถ้าไม่ได้เลือกหมวดหมู่ (ค่าเริ่มต้น) ไม่แสดงคำถาม
        if (mainCategory === '') {
            return false;
        }
        
        // กรองตามหมวดหมู่
        const matchesMainCategory = question.category?.main && question.category.main === mainCategory;
        const matchesSubCategory1 = subCategory1 === '' || 
            (question.category?.sub1 && question.category.sub1 === subCategory1);
        const matchesSubCategory2 = subCategory2 === '' || 
            (question.category?.sub2 && question.category.sub2 === subCategory2);
        
        return matchesSearch && matchesMainCategory && matchesSubCategory1 && matchesSubCategory2;
    });
    
    // แสดงคำถามที่กรองแล้ว
    displayFilteredQuestions(filteredQuestions, true);
}

// นำไปแทนที่ฟังก์ชัน displayFilteredQuestions ทั้งหมด
function displayFilteredQuestions(filteredQuestions, filtered = true, isReset = false) {
    const questionsContainer = document.getElementById('questions-container');
    const questionCount = document.getElementById('question-count');
    
    if (questionsContainer) {
        questionsContainer.innerHTML = '';
        
        // กรณีรีเซ็ตตัวกรอง
        if (isReset) {
            questionsContainer.innerHTML = `
                <div class="empty-state">
                    <p>กรุณาเลือกหมวดหมู่เพื่อแสดงคำถาม</p>
                    <p>หรือเลือก "แสดงคำถามทั้งหมด" เพื่อดูคำถามทั้งหมด ${questions.length} ข้อ</p>
                </div>
            `;
        }
        // ถ้าไม่มีคำถามหรือไม่มีคำถามที่ตรงตามเงื่อนไข
        else if (filteredQuestions.length === 0) {
            if (filtered) {
                questionsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>ไม่พบคำถามที่ตรงตามเงื่อนไขการค้นหาหรือตัวกรอง</p>
                        <p>กรุณาลองเปลี่ยนคำค้นหาหรือเงื่อนไขตัวกรอง</p>
                    </div>
                `;
            } else {
                questionsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>ยังไม่มีคำถามที่บันทึกไว้</p>
                        <p>เริ่มสร้างคำถามใหม่เลย!</p>
                    </div>
                `;
            }
        } else {
            // แสดงคำถามที่กรองแล้ว
            filteredQuestions.forEach((question, index) => {
                questionsContainer.appendChild(createQuestionCard(question, index));
            });
        }
        
        // อัพเดตจำนวนคำถาม
        if (questionCount) {
            if (isReset) {
                questionCount.textContent = questions.length;
            } else if (filtered && filteredQuestions.length !== questions.length) {
                questionCount.textContent = `${filteredQuestions.length}/${questions.length}`;
            } else {
                questionCount.textContent = questions.length;
            }
        }
    }
}

// ฟังก์ชันสำหรับนับคำถามในแต่ละหมวดหมู่
function countQuestionsInCategory() {
    // สร้าง object สำหรับเก็บจำนวนคำถามในแต่ละหมวดหมู่
    const categoryCount = {};
    
    // วนลูปนับคำถามในแต่ละหมวดหมู่
    questions.forEach(question => {
        if (!question.category) return;
        
        const { main, sub1, sub2 } = question.category;
        
        // สร้าง key สำหรับแต่ละระดับหมวดหมู่
        const mainKey = main;
        const sub1Key = `${main}|${sub1}`;
        const sub2Key = `${main}|${sub1}|${sub2}`;
        
        // นับสำหรับหมวดหมู่หลัก
        if (!categoryCount[mainKey]) categoryCount[mainKey] = 0;
        categoryCount[mainKey]++;
        
        // นับสำหรับหมวดหมู่ย่อย 1
        if (!categoryCount[sub1Key]) categoryCount[sub1Key] = 0;
        categoryCount[sub1Key]++;
        
        // นับสำหรับหมวดหมู่ย่อย 2
        if (!categoryCount[sub2Key]) categoryCount[sub2Key] = 0;
        categoryCount[sub2Key]++;
    });
    
    return categoryCount;
}

// ฟังก์ชันแสดงหมวดหมู่แบบลำดับชั้น
function renderCategoryTree() {
    console.log("กำลังอัพเดตการแสดงผลต้นไม้หมวดหมู่...");
    
    // นับคำถามในแต่ละหมวดหมู่
    const categoryCount = countQuestionsInCategory();
    
    // เลือก container ที่จะแสดงผล
    const container = document.getElementById('category-tree-container');
    if (!container) {
        console.error("ไม่พบ element หมายเลข 'category-tree-container'");
        return;
    }
    
    // ล้างเนื้อหาเดิม
    container.innerHTML = '';
    
    // สร้าง HTML สำหรับหมวดหมู่หลัก
    for (const mainCategory in categories) {
        const mainCount = categoryCount[mainCategory] || 0;
        const mainCategoryDiv = document.createElement('div');
        mainCategoryDiv.className = 'category-item main-category';
        mainCategoryDiv.dataset.category = mainCategory;
        
        mainCategoryDiv.innerHTML = `
            <div class="category-header">
                <span class="toggle-icon">▶</span>
                <span class="category-name">${mainCategory}</span>
                <span class="question-count">(${mainCount})</span>
                <div class="category-actions">
                    <button class="edit-btn small-btn" data-action="edit" data-type="main" data-category="${mainCategory}">แก้ไข</button>
                    <button class="delete-btn small-btn" data-action="delete" data-type="main" data-category="${mainCategory}">ลบ</button>
                </div>
            </div>
            <div class="sub-categories" style="display: none;"></div>
        `;
        
        // เลือก elements ที่สร้างขึ้น
        const header = mainCategoryDiv.querySelector('.category-header');
        const subCategoriesDiv = mainCategoryDiv.querySelector('.sub-categories');
        const toggleIcon = mainCategoryDiv.querySelector('.toggle-icon');
        
        // เพิ่ม event listener สำหรับการคลิกเพื่อขยาย/หุบ
        header.addEventListener('click', function(e) {
            // ไม่ขยาย/หุบถ้าคลิกที่ปุ่มแก้ไขหรือลบ
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
            }
            
            // สลับการแสดงผลของหมวดย่อย
            const isHidden = subCategoriesDiv.style.display === 'none';
            subCategoriesDiv.style.display = isHidden ? 'block' : 'none';
            toggleIcon.textContent = isHidden ? '▼' : '▶';
            
            // โหลดหมวดย่อย 1 ถ้ายังไม่ได้โหลด
            if (isHidden && subCategoriesDiv.children.length === 0) {
                renderSubCategories1(mainCategory, subCategoriesDiv, categoryCount);
            }
        });
        
        // เพิ่ม event listeners สำหรับปุ่มแก้ไขและลบ
        mainCategoryDiv.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // หยุดการกระจายของ event
                
                const action = this.dataset.action;
                const type = this.dataset.type;
                const category = this.dataset.category;
                
                if (action === 'edit') {
                    showEditCategoryForm(type, category);
                } else if (action === 'delete') {
                    confirmDeleteCategory(type, category);
                }
            });
        });
        
        // เพิ่มหมวดหมู่หลักเข้าไปใน container
        container.appendChild(mainCategoryDiv);
    }
    
    // เพิ่มปุ่มสำหรับเพิ่มหมวดหมู่หลักใหม่
    const addCategoryButton = document.createElement('div');
    addCategoryButton.className = 'add-category-btn';
    addCategoryButton.innerHTML = '<button class="add-btn">+ เพิ่มหมวดหมู่หลัก</button>';
    
    // เพิ่ม event listener สำหรับปุ่มเพิ่มหมวดหมู่
    addCategoryButton.querySelector('button').addEventListener('click', function() {
        showAddCategoryForm('main');
    });
    
    container.appendChild(addCategoryButton);
    
    console.log("อัพเดตการแสดงผลต้นไม้หมวดหมู่เรียบร้อยแล้ว");
}

// ฟังก์ชันแสดงหมวดหมู่ย่อย 1
function renderSubCategories1(mainCategory, container, categoryCount) {
    console.log("กำลังแสดงหมวดหมู่ย่อย 1 ของ", mainCategory);
    
    if (!categories[mainCategory]) {
        console.error("ไม่พบหมวดหมู่หลัก:", mainCategory);
        return;
    }
    
    // ล้างเนื้อหาเดิม
    container.innerHTML = '';
    
    // สร้าง HTML สำหรับแต่ละหมวดหมู่ย่อย 1
    for (const subCategory1 in categories[mainCategory]) {
        const sub1Key = `${mainCategory}|${subCategory1}`;
        const sub1Count = categoryCount[sub1Key] || 0;
        
        const subCategory1Div = document.createElement('div');
        subCategory1Div.className = 'category-item sub-category-1';
        subCategory1Div.dataset.category = subCategory1;
        subCategory1Div.dataset.parent = mainCategory;
        
        subCategory1Div.innerHTML = `
            <div class="category-header">
                <span class="toggle-icon">▶</span>
                <span class="category-name">${subCategory1}</span>
                <span class="question-count">(${sub1Count})</span>
                <div class="category-actions">
                    <button class="edit-btn small-btn" data-action="edit" data-type="sub1" data-category="${subCategory1}" data-parent="${mainCategory}">แก้ไข</button>
                    <button class="delete-btn small-btn" data-action="delete" data-type="sub1" data-category="${subCategory1}" data-parent="${mainCategory}">ลบ</button>
                </div>
            </div>
            <div class="sub-categories sub-categories-2" style="display: none;"></div>
        `;
        
        // เลือก elements ที่สร้างขึ้น
        const header = subCategory1Div.querySelector('.category-header');
        const subCategoriesDiv = subCategory1Div.querySelector('.sub-categories-2');
        const toggleIcon = subCategory1Div.querySelector('.toggle-icon');
        
        // เพิ่ม event listener สำหรับการคลิกเพื่อขยาย/หุบ
        header.addEventListener('click', function(e) {
            // ไม่ขยาย/หุบถ้าคลิกที่ปุ่มแก้ไขหรือลบ
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
            }
            
            // สลับการแสดงผลของหมวดย่อย 2
            const isHidden = subCategoriesDiv.style.display === 'none';
            subCategoriesDiv.style.display = isHidden ? 'block' : 'none';
            toggleIcon.textContent = isHidden ? '▼' : '▶';
            
            // โหลดหมวดย่อย 2 ถ้ายังไม่ได้โหลด
            if (isHidden && subCategoriesDiv.children.length === 0) {
                renderSubCategories2(mainCategory, subCategory1, subCategoriesDiv, categoryCount);
            }
        });
        
        // เพิ่ม event listeners สำหรับปุ่มแก้ไขและลบ
        subCategory1Div.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // หยุดการกระจายของ event
                
                const action = this.dataset.action;
                const type = this.dataset.type;
                const category = this.dataset.category;
                const parent = this.dataset.parent;
                
                if (action === 'edit') {
                    showEditCategoryForm(type, category, parent);
                } else if (action === 'delete') {
                    confirmDeleteCategory(type, category, parent);
                }
            });
        });
        
        // เพิ่มหมวดหมู่ย่อย 1 เข้าไปใน container
        container.appendChild(subCategory1Div);
    }
    
    // เพิ่มปุ่มสำหรับเพิ่มหมวดหมู่ย่อย 1 ใหม่
    const addCategoryButton = document.createElement('div');
    addCategoryButton.className = 'add-category-btn';
    addCategoryButton.innerHTML = `<button class="add-btn">+ เพิ่มหมวดหมู่ย่อย 1</button>`;
    
    // เพิ่ม event listener สำหรับปุ่มเพิ่มหมวดหมู่
    addCategoryButton.querySelector('button').addEventListener('click', function() {
        showAddCategoryForm('sub1', mainCategory);
    });
    
    container.appendChild(addCategoryButton);
}
// ฟังก์ชันแสดงหมวดหมู่ย่อย 2
function renderSubCategories2(mainCategory, subCategory1, container, categoryCount) {
    console.log("กำลังแสดงหมวดหมู่ย่อย 2 ของ", mainCategory, ">", subCategory1);
    
    if (!categories[mainCategory] || !categories[mainCategory][subCategory1]) {
        console.error("ไม่พบหมวดหมู่ที่ระบุ:", mainCategory, ">", subCategory1);
        return;
    }
    
    // ล้างเนื้อหาเดิม
    container.innerHTML = '';
    
    // สร้าง HTML สำหรับแต่ละหมวดหมู่ย่อย 2 (ตอนนี้เป็น object แล้ว)
    for (const subCategory2Item of categories[mainCategory][subCategory1]) {
        // subCategory2Item ตอนนี้เป็น {name: "ชื่อ", is_locked: true/false}
        const subCategory2Name = subCategory2Item.name;
        const isLocked = subCategory2Item.is_locked || false;
        
        const sub2Key = `${mainCategory}|${subCategory1}|${subCategory2Name}`;
        const sub2Count = categoryCount[sub2Key] || 0;
        
        const subCategory2Div = document.createElement('div');
        subCategory2Div.className = 'category-item sub-category-2';
        subCategory2Div.dataset.category = subCategory2Name;
        subCategory2Div.dataset.parent = subCategory1;
        subCategory2Div.dataset.grandparent = mainCategory;
        
        // แสดงไอคอนล็อกถ้าถูกล็อก
        const lockIcon = isLocked ? ' 🔒' : ' 🔓';
        
        subCategory2Div.innerHTML = `
            <div class="category-header">
                <span class="category-name">${subCategory2Name}${lockIcon}</span>
                <span class="question-count">(${sub2Count})</span>
                <div class="category-actions">
                    <button class="edit-btn small-btn" data-action="edit" data-type="sub2" data-category="${subCategory2Name}" data-parent="${subCategory1}" data-grandparent="${mainCategory}">แก้ไข</button>
                    <button class="delete-btn small-btn" data-action="delete" data-type="sub2" data-category="${subCategory2Name}" data-parent="${subCategory1}" data-grandparent="${mainCategory}">ลบ</button>
                    <button class="lock-btn small-btn ${isLocked ? 'locked' : 'unlocked'}" data-action="toggle-lock" data-type="sub2" data-category="${subCategory2Name}" data-parent="${subCategory1}" data-grandparent="${mainCategory}" data-locked="${isLocked}">
                        ${isLocked ? 'ปลดล็อก' : 'ล็อก'}
                    </button>
                </div>
            </div>
        `;
        
        // เพิ่ม event listeners สำหรับปุ่มแก้ไข, ลบ และล็อก
        subCategory2Div.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // หยุดการกระจายของ event
                
                const action = this.dataset.action;
                const type = this.dataset.type;
                const category = this.dataset.category;
                const parent = this.dataset.parent;
                const grandparent = this.dataset.grandparent;
                
                if (action === 'edit') {
                    showEditCategoryForm(type, category, grandparent, parent);
                } else if (action === 'delete') {
                    confirmDeleteCategory(type, category, grandparent, parent);
                } else if (action === 'toggle-lock') {
                    const isCurrentlyLocked = this.dataset.locked === 'true';
                    toggleCategoryLock(grandparent, parent, category, !isCurrentlyLocked);
                }
            });
        });
        
        // เพิ่มหมวดหมู่ย่อย 2 เข้าไปใน container
        container.appendChild(subCategory2Div);
    }
    
    // เพิ่มปุ่มสำหรับเพิ่มหมวดหมู่ย่อย 2 ใหม่
    const addCategoryButton = document.createElement('div');
    addCategoryButton.className = 'add-category-btn';
    addCategoryButton.innerHTML = `<button class="add-btn">+ เพิ่มหมวดหมู่ย่อย 2</button>`;
    
    // เพิ่ม event listener สำหรับปุ่มเพิ่มหมวดหมู่
    addCategoryButton.querySelector('button').addEventListener('click', function() {
        showAddCategoryForm('sub2', mainCategory, subCategory1);
    });
    
    container.appendChild(addCategoryButton);
}

// เพิ่มฟังก์ชันสำหรับการเปิด/ปิดล็อกหมวดหมู่
async function toggleCategoryLock(mainCategory, subCategory1, subCategory2, shouldLock) {
    try {
        console.log(`${shouldLock ? 'ล็อก' : 'ปลดล็อก'}หมวดหมู่:`, mainCategory, '>', subCategory1, '>', subCategory2);
        
        // อัพเดตใน Database
        const { error } = await supabaseClient
            .from('categories')
            .update({ is_locked: shouldLock })
            .eq('name', subCategory2)
            .eq('level', 3)
            .eq('parent_name', `${mainCategory} > ${subCategory1}`);
        
        if (error) {
            throw new Error('เกิดข้อผิดพลาด: ' + error.message);
        }
        
        // โหลดข้อมูลใหม่
        await loadCategories();
        
        // อัพเดตการแสดงผล
        renderCategoryTree();
        updateCategoryUI();
        
        console.log(`${shouldLock ? 'ล็อก' : 'ปลดล็อก'}หมวดหมู่เรียบร้อยแล้ว`);
        
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการเปลี่ยนสถานะล็อก:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
    }
}

// ฟังก์ชัน showAddCategoryForm ที่ปรับปรุงใหม่
function showAddCategoryForm(type, parent = null, grandparent = null) {
    // หยุดการกระจายของ event
    if (window.event) {
        window.event.stopPropagation();
    }
    
    console.log("เปิดฟอร์มเพิ่มหมวดหมู่:", type, parent, grandparent);
    
    // สร้างฟอร์มสำหรับเพิ่มหมวดหมู่
    const formContainer = document.getElementById('category-form-container');
    if (!formContainer) {
        console.error("ไม่พบ element หมายเลข 'category-form-container'");
        return;
    }
    
    let inputLabel = '';
    let titleText = '';
    
    switch (type) {
        case 'main':
            inputLabel = 'ชื่อหมวดหมู่หลัก';
            titleText = 'เพิ่มหมวดหมู่หลัก';
            break;
        case 'sub1':
            inputLabel = 'ชื่อหมวดหมู่ย่อย 1';
            titleText = `เพิ่มหมวดหมู่ย่อย 1 (ภายใต้ ${parent})`;
            break;
        case 'sub2':
            inputLabel = 'ชื่อหมวดหมู่ย่อย 2';
            titleText = `เพิ่มหมวดหมู่ย่อย 2 (ภายใต้ ${parent} > ${grandparent})`;
            break;
    }
    
    // ล้างเนื้อหาเดิมของ formContainer
    formContainer.innerHTML = '';
    
    // สร้าง elements แบบปลอดภัยกว่า
    const formBody = document.createElement('div');
    formBody.className = 'form-body';
    
    formBody.innerHTML = `
        <div class="form-header">
            <h3>${titleText}</h3>
            <button type="button" class="close-btn" id="close-category-form">×</button>
        </div>
        <div class="form-group">
            <label for="category-name">${inputLabel}:</label>
            <input type="text" id="category-name" class="form-input" placeholder="กรุณากรอกชื่อหมวดหมู่">
        </div>
        <div class="form-actions">
            <button type="button" class="save-btn" id="save-category-btn">บันทึก</button>
            <button type="button" class="cancel-btn" id="cancel-category-btn">ยกเลิก</button>
        </div>
    `;
    
    formContainer.appendChild(formBody);
    
    // แสดงฟอร์ม
    formContainer.style.display = 'flex';
    
    // เพิ่ม event listeners หลังจากที่ elements ถูกเพิ่มเข้าไปใน DOM
    document.getElementById('close-category-form').onclick = function() {
        closeAddCategoryForm();
    };
    
    document.getElementById('cancel-category-btn').onclick = function() {
        closeAddCategoryForm();
    };
    
    // บันทึกข้อมูลเมื่อคลิกปุ่มบันทึก
    document.getElementById('save-category-btn').onclick = function() {
        addCategory(type, parent, grandparent);
    };
    
    // รองรับการกด Enter ในช่อง input
    document.getElementById('category-name').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            addCategory(type, parent, grandparent);
        }
    });
    
    // โฟกัสที่ input
    setTimeout(() => {
        const input = document.getElementById('category-name');
        if (input) input.focus();
    }, 100);
}

// เพิ่มฟังก์ชันนี้ต่อจากฟังก์ชัน showAddCategoryForm หรือก่อนฟังก์ชัน updateCategory

function showEditCategoryForm(type, category, parent = null, grandparent = null) {
    // หยุดการกระจายของ event
    if (window.event) {
        window.event.stopPropagation();
    }
    
    console.log("เปิดฟอร์มแก้ไขหมวดหมู่:", type, category, parent, grandparent);
    
    // สร้างฟอร์มสำหรับแก้ไขหมวดหมู่
    const formContainer = document.getElementById('category-form-container');
    if (!formContainer) {
        console.error("ไม่พบ element หมายเลข 'category-form-container'");
        return;
    }
    
    let inputLabel = '';
    let titleText = '';
    
    switch (type) {
        case 'main':
            inputLabel = 'ชื่อหมวดหมู่หลัก';
            titleText = `แก้ไขหมวดหมู่หลัก "${category}"`;
            break;
        case 'sub1':
            inputLabel = 'ชื่อหมวดหมู่ย่อย 1';
            titleText = `แก้ไขหมวดหมู่ย่อย 1 "${category}" (ภายใต้ ${parent})`;
            break;
        case 'sub2':
            inputLabel = 'ชื่อหมวดหมู่ย่อย 2';
            titleText = `แก้ไขหมวดหมู่ย่อย 2 "${category}" (ภายใต้ ${parent} > ${grandparent})`;
            break;
    }
    
    // ล้างเนื้อหาเดิมของ formContainer
    formContainer.innerHTML = '';
    
    // สร้าง elements แบบปลอดภัยกว่า
    const formBody = document.createElement('div');
    formBody.className = 'form-body';
    
    formBody.innerHTML = `
        <div class="form-header">
            <h3>${titleText}</h3>
            <button type="button" class="close-btn" id="close-category-form">×</button>
        </div>
        <div class="form-group">
            <label for="category-name">${inputLabel}:</label>
            <input type="text" id="category-name" class="form-input" value="${category}" placeholder="กรุณากรอกชื่อหมวดหมู่">
        </div>
        <div class="form-actions">
            <button type="button" class="save-btn" id="save-category-btn">บันทึก</button>
            <button type="button" class="cancel-btn" id="cancel-category-btn">ยกเลิก</button>
        </div>
    `;
    
    formContainer.appendChild(formBody);
    
    // แสดงฟอร์ม
    formContainer.style.display = 'flex';
    
    // เพิ่ม event listeners หลังจากที่ elements ถูกเพิ่มเข้าไปใน DOM
    document.getElementById('close-category-form').onclick = function() {
        closeAddCategoryForm();
    };
    
    document.getElementById('cancel-category-btn').onclick = function() {
        closeAddCategoryForm();
    };
    
    // บันทึกข้อมูลเมื่อคลิกปุ่มบันทึก
    document.getElementById('save-category-btn').onclick = function() {
        updateCategory(type, category, parent, grandparent);
    };
    
    // รองรับการกด Enter ในช่อง input
    document.getElementById('category-name').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            updateCategory(type, category, parent, grandparent);
        }
    });
    
    // โฟกัสที่ input
    setTimeout(() => {
        const input = document.getElementById('category-name');
        if (input) input.focus();
    }, 100);
}

function closeAddCategoryForm() {
    const formContainer = document.getElementById('category-form-container');
    if (formContainer) {
        formContainer.innerHTML = '';
        formContainer.style.display = 'none';
    }
}
async function updateCategory(type, oldName, mainCategory = null, subCategory1 = null) {
    const newName = document.getElementById('category-name').value.trim();
    
    if (!newName) {
        alert('กรุณากรอกชื่อหมวดหมู่');
        return;
    }
    
    if (oldName === newName) {
        closeAddCategoryForm();
        return;
    }
    
    try {
        switch (type) {
            case 'main':
                // ตรวจสอบว่ามีหมวดหมู่หลักใหม่นี้อยู่แล้วหรือไม่
                const { data: existingMain } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', newName)
                    .eq('level', 1);
                
                if (existingMain && existingMain.length > 0) {
                    alert('มีหมวดหมู่หลักนี้อยู่แล้ว');
                    return;
                }
                
                // อัพเดตหมวดหมู่หลัก
                await supabaseClient
                    .from('categories')
                    .update({ name: newName })
                    .eq('name', oldName)
                    .eq('level', 1);
                
                // อัพเดต parent_name ของหมวดหมู่ย่อย 1
                await supabaseClient
                    .from('categories')
                    .update({ parent_name: newName })
                    .eq('parent_name', oldName)
                    .eq('level', 2);
                
                // อัพเดต parent_name ของหมวดหมู่ย่อย 2
                const { data: sub2Categories } = await supabaseClient
                    .from('categories')
                    .select('*')
                    .like('parent_name', `${oldName} > %`)
                    .eq('level', 3);
                
                if (sub2Categories) {
                    for (const sub2 of sub2Categories) {
                        const newParentName = sub2.parent_name.replace(oldName, newName);
                        await supabaseClient
                            .from('categories')
                            .update({ parent_name: newParentName })
                            .eq('id', sub2.id);
                    }
                }
                
                // อัพเดตคำถาม
                await supabaseClient
                    .from('questions')
                    .update({ category_main: newName })
                    .eq('category_main', oldName);
                break;
                
            case 'sub1':
                // ตรวจสอบว่ามีหมวดหมู่ย่อย 1 ใหม่นี้อยู่แล้วหรือไม่
                const { data: existingSub1 } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', newName)
                    .eq('level', 2)
                    .eq('parent_name', mainCategory);
                
                if (existingSub1 && existingSub1.length > 0) {
                    alert('มีหมวดหมู่ย่อย 1 นี้อยู่แล้ว');
                    return;
                }
                
                // อัพเดตหมวดหมู่ย่อย 1
                await supabaseClient
                    .from('categories')
                    .update({ name: newName })
                    .eq('name', oldName)
                    .eq('level', 2)
                    .eq('parent_name', mainCategory);
                
                // อัพเดต parent_name ของหมวดหมู่ย่อย 2
                const oldParentPath = `${mainCategory} > ${oldName}`;
                const newParentPath = `${mainCategory} > ${newName}`;
                
                await supabaseClient
                    .from('categories')
                    .update({ parent_name: newParentPath })
                    .eq('parent_name', oldParentPath)
                    .eq('level', 3);
                
                // อัพเดตคำถาม
                await supabaseClient
                    .from('questions')
                    .update({ category_sub1: newName })
                    .eq('category_main', mainCategory)
                    .eq('category_sub1', oldName);
                break;
                
            case 'sub2':
                // ตรวจสอบว่ามีหมวดหมู่ย่อย 2 ใหม่นี้อยู่แล้วหรือไม่
                const { data: existingSub2 } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', newName)
                    .eq('level', 3)
                    .eq('parent_name', `${mainCategory} > ${subCategory1}`);
                
                if (existingSub2 && existingSub2.length > 0) {
                    alert('มีหมวดหมู่ย่อย 2 นี้อยู่แล้ว');
                    return;
                }
                
                // อัพเดตหมวดหมู่ย่อย 2
                await supabaseClient
                    .from('categories')
                    .update({ name: newName })
                    .eq('name', oldName)
                    .eq('level', 3)
                    .eq('parent_name', `${mainCategory} > ${subCategory1}`);
                
                // อัพเดตคำถาม
                await supabaseClient
                    .from('questions')
                    .update({ category_sub2: newName })
                    .eq('category_main', mainCategory)
                    .eq('category_sub1', subCategory1)
                    .eq('category_sub2', oldName);
                break;
        }
        
        // โหลดข้อมูลใหม่
        await loadCategories();
        await loadQuestions();
        
        // ปิดฟอร์ม
        closeAddCategoryForm();
        
        // อัพเดตการแสดงผล
        renderCategoryTree();
        updateCategoryUI();
        displayQuestions();
        
        alert('แก้ไขหมวดหมู่เรียบร้อยแล้ว');
        
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการแก้ไขหมวดหมู่:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
    }
}

// นำฟังก์ชันนี้ไปแทนที่ฟังก์ชัน confirmDeleteCategory() เดิมทั้งหมด
function confirmDeleteCategory(type, categoryName, mainCategory = null, subCategory1 = null) {
    // หยุดการ propagation ของ event click เพื่อไม่ให้ไปเรียก toggle
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // นับจำนวนคำถามที่จะได้รับผลกระทบ
    let affectedQuestions = 0;
    
    switch (type) {
        case 'main':
            // นับคำถามที่อยู่ในหมวดหมู่หลักนี้
            affectedQuestions = questions.filter(q => 
                q.category && q.category.main === categoryName
            ).length;
            break;
            
        case 'sub1':
            // นับคำถามที่อยู่ในหมวดหมู่ย่อย 1 นี้
            affectedQuestions = questions.filter(q => 
                q.category && 
                q.category.main === mainCategory && 
                q.category.sub1 === categoryName
            ).length;
            break;
            
        case 'sub2':
            // นับคำถามที่อยู่ในหมวดหมู่ย่อย 2 นี้
            affectedQuestions = questions.filter(q => 
                q.category && 
                q.category.main === mainCategory && 
                q.category.sub1 === subCategory1 && 
                q.category.sub2 === categoryName
            ).length;
            break;
    }
    
    // สร้างหน้าต่างยืนยัน
    const confirmContainer = document.getElementById('category-confirm-container');
    if (!confirmContainer) return;
    
    let title = '';
    let message = '';
    
    switch (type) {
        case 'main':
            title = 'ลบหมวดหมู่หลัก';
            message = `คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่หลัก "${categoryName}"? การลบหมวดหมู่หลักจะลบหมวดหมู่ย่อยทั้งหมดที่อยู่ภายในด้วย`;
            break;
        case 'sub1':
            title = 'ลบหมวดหมู่ย่อย 1';
            message = `คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ย่อย 1 "${categoryName}"? การลบหมวดหมู่ย่อย 1 จะลบหมวดหมู่ย่อย 2 ทั้งหมดที่อยู่ภายในด้วย`;
            break;
        case 'sub2':
            title = 'ลบหมวดหมู่ย่อย 2';
            message = `คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ย่อย 2 "${categoryName}"?`;
            break;
    }
    
    // เพิ่มข้อความเกี่ยวกับคำถามที่จะได้รับผลกระทบ
    if (affectedQuestions > 0) {
        message += `<br><br><strong class="warning-text">คำเตือน:</strong> การลบหมวดหมู่นี้จะส่งผลกระทบต่อคำถามจำนวน ${affectedQuestions} ข้อ ซึ่งคำถามเหล่านี้จะถูกลบไปด้วย`;
    }
    
    confirmContainer.innerHTML = `
    <div class="confirm-dialog">
        <div class="confirm-header">
            <h3>${title}</h3>
            <button class="close-btn" onclick="closeConfirmDeleteDialog()">×</button>
        </div>
        <div class="confirm-body">
            <p>${message}</p>
        </div>
        <div class="confirm-actions">
            <button class="delete-btn" onclick="deleteCategory('${type}', '${categoryName}', '${mainCategory || ''}', '${subCategory1 || ''}')">ยืนยันการลบ</button>
            <button class="cancel-btn" onclick="closeConfirmDeleteDialog()">ยกเลิก</button>
        </div>
    </div>
`;
    
    // แสดงหน้าต่างยืนยัน
    confirmContainer.style.display = 'flex';
}

// เพิ่มฟังก์ชันนี้ต่อท้ายฟังก์ชัน confirmDeleteCategory()
function closeConfirmDeleteDialog() {
    const confirmContainer = document.getElementById('category-confirm-container');
    if (confirmContainer) {
        confirmContainer.innerHTML = '';
        confirmContainer.style.display = 'none';
    }
}

async function deleteCategory(type, categoryName, mainCategory = null, subCategory1 = null) {
    try {
        switch (type) {
            case 'main':
                // ลบหมวดหมู่ย่อยทั้งหมดที่เกี่ยวข้อง
                await supabaseClient
                    .from('categories')
                    .delete()
                    .or(`parent_name.eq.${categoryName},parent_name.like.${categoryName} > %`);
                
                // ลบหมวดหมู่หลัก
                await supabaseClient
                    .from('categories')
                    .delete()
                    .eq('name', categoryName)
                    .eq('level', 1);
                
                // ลบคำถามที่เกี่ยวข้อง
                await supabaseClient
                    .from('questions')
                    .delete()
                    .eq('category_main', categoryName);
                break;
                
            case 'sub1':
                // ลบหมวดหมู่ย่อย 2 ที่เกี่ยวข้อง
                const parentPath = `${mainCategory} > ${categoryName}`;
                await supabaseClient
                    .from('categories')
                    .delete()
                    .eq('level', 3)
                    .eq('parent_name', parentPath);
                
                // ลบหมวดหมู่ย่อย 1
                await supabaseClient
                    .from('categories')
                    .delete()
                    .eq('name', categoryName)
                    .eq('level', 2)
                    .eq('parent_name', mainCategory);
                
                // ลบคำถามที่เกี่ยวข้อง
                await supabaseClient
                    .from('questions')
                    .delete()
                    .eq('category_main', mainCategory)
                    .eq('category_sub1', categoryName);
                break;
                
            case 'sub2':
                // ลบหมวดหมู่ย่อย 2
                await supabaseClient
                    .from('categories')
                    .delete()
                    .eq('name', categoryName)
                    .eq('level', 3)
                    .eq('parent_name', `${mainCategory} > ${subCategory1}`);
                
                // ลบคำถามที่เกี่ยวข้อง
                await supabaseClient
                    .from('questions')
                    .delete()
                    .eq('category_main', mainCategory)
                    .eq('category_sub1', subCategory1)
                    .eq('category_sub2', categoryName);
                break;
        }
        
        // โหลดข้อมูลใหม่
        await loadCategories();
        await loadQuestions();
        
        // ปิดหน้าต่างยืนยัน
        closeConfirmDeleteDialog();
        
        // อัพเดตการแสดงผล
        renderCategoryTree();
        updateCategoryUI();
        displayQuestions();
        
        alert('ลบหมวดหมู่เรียบร้อยแล้ว');
        
        return true;
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการลบหมวดหมู่:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
        return false;
    }
}

// ฟังก์ชันเริ่มต้นระบบหมวดหมู่แบบใหม่
async function initCategorySystemNew() {
    console.log("กำลังเริ่มต้นระบบหมวดหมู่...");

// เพิ่ม CSS เข้าไปในหน้าเว็บ
const styleElement = document.createElement('style');
styleElement.textContent = `
/* CSS สำหรับระบบจัดการหมวดหมู่รูปแบบใหม่ */
.category-management-container {
background: linear-gradient(145deg, #ffffff, #f0f7ff);
border-radius: 16px;
box-shadow: 0 10px 20px rgba(25, 118, 210, 0.1);
padding: 25px;
margin: 30px auto;
border: 1px solid rgba(25, 118, 210, 0.1);
position: relative;
}

.category-tree-container {
margin-top: 20px;
max-height: 600px;
overflow-y: auto;
padding: 10px;
background-color: #ffffff;
border-radius: 8px;
box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
}

.category-item {
margin: 8px 0;
background-color: #f8f9fa;
border-radius: 8px;
transition: all 0.2s ease;
overflow: hidden;
}

.category-header {
padding: 12px 15px;
display: flex;
align-items: center;
cursor: pointer;
position: relative;
}

.category-header:hover {
background-color: #eef5ff;
}

.toggle-icon {
margin-right: 10px;
font-size: 12px;
color: #1976d2;
transition: transform 0.2s ease;
}

.category-name {
flex-grow: 1;
font-weight: 500;
color: #333;
}

.question-count {
margin-left: 5px;
font-size: 14px;
color: #666;
}

.category-actions {
display: flex;
gap: 5px;
margin-left: 10px;
z-index: 5;
}

.small-btn {
font-size: 12px;
padding: 4px 8px;
border-radius: 4px;
background-color: #f0f0f0;
color: #333;
border: none;
cursor: pointer;
transition: all 0.2s ease;
}

.small-btn:hover {
transform: translateY(-2px);
}

.edit-btn.small-btn {
background-color: #1976d2;
color: white;
}

.edit-btn.small-btn:hover {
background-color: #0d5ca0;
}

.delete-btn.small-btn {
background-color: #f44336;
color: white;
}

.delete-btn.small-btn:hover {
background-color: #d32f2f;
}

.sub-categories {
padding-left: 25px;
background-color: #ffffff;
border-left: 2px dashed rgba(25, 118, 210, 0.2);
margin-left: 10px;
}

.sub-categories-2 {
border-left: 2px dashed rgba(76, 175, 80, 0.2);
}

.main-category > .category-header {
background-color: rgba(25, 118, 210, 0.1);
border-left: 3px solid #1976d2;
}

.sub-category-1 > .category-header {
background-color: rgba(25, 118, 210, 0.05);
border-left: 3px solid #42a5f5;
}

.sub-category-2 > .category-header {
background-color: rgba(76, 175, 80, 0.05);
border-left: 3px solid #4caf50;
}

.add-category-btn {
margin: 10px 0;
padding-left: 25px;
}

.add-btn {
background-color: #e8f5e9;
color: #4caf50;
border: 1px dashed #4caf50;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
transition: all 0.2s ease;
}

.add-btn:hover {
background-color: #c8e6c9;
transform: translateY(-2px);
}

/* สไตล์สำหรับฟอร์ม */
#category-form-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.form-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 20px;
background-color: #1976d2;
color: white;
border-radius: 10px 10px 0 0;
}

.form-header h3 {
margin: 0;
font-size: 20px;
font-weight: 500;
}

.form-body {
padding: 20px;
background-color: white;
border-radius: 0 0 10px 10px;
}

.form-group {
margin-bottom: 15px;
}

.form-group label {
display: block;
margin-bottom: 5px;
font-weight: 500;
color: #333;
}

.form-input {
width: 100%;
padding: 10px 12px;
border: 2px solid #e0e0e0;
border-radius: 6px;
font-size: 16px;
transition: all 0.3s ease;
}

.form-input:focus {
border-color: #1976d2;
box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
outline: none;
}

.form-actions {
display: flex;
justify-content: flex-end;
gap: 10px;
margin-top: 20px;
}

.close-btn {
background: none;
border: none;
color: white;
font-size: 24px;
cursor: pointer;
padding: 0 5px;
}

.save-btn {
background-color: #1976d2;
color: white;
border: none;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s ease;
}

.save-btn:hover {
background-color: #1565c0;
}

.cancel-btn {
background-color: #e0e0e0;
color: #333;
border: none;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.2s ease;
}

.cancel-btn:hover {
background-color: #d5d5d5;
}

/* สไตล์สำหรับหน้าต่างยืนยัน */
#category-confirm-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.confirm-dialog {
width: 400px;
background-color: white;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
overflow: hidden;
}

.confirm-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 20px;
background-color: #f44336;
color: white;
}

.confirm-header h3 {
margin: 0;
font-size: 20px;
font-weight: 500;
}

.confirm-body {
padding: 20px;
}

.confirm-body p {
margin: 0;
line-height: 1.5;
}

.confirm-actions {
display: flex;
justify-content: flex-end;
gap: 10px;
padding: 15px 20px;
background-color: #f5f5f5;
}

.warning-text {
color: #f44336;
}

/* การปรับตัวสำหรับอุปกรณ์มือถือ */
@media (max-width: 768px) {
.category-management-container {
padding: 15px;
}

.category-header {
padding: 10px;
}

.confirm-dialog {
width: 90%;
max-width: 400px;
}

.category-actions {
flex-direction: column;
gap: 5px;
}

.form-actions {
flex-direction: column;
}

.save-btn, .cancel-btn {
width: 100%;
}
}
`;
document.head.appendChild(styleElement);
    
    try {
        // โหลดหมวดหมู่จาก Database
        await loadCategories();
        
        // ถ้าไม่มีหมวดหมู่ ให้สร้างตัวอย่าง
        if (Object.keys(categories).length === 0) {
            console.log("ไม่มีหมวดหมู่ กำลังสร้างตัวอย่าง...");
            await createSampleCategories();
            await loadCategories();
        }
        
        // สร้างโครงสร้าง UI
        renderCategoryTree();
        updateCategorySelects();
        
        console.log("ระบบหมวดหมู่พร้อมใช้งานแล้ว");
        
    } catch (error) {
        console.error("เกิดข้อผิดพลาด:", error);
        // ใช้หมวดหมู่เริ่มต้น
        categories = {
            "ความรู้ทั่วไป": {
                "วิทยาศาสตร์": ["ฟิสิกส์"],
                "คณิตศาสตร์": ["พีชคณิต"]
            }
        };
        renderCategoryTree();
        updateCategorySelects();
    }
}

async function createSampleCategories() {
    try {
        const sampleCategories = [
            // หมวดหมู่หลัก
            { name: "ความรู้ทั่วไป", level: 1, parent_name: null },
            { name: "ภาษา", level: 1, parent_name: null },
            
            // หมวดหมู่ย่อย 1
            { name: "วิทยาศาสตร์", level: 2, parent_name: "ความรู้ทั่วไป" },
            { name: "คณิตศาสตร์", level: 2, parent_name: "ความรู้ทั่วไป" },
            { name: "ภาษาอังกฤษ", level: 2, parent_name: "ภาษา" },
            
            // หมวดหมู่ย่อย 2
            { name: "ฟิสิกส์", level: 3, parent_name: "ความรู้ทั่วไป > วิทยาศาสตร์" },
            { name: "เคมี", level: 3, parent_name: "ความรู้ทั่วไป > วิทยาศาสตร์" },
            { name: "พีชคณิต", level: 3, parent_name: "ความรู้ทั่วไป > คณิตศาสตร์" },
            { name: "ไวยากรณ์", level: 3, parent_name: "ภาษา > ภาษาอังกฤษ" }
        ];
        
        const { error } = await supabaseClient
            .from('categories')
            .insert(sampleCategories);
        
        if (error) {
            throw new Error('เกิดข้อผิดพลาด: ' + error.message);
        }
        
        console.log("สร้างหมวดหมู่ตัวอย่างเรียบร้อยแล้ว");
        return true;
        
    } catch (error) {
        console.error("เกิดข้อผิดพลาดในการสร้างหมวดหมู่ตัวอย่าง:", error);
        return false;
    }
}

async function migrateCategoriesFromLocalStorage() {
    try {
        const savedCategories = localStorage.getItem('quiz-categories');
        if (!savedCategories) {
            return false;
        }
        
        const oldCategories = JSON.parse(savedCategories);
        if (Object.keys(oldCategories).length === 0) {
            return false;
        }
        
        console.log('กำลัง migrate ข้อมูลหมวดหมู่...');
        
        const categoriesToInsert = [];
        
        for (const mainCategory in oldCategories) {
            // เพิ่มหมวดหมู่หลัก
            categoriesToInsert.push({
                name: mainCategory,
                level: 1,
                parent_name: null
            });
            
            for (const subCategory1 in oldCategories[mainCategory]) {
                // เพิ่มหมวดหมู่ย่อย 1
                categoriesToInsert.push({
                    name: subCategory1,
                    level: 2,
                    parent_name: mainCategory
                });
                
                for (const subCategory2 of oldCategories[mainCategory][subCategory1]) {
                    // เพิ่มหมวดหมู่ย่อย 2
                    categoriesToInsert.push({
                        name: subCategory2,
                        level: 3,
                        parent_name: `${mainCategory} > ${subCategory1}`
                    });
                }
            }
        }
        
        const { error } = await supabaseClient
            .from('categories')
            .insert(categoriesToInsert);
        
        if (error) {
            throw new Error('เกิดข้อผิดพลาด: ' + error.message);
        }
        
        console.log('Migrate สำเร็จ');
        localStorage.removeItem('quiz-categories');
        
        return true;
        
    } catch (error) {
        console.error('เกิดข้อผิดพลาดในการ migrate:', error);
        return false;
    }
}

// ฟังก์ชันแสดงรายละเอียดการเล่นเกม
function showGameDetails(historyId) {
    console.log("แสดงรายละเอียดการเล่น ID:", historyId);
    
    // หาข้อมูลประวัติ
    const historyEntry = gameHistory.find(entry => entry.id === historyId);
    if (!historyEntry) {
        alert('ไม่พบข้อมูลประวัติการเล่น');
        return;
    }
    
    // ตรวจสอบว่ามีข้อมูลเกมหรือไม่
    if (!historyEntry.gameData || !historyEntry.gameData.questions) {
        alert('ข้อมูลรายละเอียดการเล่นไม่สมบูรณ์ (ประวัติเก่าอาจไม่มีข้อมูลนี้)');
        return;
    }
    
    // สร้าง Modal
    createGameDetailsModal(historyEntry);
}

// ฟังก์ชันสร้าง Modal แสดงรายละเอียด
function createGameDetailsModal(historyEntry) {
    // ลบ Modal เดิม (ถ้ามี)
    const existingModal = document.getElementById('game-details-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // สร้าง Modal ใหม่
    const modal = document.createElement('div');
    modal.id = 'game-details-modal';
    modal.className = 'game-details-modal-overlay';
    
    // สร้างเนื้อหา Modal
    const modalContent = createModalContent(historyEntry);
    modal.appendChild(modalContent);
    
    // เพิ่มลงใน DOM
    document.body.appendChild(modal);
    
    // เพิ่ม event listener สำหรับปิด Modal
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeGameDetailsModal();
        }
    });
    
    // ป้องกัน scroll ของ body
    document.body.style.overflow = 'hidden';
}

// ฟังก์ชันสร้างเนื้อหา Modal
function createModalContent(historyEntry) {
    const { gameData, playerName, score, totalQuestions, percentage, category, playedAt } = historyEntry;
    const { questions, userAnswers, randomOrder } = gameData;
    
    // แปลงวันที่และเวลา (24 ชั่วโมง)
const dateTimeFormatted = formatDateTime24Hour(playedAt);
const formattedDate = dateTimeFormatted.date;
const formattedTime = dateTimeFormatted.time;
    
    // สร้าง container หลัก
    const container = document.createElement('div');
    container.className = 'game-details-modal';
    
    // สร้าง header
    const header = document.createElement('div');
    header.className = 'modal-header';
    header.innerHTML = `
        <div class="modal-title">
            <h2>รายละเอียดการเล่นเกม</h2>
            <button class="modal-close-btn" onclick="closeGameDetailsModal()">×</button>
        </div>
        <div class="player-result-header">
            <div class="player-result-avatar">${getPlayerInitials(playerName)}</div>
            <div class="player-result-info">
                <div class="player-result-name">${playerName}</div>
                <div class="play-datetime">${formattedDate} ${formattedTime}</div>
            </div>
        </div>
    `;
    
    // สร้างส่วนแสดงคะแนน
    const scoreSection = document.createElement('div');
    scoreSection.className = 'modal-score-section';
    scoreSection.innerHTML = `
        <div class="result-score-container">
            <div class="result-score">
                <div class="score-display">
                    <div class="score-value">${score}</div>
                    <div class="score-separator">/</div>
                    <div class="score-max">${totalQuestions}</div>
                </div>
                <div class="score-percent">${percentage}%</div>
            </div>
        </div>
        
        <div class="quiz-stats">
            <div class="stat-item">
                <div class="stat-value correct-value">${score}</div>
                <div class="stat-label">ตอบถูก</div>
            </div>
            <div class="stat-item">
                <div class="stat-value incorrect-value">${totalQuestions - score}</div>
                <div class="stat-label">ตอบผิด</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${totalQuestions}</div>
                <div class="stat-label">คำถามทั้งหมด</div>
            </div>
        </div>
    `;
    
    // สร้างส่วนแสดงหมวดหมู่
    const categorySection = document.createElement('div');
    if (category) {
        categorySection.className = 'category-summary';
        categorySection.innerHTML = `
            <div class="category-title">หมวดหมู่:</div>
            <div class="category-path">${category.main || 'ไม่ระบุ'} > ${category.sub1 || 'ไม่ระบุ'} > ${category.sub2 || 'ไม่ระบุ'}</div>
        `;
    }
    
    // สร้างส่วนทบทวนคำถาม
    const reviewSection = document.createElement('div');
    reviewSection.className = 'modal-review-section';
    reviewSection.innerHTML = '<h3>สรุปคำถามและคำตอบ</h3>';
    
    const questionsList = document.createElement('div');
    questionsList.className = 'question-review-list';
    
    // สร้างรายการคำถาม
    randomOrder.forEach((questionIndex, index) => {
        const question = questions[questionIndex];
        const userAnswer = userAnswers[questionIndex] || '';
        const isCorrect = userAnswer === question.correctAnswer;
        
        const reviewItem = document.createElement('div');
        reviewItem.className = `question-review-item ${isCorrect ? 'correct' : 'incorrect'}`;
        
        let choicesHTML = '';
        question.choices.forEach(choice => {
            const isUserSelected = choice.id === userAnswer;
            const isCorrectAnswer = choice.id === question.correctAnswer;
            
            let className = 'choice-item';
            if (isUserSelected) className += ' user-selected';
            if (isCorrectAnswer) className += ' correct-answer';
            
            let icon = '';
            if (isUserSelected && isCorrectAnswer) {
                icon = '<span class="choice-icon correct-icon">✓</span>';
            } else if (isUserSelected && !isCorrectAnswer) {
                icon = '<span class="choice-icon incorrect-icon">✗</span>';
            } else if (!isUserSelected && isCorrectAnswer) {
                icon = '<span class="choice-icon correct-icon">✓</span>';
            }
            
            choicesHTML += `
                <div class="${className}">
                    <span class="choice-marker">${choice.id}</span>
                    <span class="choice-text">${choice.text}</span>
                    ${icon}
                </div>
            `;
        });
        
        reviewItem.innerHTML = `
            <div class="question-number">
                <span>ข้อที่ ${index + 1}</span>
                <span class="question-status ${isCorrect ? 'status-correct' : 'status-incorrect'}">
                    ${isCorrect ? 'ตอบถูก' : 'ตอบผิด'}
                </span>
            </div>
            <div class="question-text">${question.text}</div>
            ${question.image ? `<img src="${question.image}" class="question-image">` : ''}
            <div class="choice-list">
                ${choicesHTML}
            </div>
        `;
        
        questionsList.appendChild(reviewItem);
    });
    
    reviewSection.appendChild(questionsList);
    
    // รวม elements ทั้งหมด
    container.appendChild(header);
    container.appendChild(scoreSection);
    if (category) container.appendChild(categorySection);
    container.appendChild(reviewSection);
    
    return container;
}

// ฟังก์ชันปิด Modal
function closeGameDetailsModal() {
    const modal = document.getElementById('game-details-modal');
    if (modal) {
        modal.remove();
    }
    
    // คืนค่า scroll ของ body
    document.body.style.overflow = '';
}

// ฟังก์ชันเริ่มต้นระบบแอดมิน - แก้ไขใหม่
function initAdminSystem() {
    console.log("กำลังเริ่มต้นระบบแอดมิน...");
    
    // ตรวจสอบสถานะ authentication เมื่อเริ่มต้น
    supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log("Auth state changed:", event, session?.user?.email);
        
        if (event === 'SIGNED_IN' && session?.user) {
            // ตรวจสอบว่าเป็นแอดมินหรือไม่
            checkIsAdmin(session.user.id).then(adminData => {
                if (adminData) {
                    console.log("ตรวจพบแอดมินที่ล็อกอินอยู่:", adminData);
                    currentUser = session.user;
                    adminProfile = adminData;
                    isAdminMode = true;
                    activateAdminMode();
                }
            });
        } else if (event === 'SIGNED_OUT') {
            if (isAdminMode) {
                console.log("แอดมินออกจากระบบ");
                currentUser = null;
                adminProfile = null;
                isAdminMode = false;
                deactivateAdminMode();
            }
        }
    });
    
    // ซ่อนแท็บแอดมินเป็นค่าเริ่มต้น
    updateAdminTabs();
    
    console.log("ระบบแอดมินพร้อมใช้งานแล้ว");
}

// ฟังก์ชันจัดการการกดปุ่มคีย์บอร์ด (ไม่ใช้แล้ว แต่เก็บไว้เผื่ออนาคต)
function handleAdminKeyInput(event) {
    // ไม่ใช้ F10 แล้ว เปลี่ยนเป็นใช้การกรอกชื่อผู้เล่น
}

// ฟังก์ชันเปิดโหมดแอดมิน - แก้ไขใหม่
function activateAdminMode() {
    console.log("กำลังเปิดโหมดแอดมิน...");
    
    // แสดงแท็บแอดมิน
    updateAdminTabs();
    
    // เพิ่ม Admin UI
    addAdminUI();
        
    console.log("เปิดโหมดแอดมินเรียบร้อยแล้ว");
}

// ฟังก์ชันปิดโหมดแอดมิน - แก้ไขใหม่
function deactivateAdminMode() {
    console.log("กำลังปิดโหมดแอดมิน...");
    
    // ซ่อนแท็บแอดมิน
    updateAdminTabs();
    
    // ลบ Admin UI
    removeAdminUI();
    
    // รีเซ็ตผู้เล่นปัจจุบัน
    currentPlayer = null;
    
    // กลับไปแท็บเล่นเกมและแสดงหน้าล็อกอิน
    const playTab = document.getElementById('play-tab');
    if (playTab && !playTab.classList.contains('active')) {
        playTab.click();
    }
    
    // แสดงหน้าล็อกอินใหม่
    setTimeout(() => {
        updateLoginDisplay();
    }, 100);
    
    console.log("ปิดโหมดแอดมินเรียบร้อยแล้ว");
}

// ฟังก์ชันเพิ่ม Admin UI - ตรวจสอบให้แน่ใจว่ามีฟังก์ชัน
function addAdminUI() {
    // ตรวจสอบว่ามี UI อยู่แล้วหรือไม่
    if (document.getElementById('admin-ui-container')) {
        console.log("Admin UI มีอยู่แล้ว");
        return;
    }
    
    // สร้าง container สำหรับ Admin UI
    const adminContainer = document.createElement('div');
    adminContainer.id = 'admin-ui-container';
    adminContainer.className = 'admin-ui-container';
    
    // สร้าง Admin Mode Badge (แสดงอย่างเดียว)
    const adminBadge = document.createElement('div');
    adminBadge.className = 'admin-mode-indicator';
    adminBadge.innerHTML = '👑 Admin Mode';
    
    // สร้างปุ่มออกจากระบบ (กดได้)
    const logoutBtn = document.createElement('button');
    logoutBtn.className = 'admin-logout-btn';
    logoutBtn.innerHTML = '🚪 ออกจากระบบ';
    logoutBtn.onclick = function() {
        if (confirm('คุณต้องการออกจากระบบแอดมินใช่หรือไม่?')) {
            logoutAdmin();
        }
    };
    
    // รวม elements
    adminContainer.appendChild(adminBadge);
    adminContainer.appendChild(logoutBtn);
    
    // เพิ่มเข้าไปในหน้าเว็บ
    document.body.appendChild(adminContainer);
    
    console.log("เพิ่ม Admin UI เรียบร้อยแล้ว");
}

// ฟังก์ชันลบ Admin UI - ตรวจสอบให้แน่ใจว่ามีฟังก์ชัน
function removeAdminUI() {
    const adminContainer = document.getElementById('admin-ui-container');
    if (adminContainer) {
        adminContainer.remove();
        console.log("ลบ Admin UI เรียบร้อยแล้ว");
    }
}

// ฟังก์ชันอัพเดตการแสดงผลแท็บ - แก้ไขใหม่
function updateAdminTabs() {
    const historyTab = document.getElementById('history-tab');
    const createTab = document.getElementById('create-tab');
    
    if (isAdminMode) {
        // โหมดแอดมิน: แสดงทุกแท็บ
        if (historyTab) {
            historyTab.style.display = 'block';
            console.log("แสดงแท็บประวัติการเล่น");
        }
        if (createTab) {
            createTab.style.display = 'block';
            console.log("แสดงแท็บตั้งค่า");
        }
    } else {
        // โหมดผู้เล่น: ซ่อนแท็บแอดมิน
        if (historyTab) {
            historyTab.style.display = 'none';
            console.log("ซ่อนแท็บประวัติการเล่น");
        }
        if (createTab) {
            createTab.style.display = 'none';
            console.log("ซ่อนแท็บตั้งค่า");
        }
    }
}

// ฟังก์ชันแสดงข้อความแจ้งเตือน - ตรวจสอบให้แน่ใจว่ามีฟังก์ชัน
function showAdminNotification(message) {
    // ลบการแจ้งเตือนเก่า (ถ้ามี)
    const existingNotification = document.getElementById('admin-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // สร้างการแจ้งเตือนใหม่
    const notification = document.createElement('div');
    notification.id = 'admin-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #4caf50, #81c784);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        z-index: 10001;
        animation: slideDown 0.3s ease;
    `;
    notification.textContent = message;
    
    // เพิ่ม CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // เพิ่มเข้าไปในหน้าเว็บ
    document.body.appendChild(notification);
    
    // ซ่อนหลังจาก 3 วินาที
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.style.animation = 'slideDown 0.3s ease reverse';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
    }, 3000);
    
    console.log("แสดงการแจ้งเตือน:", message);
}

function formatDateTime24Hour(dateString) {
    // บังคับให้ข้อมูลเป็น UTC โดยเพิ่ม Z ถ้าไม่มี
    let utcDateString = dateString;
    if (!dateString.endsWith('Z') && !dateString.includes('+')) {
        utcDateString = dateString + 'Z';
    }
    
    // สร้าง Date object (จะแปลง UTC เป็น local time)
    const date = new Date(utcDateString);
    
    if (isNaN(date.getTime())) {
        return { date: 'Invalid Date', time: 'Invalid Time', full: 'Invalid Date' };
    }
    
    // ใช้ getHours(), getMinutes() (จะได้เวลา local ที่ถูกต้อง)
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return {
        date: `${day}/${month}/${year}`,
        time: `${hours}:${minutes}`,
        full: `${day}/${month}/${year} ${hours}:${minutes}`
    };
}
</script>
</body>
</html>
